;1720708

	;include "ports_ngs.a80"
	;include "equ_ngs.a80"

;GSRomBaseL equ #0000
;GSRomBaseH equ #c000

	ORG GSRomBaseL		;clear low ROM
	DEFS #4000,#FF

	ORG GSRomBaseH		;clear high ROM
	DEFS #4000,#FF

	ORG GSRomBaseL

	DI
	JP INIT

;---patched
	DEFB #05		;LOW	(in BCD!)
	DEFB #01		;HIGH	(in BCD!)
;---

ROMCRC	DW #e428		;CRC from original rom, corrupted!?

        ORG GSRomBaseL+#0030
        JP SGEN		;#2030

        ORG GSRomBaseL+#0038

INT8    EX AF,AF'
        PUSH DE
        LD E,A
        LD D,HX
        LD A,(DE)
        INC D
        LD A,(DE)
        INC D
        LD A,(DE)
        INC D
        LD A,(DE)
        INC E
        JR Z,INT8_
        LD A,E
        POP DE
        EX AF,AF'
        EI
        RET
        
INT8_   JP QTDONE

        ORG GSRomBaseL+#0066
NMILP   POP HL
        LD A,L
        OUT (ZXDATWR),A
NMILP2  IN A,(ZXSTAT)
        RLCA
        JR C,NMILP2
        LD A,H
        OUT (ZXDATWR),A
NMILP3  IN A,(ZXSTAT)
        RLCA
        JR C,NMILP3
        JP NMILP

	ORG GSRomBaseL+#0080
	DB "This is improved ROM Version 1.04 Beta. "
	DB "Bugfixes by psb & Evgeny Muchkin, 2007.",0

        ORG GSRomBaseL+#0100
        DEFM "General  Sound (tm)  ROM"
        DEFM "Copyright   1997 Stinger"
        DEFM "Version 1.05a           "

; LOW ROM INCLUDES

;INCLUDE "INIT_L.a80"
INIT    DI
        OUT (CLRCBIT),A
INIT_   XOR A
        OUT (ZXDATWR),A
        LD L,A
        LD H,A
        LD BC,#0004
        LD SP,#0008
        JR INIT02

INIT00  OUT (MPAG),A
        LD SP,#C000
        LD C,#04
        DEC A
INIT01  POP DE
        ADD HL,DE
        POP DE
        ADD HL,DE
        POP DE
        ADD HL,DE
        POP DE
        ADD HL,DE
INIT02  POP DE
        ADD HL,DE
        POP DE
        ADD HL,DE
        POP DE
        ADD HL,DE
        POP DE
        ADD HL,DE
        DJNZ INIT01
        DEC C
        JR NZ,INIT01
        OR A
        JR Z,INIT00
        LD DE,(ROMCRC)
        SBC HL,DE
        LD HL,RAMPG
;---patched
	LD A,2
CREATE_LIST_PAGE
	LD (HL),A
	INC HL
	INC A 
	CP #40
	JR NZ,CREATE_LIST_PAGE
	LD (HL),1
	INC HL
	LD (HL),0
	LD A,#3E
	LD (NUMPG),A
	OUT (3),A
	LD SP,#8000
	JP CONTINUE_INIT
;---
        DB #80
        LD DE,#FFFF
        LD BC,#3FAA
INITR01 LD A,B
        OUT (MPAG),A
        LD (HL),C
        LD (DE),A
        DJNZ INITR01
        XOR A
        OUT (MPAG),A
        EXX
        LD A,D
        LD (#8000),A
        LD A,E
        LD (#FFFF),A
        EXX
        LD A,(#7FFF)
        LD LX,A
        LD A,#C0
        LD (#7FFF),A
        LD HL,#FFFF
        LD DE,RAMPG
        LD B,#3F
INITR02 LD A,#40
        SUB B
        OUT (MPAG),A
        CP (HL)
        JR NZ,INITR05
        LD (DE),A
        LD A,(#8000)
        CP #AA
        JR Z,INITR06
INITR04 XOR A
        LD (HL),A
        LD (#8000),A
INITR05 DJNZ INITR02
        JP INITR0E

INITR06 LD A,#01
        LD (HL),A
INITR07 CP (HL)
        JR NZ,INITR04
        RLC (HL)
        RLCA
        JR NC,INITR07
        LD A,#FE
        LD (HL),A
INITR08 CP (HL)
        JR NZ,INITR04
        RLC (HL)
        RLCA
        JR C,INITR08
        EXX
        LD HL,#8000
        LD C,#AA
INITR09 LD A,C
        XOR H
INITR0A XOR L
        LD (HL),A
        XOR L
        INC L
        XOR L
        LD (HL),A
        XOR L
        INC L
        XOR L
        LD (HL),A
        XOR L
        INC L
        XOR L
        LD (HL),A
        XOR L
        INC L
        JP NZ,INITR0A
        INC H
        JP NZ,INITR09
        LD H,#80
INITR0B LD A,C
        XOR H
        XOR L
        XOR (HL)
        JR NZ,INITR0D
        INC L
        LD A,C
        XOR H
        XOR L
        XOR (HL)
        JR NZ,INITR0D
        INC L
        LD A,C
        XOR H
        XOR L
        XOR (HL)
        JR NZ,INITR0D
        INC L
        LD A,C
        XOR H
        XOR L
        XOR (HL)
        JR NZ,INITR0D
        INC L
        JP NZ,INITR0B
        INC H
        JP NZ,INITR0B
        LD HL,#0000
        LD SP,HL
        LD BC,#0008
INIT0C  PUSH HL
        PUSH HL
        PUSH HL
        PUSH HL
        PUSH HL
        PUSH HL
        PUSH HL
        PUSH HL
        DJNZ INIT0C
        DEC C
        JP NZ,INIT0C
        EXX
        INC E
        EXX
INITR0D EXX
        DEC B
        JP NZ,INITR02
INITR0E LD A,E
        LD (NUMPG),A
        OUT (ZXDATWR),A
        LD A,LX
        LD (DE),A
CONTINUE_INIT
        XOR A
        OUT (MPAG),A
;JP INITVAR
;---patched
        JP Patch5i3
;---

;INCLUDE "COM_L.a80"
COMHZ   OUT (CLRCBIT),A
COMINT  LD SP,ISTACK		;#026B
COMINT_ IN A,(ZXSTAT)
        RRCA
        JR C,COMINT1
        LD A,(PROCESS)		;#0273
        OR A
        JR Z,COMINT_
        LD A,(BUSY)
        OR A
        JR NZ,COMINT_
        IN A,(ZXSTAT)
        RRCA
        JR C,COMINT1
        LD A,#FF
        LD (INGEN),A
        PUSH DE
        CALL ENGINE
        POP DE
        XOR A
        LD (INGEN),A
        JP COMINT_

COMINT1 IN A,(ZXCMD)
        CP #20
        JR C,COMLOW
COMINT2 CP #F0
        JR C,COMHIGH
        SUB #D0
COMLOW  ADD A,A
        LD H,high COMTAB
        LD L,A
        LD A,(HL)
        INC L
        LD H,(HL)
        LD L,A
        JP (HL)

COMHIGH LD HL,COMINT_
        PUSH HL
        LD L,A
        LD H,high COMTABH
        XOR A
        LD (CPAGE),A
        OUT (MPAG),A
        LD A,(HL)
        INC H
        LD H,(HL)
        LD L,A
        JP (HL)

WTDTL   IN A,(ZXSTAT)
        AND #81
        JR Z,WTDTL
        IN A,(ZXDATRD)
        JP P,COMINT1
        JP (IY)

WTDTG   IN A,(ZXSTAT)
        OR A
        JP P,WTDTG
        IN A,(ZXDATRD)
        JP (IY)

	align 256

COMTAB  DEFW COM00,COM01,COM02,COM03,COM04,COM05,COM06,COM07	;0365,036C,0381,0390,039E,03A8,03B8,03D0
        DEFW COM08,COM09,COM0A,COM0B,COM0C,COM0D,COM0E,COM0F	;0360,03F3,0407,041F,0444,046E,0497,04AE
        DEFW COM10,COM11,COM12,COM13,COM14,COM15,COM16,COM17	;0511,0522,052E,0537,0545,0594,05FE,0617
        DEFW COM18,COM19,COM1A,COM1B,COM1C,COM1D,COM1E,COM1F	;062A,063A,0642,064A,0650,0662,0360,0360
        DEFW COMF0,COMF1,COMF2,COMF3,COMF4,COMF5,COMF6,COMF7	;066F,0360,0360,0679,067E,0683,069B,06B0
        DEFW COMF8,COMF9,COMFA,COMFB,COMFC,COMFD,COMFE,COMFF	;0360,0360,06B9,0360,0360,0360,0360,0360

COMZ    OUT (CLRCBIT),A
        JP COMINT_

COM1E   EQU COMZ
COM1F   EQU COMZ

COMF1   EQU COMZ
COMF2   EQU COMZ

COMF8   EQU COMZ
COMF9   EQU COMZ

COMFB   EQU COMZ
COMFC   EQU COMZ
COMFD   EQU COMZ
COMFE   EQU COMZ
COMFF   EQU COMZ

;Reset flags
;Сбрасывает флаги Data bit и Command bit.
COM00   IN A,(ZXDATRD)
        OUT (CLRCBIT),A
        JP COMINT_

;Set silence (*)
;Выводит в ЦАПы всех каналов #80. По сути устанавливает тишину.
COM01   OUT (CLRCBIT),A
        LD A,#80
        LD HL,DAC0
        LD (HL),A
        LD B,(HL)
        INC H
        LD (HL),A
        LD B,(HL)
        INC H
        LD (HL),A
        LD B,(HL)
        INC H
        LD (HL),A
        LD B,(HL)
        JP COMINT_

;Set low volume (*)
;Устанавливает громкостx ЦАПов всех каналов в ноль.
COM02   OUT (CLRCBIT),A
        LD A,#3F
        OUT (VOL1),A
        OUT (VOL2),A
        OUT (VOL3),A
        OUT (VOL4),A
        JP COMINT_

;Set high volume (*)
;Устанавливает громкость ЦАПов всех каналов в максимум.
COM03   OUT (CLRCBIT),A
        XOR A
        OUT (VOL1),A
        OUT (VOL2),A
        OUT (VOL3),A
        OUT (VOL4),A
        JP COMINT_

;Set 'E' 3bits (*)
;Устанавливает в 'E' регистре GS 3 младших бита в соответствии с  задан-
;ным значением (2  младших  бита  в  сущности  являются  номером  канала
;#00-#03).
COM04   IN A,(ZXDATRD)
        OUT (CLRCBIT),A
        AND #07
        LD E,A
        JP COMINT_

;Out volume port (*)
;Устанавливает громкость канала, номер которого содержится в 'E', в ука-
;занное значение. (Команда срабатывает при условии,  что 'E' находится в
;пределах #00-#03)
COM05   IN A,(ZXDATRD)
        OUT (CLRCBIT),A
        LD B,A
        LD A,E
        CP #04
        JP NC,COMINT_
        ADD A,VOL1
        LD C,A
        OUT (C),B
        JP COMINT_

;Send to DAC (*)
;Выводит байт в ЦАП канала, указываемого по 'E'.
COM06   IN A,(ZXDATRD)
        OUT (CLRCBIT),A
        LD B,A
        LD A,E
        CP #04
        JP NC,COMINT_
        ADD A,high DAC0
        LD H,A
        LD L,#00
        LD (HL),B
        LD A,(HL)
        JP COMINT_

;Send to DAC and to volume port (*)
;Выводит байт в ЦАП ('E') с заданной громкостью.
COM07   IN A,(ZXDATRD)
        OUT (CLRCBIT),A
        LD B,A
        LD A,E
        CP #04
        JP NC,COMINT_
        ADD A,high DAC0
        LD H,A
        LD L,#00
        LD (HL),B
        SUB high DAC0
        ADD A,VOL1
        LD C,A
        LD IY,COM07_1
        JP WTDTL

COM07_1 OUT (C),A
        LD A,(HL)
        JP COMINT_

;то же что и команда #00
;Reset flags
;Сбрасывает флаги Data bit и Command bit.
COM08   EQU COMZ

;Sets one's byte volume. (*)
;Установка громкости канала, номер которого задан в 2х старших битах.
COM09   IN A,(ZXDATRD)
        OUT (CLRCBIT),A
        LD B,A
        RLCA
        RLCA
        AND #03
        ADD A,VOL1
        LD C,A
        LD A,B
        AND #3F
        OUT (C),A
        JP COMINT_

;DAC output (*)
;Еще один непосредственный вывод в ЦАП.
COM0A   IN A,(ZXDATRD)
        OUT (CLRCBIT),A
        LD B,A
        LD IY,COM0A_1
        JP WTDTL
        
COM0A_1 AND #03
        ADD A,high DAC0
        LD H,A
        LD L,#00
        LD (HL),B
        LD A,(HL)
        JP COMINT_

;DAC and Volume output (*)
;И наконец последний вывод в ЦАП с установкой громкости.
COM0B   IN A,(ZXDATRD)
        OUT (CLRCBIT),A
        LD C,A
        LD IY,COM0B_1
        JP WTDTL
        
COM0B_1 LD B,A
        RLCA
        RLCA
        AND #03
        ADD A,high DAC0
        LD H,A
        LD L,#00
        LD (HL),C
        SUB high DAC0
        ADD A,VOL1
        LD C,A
        LD A,B
        AND #3F
        OUT (C),A
        LD A,(HL)
        JP COMINT_

;Call SounDrive Covox mode (*)
;Вызывает режим четырехканального Ковокса,  последовательно копирует ре-
;гистр данных по каналам.  Выход из режима  автоматически  после  вывода
;четвертого байта.
COM0C   IN A,(ZXDATRD)
        OUT (CLRCBIT),A
        LD HL,DAC0
        LD (HL),A
        LD A,(HL)
        INC H
        LD IY,COM0C_1
        JP WTDTL
        
COM0C_1 LD (HL),A
        LD A,(HL)
        INC H
        LD IY,COM0C_2
        JP WTDTL
        
COM0C_2 LD (HL),A
        LD A,(HL)
        INC H
        LD IY,COM0C_3
        JP WTDTL
        
COM0C_3 LD (HL),A
        LD A,(HL)
        JP COMINT_

;Call Ultravox mode (*)
;Вызывает режим универсального Ковокса,   последовательно  копирует  ре-
;гистр данных по каналам,  число которых регулируется (1-4).В отличие от
;предыдущего варианта синхронизация не производится.  Выход также произ-
;водится автоматически по записи последнего байта.
COM0D   IN A,(ZXDATRD)
        OUT (CLRCBIT),A
        AND #0F
        JP Z,COMINT_
        RLCA
        RLCA
        RLCA
        RLCA
        LD B,A
        LD HL,DAC0
        LD IY,COM0D_3
        JP COM0D_2
        
COM0D_3 LD (HL),A
        LD A,(HL)
        INC H
        JP COM0D_2
        
COM0D_1 JP Z,COMINT_
        INC H
COM0D_2 SLA B
        JR NC,COM0D_1
        JP WTDTL

;Go to LPT Covox mode
;Переходит в режим одноканального Ковокса,   напрямую  копирует  регистр
;данных в ЦАПы двух (правого и левого) каналов.  Выход из этого режима -
;запись #00 в регистр команд.
COM0E   OUT (CLRCBIT),A
        LD HL,DAC0
        LD BC,DAC2
COM0E_1 IN A,(ZXDATRD)
        LD (HL),A
        LD (BC),A
        LD A,(HL)
        LD A,(BC)
        IN A,(ZXSTAT)
        RRCA
        JP NC,COM0E_1
        JP COMINT_

;Go in Profi Covox mode (*)
;Переходит в режим двухканального Ковокса,   напрямую  копирует  регистр
;данных в ЦАПы одного канала,  а регистр каманд в ЦАПы  второго  канала.
;Выход из этого режима - запись #4Е в регистр данных,  затем  последова-
;тельно #0F и #AA в регистр команд.
COM0F   IN A,(ZXDATRD)
        OUT (CLRCBIT),A
        CP "Y"
        JP NZ,COMINT_
        LD HL,DAC0
        LD DE,DAC2
COM0F_1 IN A,(ZXDATRD)
        LD (HL),A
        IN A,(ZXCMD)
        LD (DE),A
        LD A,(HL)
        LD A,(DE)
        IN A,(ZXSTAT)
        OR A
        JP M,COM0F_1
        LD B,#00
        OUT (CLRCBIT),A
COM0F_2 IN A,(ZXSTAT)
        AND #81
        JR NZ,COM0F_1
        DJNZ COM0F_2
COM0F_3 IN A,(ZXSTAT)
        AND #81
        JR Z,COM0F_3
        CP #80
        JR NZ,COM0F_1
        IN A,(ZXDATRD)
        CP "N"
        JP NZ,COM0F_1
COM0F_4 IN A,(ZXSTAT)
        AND #81
        JR Z,COM0F_4
        CP #01
        JR NZ,COM0F_1
        IN A,(ZXCMD)
        CP #0F
        JP NZ,COM0F_1
        OUT (CLRCBIT),A
COM0F_5 IN A,(ZXSTAT)
        AND #81
        JR Z,COM0F_5
        CP #01
        JR NZ,COM0F_1
        IN A,(ZXCMD)
        CP #AA
        JP NZ,COM0F_1
        OUT (CLRCBIT),A
        JP COMINT_

;Out to any port (*)
;Выводит байт вo внутренний порт GS (#00-#09).
COM10   IN A,(ZXDATRD)
        OUT (CLRCBIT),A
        LD C,A
        LD IY,COM10_1
        JP WTDTL
        
COM10_1 OUT (C),A
        JP COMINT_

;In from any port (*)
;читает байт из внутреннего порта GS (#00-#09).
COM11   IN A,(ZXDATRD)
        LD C,A
        IN A,(C)
        OUT (ZXDATWR),A
        OUT (CLRCBIT),A
        JP COMINT_

;OUT to 0 port (*)
;Выводит байт в порт кофигурации GS (#00).
COM12   IN A,(ZXDATRD)
        OUT (CLRCBIT),A
        OUT (MPAG),A
        JP COMINT_

;Jump to Address (*)
;Передает управление по заданному адресу.
COM13   IN A,(ZXDATRD)
        OUT (CLRCBIT),A
        LD L,A
        LD IY,COM13_1
        JP WTDTL
        
COM13_1 LD H,A
        JP (HL)

;Load memory block (*)
;Загрузка блока кодов по указанному адресу с заданной длиной.
; 70+27*WAIT PER LOOP : 171K,123K,96K PER SECOND MAX
COM14   IN A,(ZXDATRD)
        OUT (CLRCBIT),A
        CPL
        LD C,A
        LD HL,WTDTL
        LD IY,COM14_1
        JP (HL)
        
COM14_1 CPL
        LD B,A
        INC BC
        LD IY,COM14_2
        JP (HL)
        
COM14_2 LD E,A
        LD IY,COM14_3
        JP (HL)
        
COM14_3 LD D,A
        LD A,B
        OR C
        JP Z,COMINT_
        LD LX,B
        LD B,#81
        BIT 0,C
        JR NZ,COM14_7
COM14_6 IN A,(ZXSTAT)
        AND B
        JR Z,COM14_6
        IN A,(ZXDATRD)
        JP P,COMINT1
        LD (DE),A
        INC DE
        INC C
COM14_7 IN A,(ZXSTAT)
        AND B
        JR Z,COM14_7
        IN A,(ZXDATRD)
        JP P,COMINT1
        LD (DE),A
        INC DE
        INC C
        JP NZ,COM14_6
	INC LX
        JP NZ,COM14_6
        JP COMINT_

;Get memory block (*)
;Выгрузка блока кодов по указанному адресу с заданной длиной.
COM15   IN A,(ZXDATRD)	;ошибка-не сбрасывается команд бит
        CPL
        LD C,A
        LD IY,COM15_1
        JP WTDTG
        
COM15_1 CPL
        LD B,A
        INC BC
        LD IY,COM15_2
        JP WTDTG
        
COM15_2 LD E,A
        LD IY,COM15_3
        JP WTDTG
        
COM15_3 LD D,A
        LD A,B
        OR C
        JP Z,COMINT_
        LD LX,B
        LD B,#81
        LD A,(DE)
        INC DE
        OUT (ZXDATWR),A
        OUT (CLRCBIT),A
        LD HL,COM15_4
        INC C
        JP NZ,COM15_4
        INC LX
        JP Z,COMINT_
COM15_4 IN A,(ZXSTAT)
        AND B
        JR Z,COM15_5
        JP P,COMINT1
        IN A,(ZXSTAT)
        AND B
        JR Z,COM15_5
        JP P,COMINT1
        IN A,(ZXSTAT)
        AND B
        JR Z,COM15_5
        JP P,COMINT1
        IN A,(ZXSTAT)
        AND B
        JR Z,COM15_5
        JP P,COMINT1
        JP (HL)

COM15_5 LD A,(DE)
        OUT (ZXDATWR),A
        INC DE
        INC C
        JP NZ,COM15_4
COM15_7 INC LX
        JP NZ,COM15_4
        JP COMINT_

;Poke to address (*)
;Записывает единичный байт по указанному адресу.
COM16   IN A,(ZXDATRD)
        OUT (CLRCBIT),A
        LD B,A
        LD IY,COM16_1
        JP WTDTL
        
COM16_1 LD L,A
        LD IY,COM16_2
        JP WTDTL
        
COM16_2 LD H,A
        LD (HL),B
        JP COMINT_

;Peek from address (*)
;Считывает единичный байт из указанного адреса.
COM17   IN A,(ZXDATRD)
        LD L,A
        LD IY,COM17_1
        JP WTDTL
        
COM17_1 LD H,A
        LD A,(HL)
        OUT (ZXDATWR),A
        OUT (CLRCBIT),A
        JP COMINT_

;Load DE Pair (*)
;Загружает регистовую пару DE (относящуюся к GS,  не путать с  одноимен-
;ной парой Main CPU) указанным словом.
COM18   IN A,(ZXDATRD)
        OUT (CLRCBIT),A
        LD E,A
        LD IY,COM18_1
        JP WTDTL
        
COM18_1 LD D,A
        JP COMINT_

;Poke to (DE) address (*)
;Записывает байт по адресу указанному в DE.
COM19   IN A,(ZXDATRD)
        OUT (CLRCBIT),A
        LD (DE),A
        JP COMINT_

;Peek from (DE) address (*)
;Считывает содержимое адреса, указываемого по DE.
COM1A   LD A,(DE)
        OUT (ZXDATWR),A
        OUT (CLRCBIT),A
        JP COMINT_

;Increment of DE Pair (*)
;Увеличивает пару DE на единичку.
COM1B   OUT (CLRCBIT),A
        INC DE
        JP COMINT_

;Poke to (#20XX) address (*)
;Записывает байт по адресу, старший байт которого равен #20.
COM1C   IN A,(ZXDATRD)
        OUT (CLRCBIT),A
        LD L,A
        LD IY,COM1C_1
        JP WTDTL
        
COM1C_1 LD H,#20
        LD (HL),A
        JP COMINT_

;Peek from (#20XX) address (*)
;читает байт с адреса, старший байт которого равен #20.
COM1D   IN A,(ZXDATRD)
        LD L,A
        LD H,#20
        LD A,(HL)
        OUT (ZXDATWR),A
        OUT (CLRCBIT),A
        JP COMINT_

COMF0   LD A,(ERRCODE)  ; GET STATUS
        OUT (ZXDATWR),A
        OUT (CLRCBIT),A
        JP COMINT_

;Warm restart
;Сбрасывает полностью GS,  но пропускает  этапы  определения  количества
;страниц памяти и их провеки,  что очень сильно ускоряет процесс инициа-
;лизации.
COMF3   OUT (CLRCBIT),A
        JP INITVAR

;Cold restart
;Полный перезапуск GS со всеми проверками. По сути, JP #0000.
COMF4   OUT (CLRCBIT),A
        JP #0000

;Busy on
;Устанавливает флаг занятости в #FF
COMF5   OUT (CLRCBIT),A
        LD A,HX
        AND #80
        JP NZ,COMF5_1
        LD A,#FF
        LD (BUSY),A
        JP COMINT_
        
COMF5_1 OR #40
        LD HX,A
        JP COMINT_

;Busy off
;Устанавливает флаг занятости в #00
COMF6   OUT (CLRCBIT),A
        LD A,HX
        AND #80
        JP NZ,COMF6_1
        XOR A
        LD (BUSY),A
        JP COMINT_
        
COMF6_1 LD HX,A
        JP COMINT_

;Get HX Register (*)
;Получить содержимое регистра HX (GS)
;HX участвует в обработке флага Busy.
COMF7   LD A,HX
        OUT (ZXDATWR),A
        OUT (CLRCBIT),A
        JP COMINT_

;Out zero_to_zero
;Вывод нуля в нулевой (конфигурационный) порт GS.   Делает  приостановку
;звучания музыки до следующего чтения из к.л. порта.
COMFA   OUT (CLRCBIT),A
        XOR A
        LD (CPAGE),A
        OUT (MPAG),A
        JP TCOM

;INCLUDE "MEM_L.a80"
;MEMORY MOVEMENT MODULE - LOW PART

	align 256

LDITAB  DUP #100:DB #ED,#A0:EDUP
        RET C
        LD A,(SYSTEM)
        LD (CPAGE),A
        OUT (MPAG),A
        RET

MLDI    NEG
        ADD A,A
        LD LY,A
        LD A,high LDITAB
        ADC A,#00
        LD HY,A
        LD A,(SDPAGE)
        LD (CPAGE),A
        OUT (MPAG),A
        JP (IY)

TLDI    NEG
        ADD A,A
        LD LY,A
        LD A,high LDITAB
        ADC A,#00
        LD HY,A
        SCF
        JP (IY)

MLDD    NEG
        ADD A,A
        LD LY,A
        LD A,high LDDTAB
        ADC A,#00
        LD HY,A
        LD A,(SDPAGE)
        LD (CPAGE),A
        OUT (MPAG),A
        JP (IY)

	align 256

LDDTAB  DUP #100:DB #ED,#A8:EDUP
        LD A,(SYSTEM)
        LD (CPAGE),A
        OUT (MPAG),A
        RET

;INCLUDE "LOAD_L.a80"

; RET B,DE - OLD CURADR
;#0C09

LOAD    LD B,#81
        LD HL,(CURADR)
        LD A,(CURADR+2)
        SCF
        RL H
        RLA
        RRC H
        LD E,A
        LD D,high RAMPG
LOAD_   LD A,(DE)
        OR A
        JP Z,LOADWT3
        LD (CPAGE),A
        OUT (MPAG),A
        LD A,(NUMPG)
        CP E
        JR NZ,LOADWT
        LD A,H
        CP #C0
        JR C,LOADWT2
        JP LOADWT3

LOADWT  IN A,(ZXSTAT)
        AND B
        JR Z,LOADWT
        RRCA
        IN A,(ZXDATRD)
        JR C,LOADCM
        ADD A,C
        LD (HL),A
        INC L
        JP NZ,LOADWT
        INC H
        JP NZ,LOADWT
        INC E
        LD HL,#8000
        JP LOAD_

LOADCM  IN A,(ZXCMD)
        CP #F3
        JP Z,COMF3
        CP #F4
        JP Z,COMF4
        OUT (CLRCBIT),A
        CP #D2
        JP Z,LOAD3
        JP LOADWT

LOADWT2 IN A,(ZXSTAT)
        AND B
        JR Z,LOADWT2
        RRCA
        IN A,(ZXDATRD)
        JR C,LOADCM2
        LD (HL),A
        INC L
        JP NZ,LOADWT2
        INC H
        BIT 6,H
        JP Z,LOADWT2
LOADWT3 IN A,(ZXSTAT)
        AND B
        JR Z,LOADWT3
        RRCA
        IN A,(ZXDATRD)
        JP NC,LOADWT3
        IN A,(ZXCMD)
        CP #F3
        JP Z,COMF3
        CP #F4
        JP Z,COMF4
        OUT (CLRCBIT),A
        CP #D2
        JR Z,LOAD3
        JP LOADWT3

LOADCM2 IN A,(ZXCMD)
        CP #F3
        JP Z,COMF3
        CP #F4
        JP Z,COMF4
        OUT (CLRCBIT),A
        CP #D2
        JR Z,LOAD3
        JP LOADWT2

LOAD3   LD A,E
        RL H
        SRL A
        RR H
        LD (CURADR),HL
        LD (CURADR+2),A
        LD (MEMBOT),HL
        LD (MEMBOT+2),A
        LD E,A
        XOR A
        LD (CPAGE),A
        OUT (MPAG),A
        LD A,E
        RET

;INCLUDE "PLAY.a80"
PLAYMD  LD A,(RAMPG)		;#0CC9
        OUT (MPAG),A
        LD IY,CHANS
        LD DE,CHANLEN
        LD B,#04
RDLP1   
;---patched
        CALL Patch4
        NOP
;---
        LD (IY+CHCNTH),#00
        LD (IY+CHOLDV),#80
        LD (IY+CHSTAT),#01
        LD (IY+CHLPCNT),#00
        LD (IY+CHPATPS),#00
        LD (IY+CHTRMPS),#00
        LD (IY+CHVIBPS),#00
        LD (IY+CHVOL),#40
        LD (IY+CHMVOL),#40
        LD (IY+CHINS),#00
        LD (IY+CHSMP),#00
        LD (IY+CHPAN),#80
        LD (IY+CHEPAN),#20
        LD (IY+CHEVOL),#40
        LD (IY+CHFADVL),#FF
        LD (IY+CHFADVH),#FF
        ADD IY,DE
        DJNZ RDLP1
        LD LX,#FF
        LD A,(#8000+1080)	;определение сигнатуры заголовка
        CP "M"
        JR Z,TTY1
        CP "4"
        JR Z,TTY1
        CP "F"
        JR Z,TTY1
        LD LX,#00
        JP TTY0
TTY1    LD A,(#8000+1081)
        CP "."
        JR Z,TTY2
        CP "L"
        JR Z,TTY2
        CP "!"
        JR Z,TTY2
        CP "C"
        JR Z,TTY2
        LD LX,#00
        JP TTY0
TTY2    LD A,(#8000+1082)
        CP "K"
        JR Z,TTY0
        CP "T"
        JR Z,TTY0
        CP "H"
        JR Z,TTY0
        LD LX,#00
TTY0    LD A,LX
        LD (MODTP),A
        LD HL,#8000+952
        OR A
;---patched
        LD DE,#0000+1084
        JR NZ,TTY10
        LD DE,#0000+600		;размер заголовка файла
        LD HL,#8000+472		;смещение до таблицы патернов
TTY10   LD B,#80		;сканирование таблицы патернов
        SUB A
FDF2    CP (HL)
        JR NC,FDF
        LD A,(HL)
FDF     INC HL
        DJNZ FDF2
        INC A
        LD (PATTS),A		;количество патернов
        LD L,A
        LD H,B
        ADD HL,HL
        ADD HL,HL		;HL=кол-во патернов*4
        LD A,H
        LD H,L
        LD L,B
        ADD HL,DE
        ADC A,B
        SLI H
        RLA
        RRC H
        LD E,A
        LD (SMPS),HL
        LD (SMPS+2),A
        DS 3
;---
        LD A,LX
        OR A
        LD BC,#8000+950
        JR NZ,TTT11
        LD BC,#8000+470
TTT11   LD A,(BC)
	DEC A
        LD (MTSNGSZ),A
        INC BC
        LD A,(BC)
        LD (MTSNGLP),A
        LD IX,#5400
        LD IY,#8000+20		;начало сэмплов
        LD B,31
        LD C,E
RDLP3   PUSH BC
        LD (IX+SMPBEG),C
        LD (IX+SMPBEG+1),L
        LD (IX+SMPBEG+2),H
        LD A,(IY+28)
        OR A
        JR NZ,LPL
        LD A,(IY+29)
        CP #02
        JP C,NLPL
LPL     PUSH HL
        PUSH BC
        LD L,(IY+27)
        LD H,(IY+26)
        LD E,(IY+23)
        LD D,(IY+22)
        SBC HL,DE
        POP BC
        POP HL
        JP NC,NLPL
        PUSH HL
        PUSH BC
        LD E,(IY+27)
        LD D,(IY+26)
        EX DE,HL
        ADD HL,HL
        EX DE,HL
        LD B,0
        RL B
        SRL C
        RL H
        RRC H
        ADD HL,DE
        LD A,C
        ADC A,B
        LD C,A
        SLI H
        RL C
        RRC H
        LD (IX+SMPLPB),C
        LD (IX+SMPLPB+1),L
        LD (IX+SMPLPB+2),H
        SRL C
        RL H
        RRC H
        LD E,(IY+29)
        LD D,(IY+28)
        EX DE,HL
        ADD HL,HL
        EX DE,HL
        LD B,0
        RL B
        ADD HL,DE
        LD A,C
        ADC A,B
        LD C,A
        SLI H
        RL C
        RRC H
        LD (IX+SMPLPE),C
        LD (IX+SMPLPE+1),L
        LD (IX+SMPLPE+2),H
        POP BC
        POP HL
        LD E,(IY+23)
        LD D,(IY+22)
        EX DE,HL
        ADD HL,HL
        EX DE,HL
        LD B,#00
        RL B
        SRL C
        RL H
        RRC H
        ADD HL,DE
        LD A,C
        ADC A,B
        LD C,A
        SLI H
        RL C
        RRC H
        JP LPL2
        
        LD A,(IX+SMPLPE)
        CP C
        JR C,LPL2
        JR NZ,LPL1
        LD A,(IX+SMPLPE+2)
        CP H
        JR C,LPL2
        JR NZ,LPL1
        LD A,(IX+SMPLPE+1)
        CP L
        JR C,LPL2
LPL1    LD A,(IX+SMPEND)
        LD (IX+SMPLPE),A
        LD A,(IX+SMPEND+1)
        LD (IX+SMPLPE+1),A
        LD A,(IX+SMPEND+2)
        LD (IX+SMPLPE+2),A
        JP LPCNT

LPL2    LD A,(IX+SMPLPE)
        LD (IX+SMPEND),A
        LD A,(IX+SMPLPE+1)
        LD (IX+SMPEND+1),A
        LD A,(IX+SMPLPE+2)
        LD (IX+SMPEND+2),A
        JP LPCNT

NLPL    LD (IX+SMPLPB),#FF
        LD E,(IY+23)
        LD D,(IY+22)
        EX DE,HL
        ADD HL,HL
        EX DE,HL
        LD B,#00
        RL B
        SRL C
        RL H
        RRC H
        ADD HL,DE
        LD A,C
        ADC A,B
        LD C,A
        SLI H
        RL C
        RRC H
RDLP2   LD (IX+SMPEND+1),L
        LD (IX+SMPEND+2),H
        LD (IX+SMPEND),C
LPCNT   LD A,(IY+24)
        ADD A,A
        LD (IX+SMPFT),A
        LD A,(IY+25)
        LD (IX+SMPVOL),A
        LD DE,#0010
        ADD IX,DE
        LD DE,30
        ADD IY,DE
        LD A,C
        POP BC
        LD C,A
        DEC B
        JP NZ,RDLP3
        LD HL,CONVERT
        LD A,(HL)
        OR A
        JR NZ,NOCONV
        LD (HL),#FF
        LD HL,(SMPS)
        LD A,(SMPS+2)
        LD E,A
        LD D,high RAMPG
        LD A,(NUMPG)
        SUB E
        LD B,A
SMPMD2  LD A,(DE)
        OUT (MPAG),A
SMPMD1  LD A,(HL)		;начало ADD A,#80
        ADD A,#80
        LD (HL),A
        INC L
        JP NZ,SMPMD1
        INC H
        JP NZ,SMPMD1
        LD H,#80
        INC E
        DJNZ SMPMD2
        LD A,(DE)
        OUT (MPAG),A
        OR A
        JR Z,SMPMD4
SMPMD3  LD A,(HL)
        ADD A,#80
        LD (HL),A
        INC L
        JP NZ,SMPMD3
        INC H
        BIT 6,H
        JP Z,SMPMD3
SMPMD4
NOCONV  XOR A
        LD (CPAGE),A
        OUT (MPAG),A
        RET

INITPAT LD A,(MTSNGPS)
        LD E,A
        LD D,0
        LD A,(MODTP)
        INC A
        LD HL,#8000+952
        JR Z,TTT13
        LD HL,#8000+472
TTT13   ADD HL,DE
        LD A,(RAMPG)
        OUT (MPAG),A
;---patched
        JP Patch11
;---
        LD E,D
        LD D,A
        LD A,(MODTP)
        INC A
        LD HL,#0000+1084
        JR Z,TTT15
        LD HL,#0000+600
TTT15   XOR A
        LD (CPAGE),A
        OUT (MPAG),A
        ADD HL,DE
        LD DE,#5000
        LD BC,#400
        CALL LDMEM
        XOR A
        OUT (MPAG),A
        RET

;INCLUDE "QUANTUM.a80"

;**************************************************************
;* QUANTUM PROCEDURE                                          *
;**************************************************************

QUANTUM LD A,(FXCHNS)
        CPL
        LD C,A
        LD A,(GSCHNS)
        AND C
        LD C,A
        LD IY,CHANS     ;CHANNELS
        LD A,(MTSTAT)
        AND #C0
        JR NZ,L221
L204    LD A,C
        AND (IY+CHRDR)
        JR Z,L205
        BIT 7,(IY+CHSTAT)
        JR Z,L205
        PUSH BC
        CALL GEN
        POP BC
L205    LD A,LY
        ADD A,#40
        LD LY,A
        JP NC,L204
        JP L221

L221    XOR A
        LD (CPAGE),A
        OUT (MPAG),A
        LD HL,VOLRQTB
        LD A,(QTFREE)
        ADD A,low VOLTAB
        LD E,A
        LD D,high VOLTAB
        LDI
        LDI
        LDI
        LDI
        LD HL,(QTFREE)
        LD B,L
        INC L
        PUSH BC
        PUSH HL
        LD A,(CHANNEL)
        AND #0F
        LD HL,INTTB
        ADD A,A
        ADD A,L
        LD L,A
        LD A,H
        ADC A,#00
        LD H,A
        LD C,(HL)
        INC HL
        LD B,(HL)
        LD A,(CHANNEL)
        AND #0F
        LD HL,INTOFF
        ADD A,L
        LD L,A
        LD A,H
        ADC A,#00
        LD H,A
        LD A,(QTFREE)
        ADD A,#60
        ADD A,(HL)
        POP HL
        LD (HL),A
        INC L
        LD (HL),C
        INC L
        LD (HL),B
        POP BC
        INC L
        RES 5,L
        LD (QTFREE),HL
        LD L,B
        LD A,(SGENOFF)
        LD (HL),A
        LD A,(PLAYING)
        OR A
        JP NZ,L224
        LD (QTBUSY),HL
        CALL QTPLAY
L224    LD A,(SGENOFF)
        NEG
        LD C,A
        LD B,0
        LD A,(MTSTAT)
        AND #C0
        RET NZ
        LD HL,(TCKLEFT)
        OR A
        SBC HL,BC
        JR Z,EFXINT
        LD (TCKLEFT),HL
        RET

EFXINT  LD A,(MODULE)
        OR A
        RET Z
        LD HL,(TICKLEN)
        LD (TCKLEFT),HL
        XOR A
        LD (CPAGE),A
        OUT (MPAG),A
        LD IY,CHANS
        LD B,#04
        LD A,(MTCOUNT)
        INC A
        LD (MTCOUNT),A
        LD HL,MTSPEED
        CP (HL)
        JR C,EFXNONT    ;NO NEW NOTE
        XOR A
        LD (MTCOUNT),A
        LD A,(MTPDT2)
        OR A
        JR Z,EFXGTNT    ;GET NEW NOTE
        CALL EFXNONT
        JP EFXSKIP

EFXNONT LD IY,CHANS
        LD B,#04
EFXNON1 PUSH BC
        LD A,(IY+CHCOM)
        OR (IY+CHPARM)
        JR NZ,EFXNON2
        CALL FXNOP
        JP EFXNON3
        
EFXNON2 CALL FXCHK_
EFXNON3 LD BC,CHANLEN
        ADD IY,BC
        POP BC
        DJNZ EFXNON1
        RET

EFXNOP  LD L,(IY+CHPERL)	;;not used!
        LD H,(IY+CHPERL)	;;bug!
        CALL EFXCNV
        LD (IY+CHFRQL),L
        LD (IY+CHFRQH),H
        RET

EFXGTNT 
;LD IY,CHANS
;---patched
        JP Patch3
        DB #46
;---
        XOR A
        LD (CPAGE),A
        OUT (MPAG),A
        LD (CURCHN),A
COMM1   XOR A
        LD (CPAGE),A
        OUT (MPAG),A
        CALL GETROWS
        LD (IY+CHCOM),B
        LD (IY+CHPARM),C
        LD A,E
        OR A
        JR Z,COMM2
        LD (IY+CHINS),E
        PUSH DE
        PUSH BC
        CALL EFXNEWI
        POP BC
        POP DE
COMM2   LD A,D
        CP #7F
        JP Z,COMM5
        LD A,B
        CP #03
        JP Z,COMM4
        CP #05
        JP Z,COMM4
        CP #0E
        JR NZ,COMM3
        LD A,C
        AND #F0
        CP #50
        JR Z,COMM5_
        LD (IY+CHNOTE),D
        LD (IY+CHREAL),D
        CP #D0
        JR Z,COMM3__
        JP COMM3
        
COMM5_  LD A,C
        AND #0F
        SLA A
        LD (IY+CHFINE),A
COMM3   LD (IY+CHNOTE),D
        LD (IY+CHREAL),D
        CALL GETSMP
COMM3__ LD E,(IY+CHNOTE)
        CALL GETPER
        LD (IY+CHPERL),L
        LD (IY+CHPERH),H
        LD E,(IY+CHNOTE)
        CALL GETFRQ
        LD (IY+CHFRQL),L
        LD (IY+CHFRQH),H
        LD A,(IY+CHCOM)
        CP #09
        JP NZ,COMM5
        LD A,(IY+CHPARM)
        OR A
        JR NZ,FX9_
        LD A,(IY+CHOFFST)
FX9_    LD (IY+CHOFFST),A
        LD H,A
        LD L,#00
        XOR A
        ADC A,A
        EX DE,HL
        LD L,(IY+CHCURL)
        LD H,(IY+CHCURH)
        LD B,(IY+CHCURP)
        RL H
        SRL B
        RR H
        ADD HL,DE
        ADC A,B
        SLI H
        RLA
        RRC H
        LD (IY+CHCURL),L
        LD (IY+CHCURH),H
        LD (IY+CHCURP),A
        CP (IY+CHENDP)
        JP C,COMM5
        JR NZ,COMM3_
        LD A,H
        CP (IY+CHENDH)
        JP C,COMM5
        JR NZ,COMM3_
        LD A,L
        CP (IY+CHENDL)
        JP C,COMM5
COMM3_  RES 7,(IY+CHSTAT)
        JP COMM5

COMM4   LD (IY+CHWNT),D
COMM5   XOR A
        LD (CPAGE),A
        OUT (MPAG),A
        CALL FXCHK
COMM6   LD BC,CHANLEN
        ADD IY,BC
        LD A,(CURCHN)
        INC A
        LD (CURCHN),A
        CP #04
        JP NZ,COMM1
EFXSKIP LD HL,MTPATPS
        INC (HL)
        LD A,(MTPDT)
        OR A
        JR Z,EFXSKP2
        LD (MTPDT2),A
        XOR A
        LD (MTPDT),A
EFXSKP2 LD A,(MTPDT2)
        OR A
        JR Z,EFXSKP3
        DEC A
        LD (MTPDT2),A
        JR Z,EFXSKP3
        DEC (HL)
EFXSKP3 LD A,(MTBRKFL)
        OR A
        JR Z,EFXSKP4
        LD A,(MTBRKPS)
        LD (HL),A
        XOR A
        LD (MTBRKPS),A
        LD (MTBRKFL),A
        JP EFXSKP5
        
EFXSKP4 LD A,(HL)
        OR A
        JR NZ,EFXSKP5
        LD A,(MTPDT2)
        OR A
        JR Z,EFXSKP6
EFXSKP5 LD A,(MTROWS)
        CP (HL)
        JR NC,EFXSKPX
EFXSKP6 LD A,(MTBRKPS)
        LD (MTPATPS),A
        XOR A
        LD (MTBRKPS),A
        LD (MTJMPFL),A
        LD HL,MTSNGPS
        INC (HL)
        JR Z,EFXSKP7
        LD A,(MTSNGSZ)
        CP (HL)
        JP NC,INITPAT
EFXSKP7 LD A,(MTSNGSZ)
        LD HL,MTSNGLP
        CP (HL)
        LD A,#00
        JR C,EFXSKP8
        LD A,(HL)
EFXSKP8 LD (MTSNGPS),A

        LD A,6
	DS 3	;LD (MTSPEED),A
        LD HL,750
        DS 3	;LD (TICKLEN),HL
        DS 3	;LD (TCKLEFT),HL
        ;CALL STOPMOD 

        XOR A
        LD (MTBRKPS),A
        LD (MTJMPFL),A
        LD (MTBRKFL),A
        LD (MTPDT),A
        LD (MTPDT2),A
        JP INITPAT

EFXSKPX LD A,(MTJMPFL)
        OR A
        JP NZ,EFXSKP6
        RET

GETSMP  SET 7,(IY+CHSTAT)
        LD A,(IY+CHINS)
        OR A
        JR Z,GETSMP2
        DEC A
        ADD A,A
        ADD A,A
        ADD A,A
        ADD A,A
        LD E,A
        LD A,#54
        ADC A,#00
        LD D,A
        LD A,(DE)
        LD (IY+CHCURP),A
        INC DE
        LD A,(DE)
        LD (IY+CHCURL),A
        INC DE
        LD A,(DE)
        LD (IY+CHCURH),A
        INC (IY+CHCURL)
        CALL Z,GETSMP3
        INC (IY+CHCURL)
        CALL Z,GETSMP3
        INC DE
        LD A,(DE)
        LD (IY+CHENDP),A
        INC DE
        LD A,(DE)
        LD (IY+CHENDL),A
        INC DE
        LD A,(DE)
        LD (IY+CHENDH),A
        INC DE
        INC DE
        INC DE
        LD A,(DE)
        LD (IY+CHLPBP),A
        INC DE
        LD A,(DE)
        LD (IY+CHLPBL),A
        INC DE
        LD A,(DE)
        LD (IY+CHLPBH),A
        INC DE
        LD A,(DE)
        LD (IY+CHLPEP),A
        INC DE
        LD A,(DE)
        LD (IY+CHLPEL),A
        INC DE
        LD A,(DE)
        LD (IY+CHLPEH),A
        LD (IY+CHCNTL),#00
        LD (IY+CHCNTH),#07
        LD A,(IY+CHCURP)
        CP (IY+CHENDP)
        RET C
        JP NZ,GETSMP2
        LD A,(IY+CHCURH)
        CP (IY+CHENDH)
        RET C
        JP NZ,GETSMP2
        LD A,(IY+CHCURL)
        CP (IY+CHENDL)
        RET C
GETSMP2 RES 7,(IY+CHSTAT)
        RET
GETSMP3 INC (IY+CHCURH)
        RET NZ
        LD (IY+CHCURH),#80
        INC (IY+CHCURP)
        RET

EFXNEWI LD A,(IY+CHINS)
        DEC A
        ADD A,A
        ADD A,A
        ADD A,A
        ADD A,A
        LD E,A
        LD A,#54
        ADC A,#00
        LD D,A
        INC DE
        INC DE
        INC DE
        INC DE
        INC DE
        INC DE
        LD A,(DE)
        LD (IY+CHFINE),A
        INC DE
        LD A,(DE)
        CP #40
        JR C,GETSMP1
        LD A,#40
GETSMP1 LD (IY+CHVOL),A
        CP (IY+CHMVOL)
        LD (IY+CHMVOL),A
        RET Z
        SET 0,(IY+CHSTAT)
        RET

GETROWS LD A,(MTPATPS)
        AND #3F
        ADD A,A
        ADD A,A
        LD L,A
        LD H,#00
        ADD HL,HL
        ADD HL,HL
        LD A,(CURCHN)
        ADD A,A
        ADD A,A
        ADD A,L
        LD L,A
        LD A,H
        ADC A,#50
        LD H,A
        LD A,(HL)
        AND #10
        PUSH AF
        LD A,(HL)
        AND #0F
        LD D,A
        INC HL
        LD E,(HL)
        OR E
        LD A,#7F
        JR Z,GETRWS2
        PUSH HL
        CALL NOTEID
        POP HL
GETRWS2 INC HL
        POP BC
        LD D,A
        LD A,(HL)
        AND #F0
        RRCA
        RRCA
        RRCA
        RRCA
        OR B
        LD E,A
        LD A,(HL)
        AND #0F
        LD B,A
        INC HL
        LD C,(HL)
        RET

;INCLUDE "INTTST.a80"
;***********************************************************
;* INTERRUPT HANDLING PROCEDURES                           *
;***********************************************************

	align 256

INTZ    RET

INT0    EX AF,AF'
        INC A
        JR Z,INT0_
        EX AF,AF'
        EI
        RET
        DEFS 11
        RET
        
INT0_   PUSH DE
        JP QTDONE

INT1    EX AF,AF'
        PUSH DE
        LD E,A
        LD D,HX
        LD A,(DE)
        INC E
        JR Z,INT1_
        LD A,E
        POP DE
        EX AF,AF'
        EI
        RET
        DEFS 4
        RET
        
        PUSH DE
INT1_   JP QTDONE

INT2    EX AF,AF'
        PUSH DE
        LD E,A
        LD D,HX
        LD A,(DE)
        INC D
        LD A,(DE)
        INC E
        JR Z,INT2_
        LD A,E
        POP DE
        EX AF,AF'
        EI
        RET
        
        DEFS 2
        RET
        
        PUSH DE
INT2_   JP QTDONE

INT3    EX AF,AF'
        PUSH DE
        LD E,A
        LD D,HX
        LD A,(DE)
        INC D
        INC D
        LD A,(DE)
        INC E
        JR Z,INT3_
        LD A,E
        POP DE
        EX AF,AF'
        EI
        RET
        
        DEFS 1
        RET
        
        PUSH DE
INT3_   JP QTDONE

INT4    EX AF,AF'
        PUSH DE
        LD E,A
        LD D,HX
        LD A,(DE)
        INC D
        LD A,(DE)
        INC D
        LD A,(DE)
        INC E
        JR Z,INT4_
        LD A,E
        POP DE
        EX AF,AF'
        EI
        RET
        
        RET
        
        PUSH DE
INT4_   JP QTDONE

INT5    EX AF,AF'
        PUSH DE
        LD E,A
        LD D,HX
        LD A,(DE)
        INC D
        INC D
        INC D
        LD A,(DE)
        INC E
        JR Z,INT5_
        LD A,E
        POP DE
        EX AF,AF'
        EI
        RET
        
        RET
        
        PUSH DE
INT5_   JP QTDONE

INT6    EX AF,AF'
        PUSH DE
        LD E,A
        LD D,HX
        LD A,(DE)
        INC D
        LD A,(DE)
        INC D
        INC D
        LD A,(DE)
        INC E
        JR Z,INT6_
        LD A,E
        POP DE
        EX AF,AF'
        EI
        RET
        
        PUSH DE
INT6_   JP QTDONE

INT7    EX AF,AF'
        PUSH DE
        LD E,A
        LD D,HX
        LD A,(DE)
        INC D
        INC D
        LD A,(DE)
        INC D
        LD A,(DE)
        INC E
        JR Z,INT7_
        LD A,E
        POP DE
        EX AF,AF'
        EI
        RET
        
        PUSH DE
INT7_   JP QTDONE

QTFAULT LD DE,(QTBUSY)
        LD (DE),A
        LD (PLAYING),A
        POP DE
        EX AF,AF'
        RET

INT_IM1 IM 1
        EI
        EX DE,HL
        LD HL,(QTBUSY)
        LD (HL),A
        LD A,L
        ADD A,#04
        AND #1C
        LD L,A
        LD (QTBUSY),HL
        SET 5,L
        LD A,(HL)
        OUT (VOL1),A
        INC L
        LD A,(HL)
        OUT (VOL2),A
        INC L
        LD A,(HL)
        OUT (VOL3),A
        INC L
        LD A,(HL)
        OUT (VOL4),A
        POP AF
        POP HL
        EX DE,HL
        RET

QTDONE  LD A,(QTBUSY)
        ADD A,#04
        AND #1C
        LD E,A
        LD D,high QTMAP
        LD A,(DE)
        OR A
        JR Z,QTFAULT
        EX AF,AF'
        PUSH AF
        INC E
        LD A,(DE)
        LD HX,A
        INC E
        LD A,(DE)
        OR A
        JR Z,INT_IM1
        IM 2
        EX DE,HL
        LD HL,INTAREA+#18
        CP (HL)
        JR Z,INT_I1
        LD (HL),A
        LD HL,#1518
        LD (INTAREA),HL
        EI
        DEC A
        JR Z,INT_I0
        ADD A,#03
        LD L,A
        LD H,high INT0
        PUSH DE
        PUSH BC
        LD DE,INTAREA+2
        LDI
        LDI
        LDI
        LDI
        LDI
        LDI
        LDI
        LDI
        LDI
        LDI
        LDI
        LDI
        LDI
        LDI
        LDI
        LDI
        LD HL,#D508
        LD (INTAREA),HL
        POP BC
        POP DE
        LD HL,(QTBUSY)
        LD (HL),#00
        LD A,L
        ADD A,#04
        AND #1C
        LD L,A
        LD (QTBUSY),HL
        SET 5,L
        LD A,(HL)
        OUT (VOL1),A
        INC L
        LD A,(HL)
        OUT (VOL2),A
        INC L
        LD A,(HL)
        OUT (VOL3),A
        INC L
        LD A,(HL)
        OUT (VOL4),A
        POP AF
        POP HL
        EX DE,HL
        RET

INT_I1  EI
        LD A,#04
        LD HL,(QTBUSY)
        LD (HL),#00
        ADD A,L
        AND #1C
        LD L,A
        LD (QTBUSY),HL
        SET 5,L
        LD A,(HL)
        OUT (VOL1),A
        INC L
        LD A,(HL)
        OUT (VOL2),A
        INC L
        LD A,(HL)
        OUT (VOL3),A
        INC L
        LD A,(HL)
        OUT (VOL4),A
        POP AF
        POP HL
        EX DE,HL
        RET

INT_I0  LD HL,INT0+2
        PUSH DE
        PUSH BC
        LD DE,INTAREA+2
        LDI
        LDI
        LDI
        LDI
        LDI
        LD HL,#3C08
        LD (INTAREA),HL
        POP BC
        POP DE
        LD HL,(QTBUSY)
        LD (HL),A
        LD A,L
        ADD A,#04
        AND #1C
        LD L,A
        LD (QTBUSY),HL
        SET 5,L
        LD A,(HL)
        OUT (VOL1),A
        INC L
        LD A,(HL)
        OUT (VOL2),A
        INC L
        LD A,(HL)
        OUT (VOL3),A
        INC L
        LD A,(HL)
        OUT (VOL4),A
        POP AF
        POP HL
        EX DE,HL
        RET

QTPLAY  DI
        LD A,#FF
        LD (PLAYING),A
        LD HL,(QTBUSY)
        LD A,(HL)
        EX AF,AF'
        INC L
        LD A,(HL)
        LD HX,A
        INC L
        LD A,(HL)
        IM 1
        OR A
        JR Z,QTPLAY_
        IM 2
        LD HL,INTAREA+#18
        CP (HL)
        JR Z,QTPLAY_
        LD (HL),A
        LD L,A
        LD H,high INT0
        LD DE,INTAREA
        LD BC,#0012
        LDIR
QTPLAY_ LD HL,(QTBUSY)
        SET 5,L
        LD A,(HL)
        OUT (VOL1),A
        INC L
        LD A,(HL)
        OUT (VOL2),A
        INC L
        LD A,(HL)
        OUT (VOL3),A
        INC L
        LD A,(HL)
        OUT (VOL4),A
        EI
        RET

;INCLUDE "COMM.a80"
WTCM    IN A,(ZXSTAT)
        RRCA
        JR NC,WTCM
        IN A,(ZXCMD)
        CP #12
        JR Z,CM12
        CP #18
        JR Z,CM18
        CP #1A
        JR Z,CM1A
        CP #1B
        JR Z,CM1B
        CP #20
        JR Z,CM20
        OUT (CLRCBIT),A
        JP WTCM
        
CM12    IN A,(ZXDATRD)
        OUT (CLRCBIT),A
        OUT (MPAG),A
        JP WTCM
        
CM18    IN A,(ZXDATRD)
        LD E,A
        OUT (CLRCBIT),A
CM18_1  IN A,(ZXSTAT)
        OR A
        JP P,CM18_1
        IN A,(ZXDATRD)
        LD D,A
        JP WTCM
        
CM1A    LD A,(DE)
        OUT (ZXDATWR),A
        OUT (CLRCBIT),A
        JP WTCM
        
CM1B    INC DE
        OUT (CLRCBIT),A
        JP WTCM
        
CM20    OUT (CLRCBIT),A
        RET

;INCLUDE "GEN_L.a80"
GEN     LD A,(QTFREE)
        ADD A,high DAC0
        ADD A,(IY+CHRDN)
        LD D,A
        LD A,(SGENOFF)
        LD E,A
        LD A,(CHANNEL)
        OR (IY+CHRDR)
        LD (CHANNEL),A
GEN_    LD L,(IY+CHCURL)
        LD H,(IY+CHCURH)
        LD B,(IY+CHCNTL)
GENLP   EXX
        LD H,high RAMPG
        LD L,(IY+CHCURP)
        LD D,(IY+CHCNTH)
        LD E,(IY+CHFRQH)
        LD B,(HL)
        LD A,B
        LD (CPAGE),A
        OUT (MPAG),A
        LD A,L
        EXX
        CP (IY+CHENDP)
        JP C,GENTP
        PUSH DE
        EX DE,HL
        LD L,(IY+CHENDL)
        LD H,(IY+CHENDH)
        DEC HL
        SBC HL,DE
        INC HL
        EX DE,HL
        LD LX,E
        LD A,D
        POP DE
        JR C,GENCHK
        OR A
        JR Z,GENENT
        LD LX,#FF
        JP GENENT

GENCHK  RES 7,(IY+CHSTAT)
        LD A,(IY+CHLPBP)
        INC A
        JP Z,GENCHK2
        DEC A
        LD (IY+CHCURP),A
        LD L,(IY+CHLPBL)
        LD H,(IY+CHLPBH)
        LD A,(IY+CHLPEP)
        LD (IY+CHENDP),A
        LD A,(IY+CHLPEL)
        LD (IY+CHENDL),A
        LD A,(IY+CHLPEH)
        LD (IY+CHENDH),A
        SET 7,(IY+CHSTAT)
        JP GENLP

GENCHK2 LD (IY+CHREAL),#7F
        BIT 6,(IY+CHSTAT)
        JP Z,GENZERO
        PUSH IY
        PUSH DE
        LD IY,CHANS
        LD B,#08
        LD DE,CHANLEN
GENCHK3 SET 0,(IY+CHSTAT)
        ADD IY,DE
        DJNZ GENCHK3
        POP DE
        POP IY
        JP GENZERO

GENTP   LD LX,#FF
        LD A,H
        INC A
        JP M,GENENT
        OR L
        JR Z,GENENT
        NEG
        LD LX,A
GENENT  LD C,(IY+CHFRQL)
        LD A,(IY+CHOLDV)
        PUSH IY
        CALL #2030
        POP  IY
        LD (IY+CHOLDV),A
        LD (IY+CHCNTH),C
        LD A,H
        OR A
        JP M,GENJ2
        LD H,#80
        INC (IY+CHCURP)
GENJ2   LD A,E
        OR A
        JP Z,GENRET
        BIT 7,(IY+CHSTAT)
        JP NZ,GENLP
        JP GENZERO

GENRET  LD (IY+CHCURL),L
        LD (IY+CHCURH),H
        LD (IY+CHCNTL),B
        JP  GENEXT

GENZERO LD A,E
        CP #FF
        JR NC,GENZENT
        LD B,(IY+CHOLDV)
        LD C,#80
        CP #FD
        JR NC,GENZ_1
        CP #F9
        JR NC,GENZ_2
        LD A,C
        ADD A,B
        RRA
        LD H,A
        ADD A,B
        RRA
        LD L,A
        ADD A,B
        RRA
        LD (DE),A
        INC E
        LD A,L
        LD (DE),A
        INC E
        ADD A,H
        RRA
        LD (DE),A
        INC E
        LD A,H
        LD (DE),A
        INC E
        ADD A,C
        RRA
        LD L,A
        ADD A,H
        RRA
        LD (DE),A
        INC E
        LD A,L
        LD (DE),A
        INC E
        ADD A,C
        RRA
        LD (DE),A
        INC E
        JP GENZENT

GENZ_2  LD A,C
        ADD A,B
        RRA
        LD H,A
        ADD A,B
        RRA
        LD (DE),A
        INC E
        LD A,H
        LD (DE),A
        INC E
        ADD A,C
        RRA
        LD (DE),A
        INC E
        JP GENZENT

GENZ_1  LD A,B
        ADD A,C
        RRA
        LD (DE),A
        INC E
GENZENT LD A,#80
        BIT 0,E
        JR Z,GENZJP1
        LD (DE),A
        INC E
        JR Z,GENZEXT
GENZJP1 BIT 1,E
        JR Z,GENZJP2
        LD (DE),A
        INC E
        LD (DE),A
        INC E
        JR Z,GENZEXT
GENZJP2 BIT 2,E
        JR Z,GENZLP
        LD (DE),A
        INC E
        LD (DE),A
        INC E
        LD (DE),A
        INC E
        LD (DE),A
        INC E
        JR Z,GENZEXT
GENZLP  LD (DE),A
        INC E
        LD (DE),A
        INC E
        LD (DE),A
        INC E
        LD (DE),A
        INC E
        LD (DE),A
        INC E
        LD (DE),A
        INC E
        LD (DE),A
        INC E
        LD (DE),A
        INC E
        JP NZ,GENZLP
GENZEXT LD A,(QTFREE)
        ADD A,high DAC0
        ADD A,(IY+CHRDN)
        LD D,A
        LD E,#FF
        LD A,#80
        LD (DE),A
GENEXT  XOR A
        LD (CPAGE),A
        OUT (MPAG),A
        BIT 0,(IY+CHSTAT)
        RET Z
        JP CALCVOL

;INCLUDE "TABLES_L.a80"

	align 256

INTTAB  DEFS #101,high INTAREA

INTTB   DW INT0,INT1,INT1,INT2,INT1,INT3,INT2,INT4,INT1,INT5
        DW INT3,INT6,INT2,INT7,INT4,#0000
INTOFF  DB 0,0,1,0,2,0,1,0,3,0,1,0,2,0,1,0

;INCLUDE "_BPM.a80"
BPMTAB
	dw #0B72,#0B19,#0AC5,#0A77,#0A2C,#09E6,#09A3,#0964
	dw #0928,#08EF,#08B8,#0884,#0853,#0823,#07F6,#07CB
	dw #07A1,#0779,#0753,#072E,#070B,#06E9,#06C8,#06A9
	dw #068A,#066D,#0650,#0635,#061B,#0601,#05E8,#05D0
	dw #05B9,#05A2,#058C,#0577,#0563,#054F,#053B,#0528
	dw #0516,#0504,#04F3,#04E2,#04D2,#04C2,#04B2,#04A3
	dw #0494,#0485,#0477,#046A,#045C,#044F,#0442,#0436
	dw #0429,#041D,#0412,#0406,#03FB,#03F0,#03E5,#03DB
	dw #03D1,#03C6,#03BD,#03B3,#03AA,#03A0,#0397,#038E
	dw #0385,#037D,#0374,#036C,#0364,#035C,#0354,#034D
	dw #0345,#033E,#0336,#032F,#0328,#0321,#031A,#0314
	dw #030D,#0307,#0300,#02FA,#02F4,#02EE,#02E8,#02E2
	dw #02DC,#02D7,#02D1,#02CC,#02C6,#02C1,#02BC,#02B6
	dw #02B1,#02AC,#02A7,#02A2,#029E,#0299,#0294,#0290
	dw #028B,#0287,#0282,#027E,#0279,#0275,#0271,#026D
	dw #0269,#0265,#0261,#025D,#0259,#0255,#0251,#024E
	dw #024A,#0246,#0243,#023F,#023C,#0238,#0235,#0231
	dw #022E,#022B,#0227,#0224,#0221,#021E,#021B,#0218
	dw #0215,#0212,#020F,#020C,#0209,#0206,#0203,#0200
	dw #01FE,#01FB,#01F8,#01F5,#01F3,#01F0,#01ED,#01EB
	dw #01E8,#01E6,#01E3,#01E1,#01DE,#01DC,#01D9,#01D7
	dw #01D5,#01D2,#01D0,#01CE,#01CC,#01C9,#01C7,#01C5
	dw #01C3,#01C1,#01BE,#01BC,#01BA,#01B8,#01B6,#01B4
	dw #01B2,#01B0,#01AE,#01AC,#01AA,#01A8,#01A6,#01A4
	dw #01A3,#01A1,#019F,#019D,#019B,#0199,#0198,#0196
	dw #0194,#0192,#0191,#018F,#018D,#018C,#018A,#0188
	dw #0187,#0185,#0183,#0182,#0180,#017F,#017D,#017C
	dw #017A,#0179,#0177,#0176,#0174,#0173,#0171,#0170

;INCLUDE "_trash.a80"	;comes from original ROM!
;strange block, comes from original ROM.
;real garbage;)

	DB #56,#43,#56,#49,#45,#57,#20,#20,#45,#58,#54,#20,#00,#00,#00,#00
	DB #00,#00,#00,#00,#00,#00,#C4,#08,#43,#21,#28,#09,#DA,#02,#00,#00
	DB #00,#43,#56,#49,#45,#57,#20,#20,#45,#58,#54,#20,#00,#00,#00,#00
	DB #00,#00,#00,#00,#00,#00,#C4,#08,#43,#21,#28,#09,#DA,#02,#00,#00

Free1
;---patched
Patch11
	LD H,(HL)
        LD L,D
        ADD HL,HL,HL,HL
	JR NC,$+3:INC D
        LD A,(MODTP)
        INC A
        LD BC,#0000+1084
        JR Z,TTT15x
        LD BC,#0000+600
TTT15x  ADD HL,BC
	JR NC,$+3:INC D
	XOR A
        LD (CPAGE),A
        OUT (MPAG),A
	LD A,D
        LD DE,#5000
        LD BC,#400
        CALL LDMEM
        XOR A
        OUT (#00),A
        RET
        
; new cmd #6A - Set player mode
COM6A	LD A,(PlMode)	;command
	OUT (ZXDATWR),A
	IN A,(ZXDATRD)
	OUT (CLRCBIT),A
	LD (PlMode),A
	RET

Patch2x	LD A,(PlMode):OR A:RET NZ
	LD HL,MTSTAT
        SET 7,(HL)
        RET

; last note speed
Patch3	LD A,(MTSNGPS):OR A:JR NZ,Patch3e	;1st pattern
	LD A,(MTPATPS):OR A:JR NZ,Patch3e	;1st row
        LD A,6		;init speed at start of MOD
        LD (MTSPEED),A
        LD HL,750
        LD (TICKLEN),HL
        LD (TCKLEFT),HL
Patch3e	LD IY,CHANS
	JP EFXGTNT+4
	
; initial note
Patch4	LD (IY+CHCNTL),#00
	LD (IY+CHREAL),#7F
	RET
	
;MOD relooper
; new cmd #6B - Set minimal loop length (turn on relooper)

COM6B	IN A,(ZXDATRD):LD L,A
	OUT (CLRCBIT),A
	IN A,(ZXSTAT):AND #81:JR Z,$-4
	JP P,Patch5s
	IN A,(ZXDATRD):LD H,A
	LD DE,16385
	OR A:SBC HL,DE:ADD HL,DE
	JR C,Patch5s+3
Patch5s	LD HL,#0200
	LD (MODLLEN),HL
	RET

;reconstruct MOD after load
Patch5x	CALL PLAYMD		;init MOD
	LD HL,(MODLLEN)
	LD A,H:OR L:RET Z	;relooper off
	LD A,(MODTP):OR A
	LD A,31,HL,1084
	JR NZ,$+7
	LD A,15,HL,600
	LD (MODSMPS),A,(MODPTST),HL
	CALL CHIP
        JP PLAYMD		;init MOD again

;INCLUDE "reloop.a80"

;-----(c)Evgeny Muchkin

;MODSMPS	equ #5000
;MODPTST	equ #5001
;ChipSP_	equ #5005
;CHIP246 equ #5007
;TOcip_	equ #5009
;CHIPLN  equ #5010	; НА4АЛО СЕМПЛОВ (pointer)
;CHIPPP  equ #5013	; ДЛИНА МОДУЛЯ
;CIP1    equ #5016	; ОТКУДА ПЕРЕНОСИТЬ
;CIP2    equ #5019	; КУДА ПЕРЕНОСИТЬ
;CIP3    equ #501c	; КОНЕЦ БЛОКА

CHIP    DI
        LD A,(RAMPG)
        OUT (MPAG),A
        LD DE,(MODPTST)	;patts data!
        LD A,(PATTS)
        LD L,A
        LD H,B
        ADD HL,HL
        ADD HL,HL
        LD A,H
        LD H,L
        LD L,B
        ADD HL,DE
        ADC A,B
        LD (CHIPLN),HL
        LD (CHIPLN+2),A
        LD (ChipSP_),SP
        LD HL,CHIPLN
        LD DE,CHIPPP
        PUSH DE
        LDI:LDI:LDI
        POP IY
	LD A,(MODSMPS)
        LD B,A		;smps!
        LD DE,30
        LD IX,#8014
ChIp    LD H,(IX+22)	;len
        LD L,(IX+23)
        CALL TOCip
        ADD IX,DE
        DJNZ ChIp
        LD IX,#802A
	LD A,(MODSMPS)
        LD B,A		;smps!
CHIP1   LD A,(RAMPG)
        OUT (MPAG),A
        LD H,(IX+6)     ;loop len
        LD L,(IX+7)
        LD (CHIP246),HL
        LD A,(IX)	;len
        OR (IX+1)
        JP Z,CHIP2	;skip if no smp
        LD DE,2
        CALL CP_DDE
        JP C,CHIP2	;skip if loop len <2
LUP_LEN LD DE,(MODLLEN)
        CALL CP_DDE
        JP NC,CHIP2	;skip if loop len>=LUP_LEN
        PUSH BC
        LD B,H,C,L
        EXX
        LD BC,0		;reloop counter
CHIP3   EXX
        ADD HL,BC
        CALL CP_DDE
        EXX
        INC BC
        JR C,CHIP3
        PUSH BC
        EXX
;!!!!!!!!!!!!!!!!!!!!!!!!!!
        PUSH HL		;new loop len
        LD B,(IX+6)	;loop len
        LD C,(IX+7)
        AND A
        SBC HL,BC
        LD DE,CHIPPP
        LD (TOcip_),DE
        LD IY,CIP1
        CALL TOCIP
        LD DE,CHIPLN
        LD (TOcip_),DE
        LD B,3		;check if free mem
        LD DE,CIP1+2
        LD HL,RAMTOP+2
ChipLP  LD A,(DE)
        CP (HL)
        DEC HL,DE
        JR C,ChipOK
        JP NZ,ChipSP
        DJNZ ChipLP
ChipOK  POP HL
        EX DE,HL	;DE=new loop len
        LD H,(IX)	;len
        LD L,(IX+1)
        LD B,(IX+6)	;loop len
        LD C,(IX+7)
        AND A
        SBC HL,BC
        ADD HL,DE
        LD (IX),H	;new smp len
        LD (IX+1),L
        LD (IX+6),D	;new loop len
        LD (IX+7),E
        LD IY,CIP1
        LD H,(IX+4)	;loop start
        LD L,(IX+5)
        PUSH HL,HL,HL
        ADD HL,BC
        CALL TOCIP
        LD IY,CIP2
        POP HL
        ADD HL,DE
        CALL TOCIP
        LD HL,CHIPPP
        LD DE,CIP3
        LDI:LDI:LDI
        CALL DIRER
        LD IY,CIP1
        POP HL
        CALL TOCIP
        POP HL
CHIP4   LD DE,(CHIP246)	;orig loop len
        ADD HL,DE
        LD IY,CIP2
        CALL TOCIP
        LD HL,CIP2
        LD DE,CIP3
        LDI:LDI:LDI
        POP BC
CHIP5   PUSH BC
        CALL DIRER
CHIP6   LD HL,(CHIP246)	;orig loop len
        LD IY,CIP2
        CALL TOCip
        POP BC
        DEC BC
        LD A,B
        OR C
        JR NZ,CHIP5
        POP BC
CHIP2   LD DE,(CHIP246)	;orig loop len
        LD A,(RAMPG)
        OUT (MPAG),A
        LD H,(IX+6)	;new loop len
        LD L,(IX+7)
        AND A
        SBC HL,DE
        LD IY,CHIPPP	;corr mod len
        CALL TOCip
        LD H,(IX)
        LD L,(IX+1)
        LD IY,CHIPLN	;add pointer
        CALL TOCip
        LD DE,30
        ADD IX,DE
        DEC B
        JP NZ,CHIP1
ChipSP  LD SP,(ChipSP_)
        EI
	RET

DIRER   LD IY,CIP1
        LD L,(IY+3)
        LD H,(IY+4)
        LD B,(IY+5)
        EXX
        LD L,(IY)
        LD H,(IY+1)
        LD B,(IY+2)
        LD E,(IY+6)
        LD D,(IY+7)
        LD C,(IY+8)
        PUSH IX
        CALL RESI10_
        POP IX
        RET

TOCIP   PUSH HL,DE
        PUSH IY
        POP DE
TOcip   LD HL,(TOcip_)	;CHIPLN
        LDI:LDI:LDI
        POP DE,HL
TOCip   CALL ADD_IY
ADD_IY  LD A,(IY)
        ADD A,L
        LD (IY),A
        LD A,(IY+1)
        ADC A,H
        LD (IY+1),A
        LD A,(IY+2)
        ADC A,0
        LD (IY+2),A
        RET

CP_DDE  PUSH HL
        AND A
        SBC HL,DE
        POP HL
        RET

;RESID10 ; MOVE BLOCK IN GS
;          BHL - FROM
;          CDE - END
;         'BHL - TO

RESI10_ SUB A:OUT (MPAG),A
        LD (SYSTEM),A,A,B
        PUSH HL:EXX:POP DE
        PUSH HL,BC
        LD C,A:OR A:SBC HL,DE
        LD A,B:SBC A,C:EX DE,HL
        POP BC,HL:LD C,A:OR E,D
        RET Z
        EXX:EX DE,HL:SBC HL,DE:LD A,C
        SBC A,B:LD LX,A:OR L,H:EXX
        RET Z
        PUSH DE,BC:BIT 7,C:EXX
        JP NZ,MOVL
        JP MOVH
;-----

;store settings
Patch5i1
	LD A,(PlMode),C,A
	LD DE,(MODLLEN)
	LD A,(ERRCODE)
	RET

;restore settings
Patch5i2
	LD (ERRCODE),A
	LD A,C,(PlMode),A
	LD (MODLLEN),DE
	RET

;clear vars after full reset!
Patch5i3
	XOR A:LD H,A,L,A
	LD (PlMode),A
	LD (MODLLEN),HL
	JP INITVAR

CP_END_MOD
	;LD HL,MTSNGPS
	;INC (HL)
	;CP (HL)
	;CALL C,STOPMOD
	;LD (MTSNGPS),A
	;RET
	
;	display $
;---
;emptyobl1

;	ORG GSRomBaseL+#1D00

;	IN A,(ZXDATRD)
;	OUT (CLRCBIT),A
;	LD A,#7F
;	OUT (ZXDATWR),A
;	JP COMINT_
	
;WDY	IN A,(ZXSTAT)
;	RLA
;	JR NC,$-3
;	RET
	
;WDN	IN A,(ZXSTAT)
;	RLA
;	JR C,$-3
;	RET

        ORG GSRomBaseL+#2000
;SGEN    
;INCLUDE "SGEN_ASM.a80"
;	MODULE SGEN
;INCLUDE "SGEN.a80"

SGENTBE DW S0,S1,S2,S3,S4,S5,S6,S7,S8

SGENTBF DW SGEN1,SGEN2,SGEN3,SGEN4,SGEN5,SGEN6,SGEN7,SGEN8,SGEN9

        DS 12

SGEN	EXX
        INC D
        DEC D
        JP Z,SGEN_
        LD C,A
        LD A,D
        DEC A
        CP #09
        JP NC,SGEN__
        ADD A,A
        ADD A,low SGENTBF
        LD L,A
        LD H,high SGENTBF
        LD A,(HL)
        INC L
        LD H,(HL)
        LD L,A
        LD A,C
        JP (HL)

SGEN1   EXX
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        EXX
        JP SGEN_

SGEN2   EXX
        SUB (HL)
        EXX
        LD H,high DIVTAB3
        JP NC,SGEN2_2
        INC H
SGEN2_2 LD L,A
        LD A,(HL)
        EXX
        ADD A,(HL)
        LD (DE),A
        INC E
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        EXX
        JP SGEN_

SGEN3   EXX
        ADD A,(HL)
        RRA
        EXX
        LD L,A
        ADD A,C
        RRA
        EXX
        LD (DE),A
        INC E
        EXX
        LD A,L
        EXX
        LD (DE),A
        INC E
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        EXX
        JP SGEN_

SGEN4   EXX
        ADD A,(HL)
        RRA
        EXX
        LD L,A
        ADD A,C
        RRA
        EXX
        LD (DE),A
        INC E
        EXX
        LD A,L
        EXX
        LD (DE),A
        INC E
        LD (DE),A
        INC E
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        EXX
        JP SGEN_

SGEN5   EXX
        ADD A,(HL)
        RRA
        EXX
        LD L,A
        ADD A,C
        RRA
        EXX
        LD (DE),A
        INC E
        LD (DE),A
        INC E
        EXX
        LD A,L
        EXX
        LD (DE),A
        INC E
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        LD (DE),A
        INC E
        EXX
        JP SGEN_

SGEN6   EXX
        ADD A,(HL)
        RRA
        EXX
        LD L,A
        ADD A,C
        RRA
        EXX
        LD (DE),A
        INC E
        LD (DE),A
        INC E
        EXX
        LD A,L
        EXX
        LD (DE),A
        INC E
        LD (DE),A
        INC E
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        LD (DE),A
        INC E
        EXX
        JP SGEN_

SGEN7   EXX
        ADD A,(HL)
        RRA
        EXX
        LD L,A
        ADD A,C
        RRA
        LD H,A
        ADD A,C
        RRA
        EXX
        LD (DE),A
        INC E
        EXX
        LD A,H
        EXX
        LD (DE),A
        INC E
        EXX
        ADD A,L
        RRA
        EXX
        LD (DE),A
        INC E
        EXX
        LD A,L
        EXX
        LD (DE),A
        INC E
        ADD A,(HL)
        RRA
        EXX
        LD H,A
        ADD A,L
        RRA
        EXX
        LD (DE),A
        INC E
        EXX
        LD A,H
        EXX
        LD (DE),A
        INC E
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        EXX
        JP SGEN_

SGEN8   EXX
        ADD A,(HL)
        RRA
        EXX
        LD L,A
        ADD A,C
        RRA
        LD H,A
        ADD A,C
        RRA
        EXX
        LD (DE),A
        INC E
        EXX
        LD A,H
        EXX
        LD (DE),A
        INC E
        EXX
        ADD A,L
        RRA
        EXX
        LD (DE),A
        INC E
        EXX
        LD A,L
        EXX
        LD (DE),A
        INC E
        LD (DE),A
        INC E
        ADD A,(HL)
        RRA
        EXX
        LD H,A
        ADD A,L
        RRA
        EXX
        LD (DE),A
        INC E
        EXX
        LD A,H
        EXX
        LD (DE),A
        INC E
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        EXX
        JP SGEN_

SGEN9   EXX
        ADD A,(HL)
        RRA
        EXX
        LD L,A
        ADD A,C
        RRA
        LD H,A
        ADD A,C
        RRA
        EXX
        LD (DE),A
        INC E
        EXX
        LD A,H
        EXX
        LD (DE),A
        INC E
        LD (DE),A
        INC E
        EXX
        ADD A,L
        RRA
        EXX
        LD (DE),A
        INC E
        EXX
        LD A,L
        EXX
        LD (DE),A
        INC E
        ADD A,(HL)
        RRA
        EXX
        LD H,A
        ADD A,L
        RRA
        EXX
        LD (DE),A
        INC E
        EXX
        LD A,H
        EXX
        LD (DE),A
        INC E
        LD (DE),A
        INC E
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        EXX
        JP SGEN_

SGEN__  JP SGEN_

SGEN_   LD A,E
        CP #09
        JR NC,S9
        ADD A,A
        LD L,A
        LD H,high SGENTBE
        LD A,(HL)
        INC L
        LD H,(HL)
        LD L,A
        JP (HL)

S9      EXX
        LD C,#FF
        EXX
        LD D,#08
        JP S8

S0      EXX
        LD C,#00
        EXX
        LD D,#01
        JP S1

S3      EXX
        PUSH BC
        EXX
        POP HL
        LD B,E
        LD E,H
        LD C,L
        CALL S3_
S_RET   LD LY,E
        LD E,D
        LD D,LY
        PUSH DE
        EXX
        POP BC
        RET

S4      EXX
        PUSH BC
        EXX
        POP HL
        LD B,E
        LD E,H
        LD C,L
        CALL S4_
        JP S_RET

S5      EXX
        PUSH BC
        EXX
        POP HL
        LD B,E
        LD E,H
        LD C,L
        CALL S5_
        JP S_RET

S6      EXX
        PUSH BC
        EXX
        POP HL
        LD B,E
        LD E,H
        LD C,L
        CALL S6_
        JP S_RET

S7      EXX
        PUSH BC
        EXX
        POP HL
        LD B,E
        LD E,H
        LD C,L
        CALL S7_
        JP S_RET

S8      EXX
        PUSH BC
        EXX
        POP HL
        LD B,E
        LD E,H
        LD C,L
        CALL S8_
        JP S_RET

;INCLUDE "SGEN1_L.a80"
S1      EXX
        SLA C
        JR C,S1_6
        LD A,LX
        INC A
        JR Z,S1_2
        DEC A
        ADD A,E
        JR Z,S1_4
        JR C,S1_2
        BIT 7,C
        JR Z,S1_4
        LD LY,A
        LD A,LX
        SRL A
        SRL A
        ADD A,LY
        JR Z,S1_4
        JR NC,S1_4
S1_2    SLI B
        JR NC,S1_3
        LD A,E
        AND #03
        JP Z,S11L0_1
        DEC A
        JP Z,S11L1_1
        DEC A
        JP Z,S11L2_1
        JP S11L3
S1_3    LD A,E
        AND #03
        JP Z,S11H0_1
        DEC A
        JP Z,S11H1_1
        DEC A
        JP Z,S11H2_1
        JP S11H3
S1_4    SLI B
        JR NC,S1_5
        LD A,E
        AND #03
        JP Z,S12L0_1
        DEC A
        JP Z,S12L1_1
        DEC A
        JP Z,S12L2_1
        JP S12L3
S1_5    LD A,E
        AND #03
        JP Z,S12H0_1
        DEC A
        JP Z,S12H1_1
        DEC A
        JP Z,S12H2_1
        JP S12H3

S1_6    LD A,LX
        INC A
        JR Z,S1_7
        DEC A
        SRL A
        ADD A,LX
        JR Z,S1_9
        JR C,S1_7
        ADD A,E
        JR C,S1_7
        BIT 7,C
        JR Z,S1_9
        LD LY,A
        LD A,LX
        SRL A
        SRL A
        ADD A,LY
        JR Z,S1_9
        JR NC,S1_9
S1_7    SLI B
        JR C,S1_8
        LD A,E
        AND #03
        JP Z,S13L0
        DEC A
        JP Z,S13L1
        DEC A
        JP Z,S13L2
        JP S13L3
S1_8    LD A,E
        AND #03
        JP Z,S13H0
        DEC A
        JP Z,S13H1
        DEC A
        JP Z,S13H2
        JP S13H3
S1_9    SLI B
        JR C,S1_A
        LD A,E
        AND #03
        JP Z,S14L0
        DEC A
        JP Z,S14L1
        DEC A
        JP Z,S14L2
        JP S14L3
S1_A    LD A,E
        AND #03
        JP Z,S14H0
        DEC A
        JP Z,S14H1
        DEC A
        JP Z,S14H2
        JP S14H3

S11M0   LD B,A
        DEC HL
        LD A,(HL)
        INC HL
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        LDI
        INC C
S11L2_1 LD A,B
S11L2_2 LDI
        INC C
        ADD A,C
        LD B,A
        JP NC,S11L3
        ADD A,C
        JP C,S11M3
S11G3   LD B,A
        DEC HL
        LD A,(HL)
        INC HL
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S11R1
        LDI
        INC C
S11H1_1 LD A,B
S11H1_2 LDI
        INC C
        ADD A,C
        JP NC,S11H2_2
        LDI
        INC C
        ADD A,C
        LD B,A
        JP NC,S11L3
        ADD A,C
        JP C,S11M3
        JP S11G3

S11R1   LD LY,A
        LD A,B
        SUB C
        LD B,A
        SRL B
        LD C,#00
        LD A,LY
        RET

S11M1   LD B,A
        DEC HL
        LD A,(HL)
        INC HL
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        LDI
        INC C
S11L3   LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        JR Z,S11R2
        LD A,B
        ADD A,C
        JP NC,S11L0_2
        ADD A,C
        JR C,S11M0
S11G0   LD B,A
        DEC HL
        LD A,(HL)
        INC HL
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        LDI
        INC C
S11H2_1 LD A,B
S11H2_2 LDI
        INC C
        ADD A,C
        LD B,A
        JP NC,S11H3
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        JR Z,S11R2
        LD A,B
        ADD A,C
        JP NC,S11L0_2
        ADD A,C
        JP C,S11M0
        JP S11G0

S11R2   LD LY,A
        LD A,B
        ADD A,C
        LD B,A
        JR NC,S11R2_2
        LD C,#01
        SRL B
        LD A,LY
        RET
S11R2_2 LD C,#00
        RRC B
        LD A,LY
        RET

S11M2   LD B,A
        DEC HL
        LD A,(HL)
        INC HL
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        JR Z,S11R3
S11L0_1 LD A,B
S11L0_2 LDI
        INC C
        ADD A,C
        JP NC,S11L1_2
        ADD A,C
        JR C,S11M1
S11G1   LD B,A
        DEC HL
        LD A,(HL)
        INC HL
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        LDI
        INC C
S11H3   LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        JR Z,S11R4
        LD A,B
        ADD A,C
        JP NC,S11H0_2
        LDI
        INC C
        ADD A,C
        JP NC,S11L1_2
        ADD A,C
        JP C,S11M1
        JP S11G1

S11R3   LD C,#00
        RRC B
        RET

S11R4   LD LY,A
        LD A,B
        ADD A,C
        LD B,A
        JR NC,S11R4_2
        LD C,#00
        RRC B
        LD A,LY
        RET
S11R4_2 LD C,#00
        SRL B
        LD A,LY
        RET

S11R5   LD LY,A
        LD A,B
        SUB C
        LD B,A
        LD C,#00
        SRL B
        LD A,LY
        RET

S11M3   LD B,A
        DEC HL
        LD A,(HL)
        INC HL
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S11R5
        LDI
        INC C
S11L1_1 LD A,B
S11L1_2 LDI
        INC C
        ADD A,C
        JP NC,S11L2_2
        ADD A,C
        JR C,S11M2
S11G2   LD B,A
        DEC HL
        LD A,(HL)
        INC HL
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        JR Z,S11R6
S11H0_1 LD A,B
S11H0_2 LDI
        INC C
        ADD A,C
        JP NC,S11H1_2
        LDI
        INC C
        ADD A,C
        JP NC,S11L2_2
        ADD A,C
        JP C,S11M2
        JP S11G2

S11R6   LD C,#00
        SRL B
        RET

S12M0   LD B,A
        DEC HL
        LD A,(HL)
        INC HL
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        LDI
        INC C
        DEC LX
        JR Z,S12R3_3
S12L2_1 LD A,B
S12L2_2 LDI
        INC C
        DEC LX
        JR Z,S12R2_5
        ADD A,C
        LD B,A
        JP NC,S12L3
        ADD A,C
        JP C,S12M3
S12G3   LD B,A
        DEC HL
        LD A,(HL)
        INC HL
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S12R1
        LDI
        INC C
        DEC LX
        JR Z,S12R6_3
S12H1_1 LD A,B
S12H1_2 LDI
        INC C
        DEC LX
        JR Z,S12R4_4
        ADD A,C
        JP NC,S12H2_2
        LDI
        INC C
        DEC LX
        JR Z,S12R2_5
        ADD A,C
        LD B,A
        JP NC,S12L3
        ADD A,C
        JP C,S12M3
        JP S12G3

S12R2_5 JR S12R2_3
S12R6_3 JP S12R6_2

S12R1   LD LY,A
        LD A,B
        SUB C
        LD B,A
        SRL B
        LD C,#00
        LD A,LY
        RET

S12R3_3 DEC HL
        LD A,(HL)
        INC HL
        LD C,#00
        RRC B
        RET
        
S12R4_4 JP S12R4_3

S12M1   LD B,A
        DEC HL
        LD A,(HL)
        INC HL
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        LDI
        INC C
        DEC LX
        JR Z,S12R3_3
S12L3   LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        JR Z,S12R2
        DEC LX
        JR Z,S12R2
        LD A,B
        ADD A,C
        JP NC,S12L0_2
        ADD A,C
        JP C,S12M0
S12G0   LD B,A
        DEC HL
        LD A,(HL)
        INC HL
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        LDI
        INC C
        DEC LX
        JR Z,S12R6_3
S12H2_1 LD A,B
S12H2_2 LDI
        INC C
        DEC LX
        JR Z,S12R4_4
        ADD A,C
        LD B,A
        JP NC,S12H3
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        JR Z,S12R2
        DEC LX
        JR Z,S12R2
        LD A,B
        ADD A,C
        JP NC,S12L0_2
        ADD A,C
        JP C,S12M0
        JP S12G0

S12R2_3 DEC HL
        LD A,(HL)
        INC HL
S12R2   LD LY,A
        LD A,B
        ADD A,C
        LD B,A
        JR NC,S12R2_2
        LD C,#01
        SRL B
        LD A,LY
        RET
S12R2_2 LD C,#00
        RRC B
        LD A,LY
        RET

S12M2   LD B,A
        DEC HL
        LD A,(HL)
        INC HL
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        JR Z,S12R3
        DEC LX
        JR Z,S12R3
S12L0_1 LD A,B
S12L0_2 LDI
        INC C
        DEC LX
        JR Z,S12R2_3
        ADD A,C
        JP NC,S12L1_2
        ADD A,C
        JP C,S12M1
S12G1   LD B,A
        DEC HL
        LD A,(HL)
        INC HL
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        LDI
        INC C
        DEC LX
        JR Z,S12R6_5
S12H3   LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        JR Z,S12R4
        DEC LX
        JR Z,S12R4
        LD A,B
        ADD A,C
        JP NC,S12H0_2
        LDI
        INC C
        DEC LX
        JR Z,S12R2_3
        ADD A,C
        JP NC,S12L1_2
        ADD A,C
        JP C,S12M1
        JP S12G1

S12R6_5 JP S12R6_2

S12R3_2 DEC HL
        LD A,(HL)
        INC HL
S12R3   LD C,#00
        RRC B
        RET

S12R4_3 DEC HL
        LD A,(HL)
        INC HL
S12R4   LD LY,A
        LD A,B
        ADD A,C
        LD B,A
        JR NC,S12R4_2
        LD C,#00
        RRC B
        LD A,LY
        RET
S12R4_2 LD C,#00
        SRL B
        LD A,LY
        RET

S12R5   LD LY,A
        LD A,B
        SUB C
        LD B,A
        LD C,#00
        SRL B
        LD A,LY
        RET

S12M3   LD B,A
        DEC HL
        LD A,(HL)
        INC HL
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S12R5
        LDI
        INC C
        DEC LX
        JR Z,S12R3_2
S12L1_1 LD A,B
S12L1_2 LDI
        INC C
        DEC LX
        JR Z,S12R2_4
        ADD A,C
        JP NC,S12L2_2
        ADD A,C
        JP C,S12M2
S12G2   LD B,A
        DEC HL
        LD A,(HL)
        INC HL
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        JR Z,S12R6
        DEC LX
        JR Z,S12R6
S12H0_1 LD A,B
S12H0_2 LDI
        INC C
        DEC LX
        JR Z,S12R4_3
        ADD A,C
        JP NC,S12H1_2
        LDI
        INC C
        DEC LX
        JR Z,S12R2_4
        ADD A,C
        JP NC,S12L2_2
        ADD A,C
        JP C,S12M2
        JP S12G2

S12R6_2 DEC HL
        LD A,(HL)
        INC HL
S12R6   LD C,#00
        SRL B
        RET

S12R2_4 JP S12R2_3

S13R1   JR NC,S13R1_2
        SRL B
        LD C,#01
        RET
S13R1_2 RRC B
        LD C,#00
        RET
S13R2   SRL B
        LD C,#00
        RET

S13J0   ADD A,(HL)
        RRA
        LD (DE),A
        INC E
S13H1   LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        JP C,S13J2
S13K2   ADD A,(HL)
        RRA
        LD (DE),A
        INC E
S13L3   LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        JR Z,S13R1
        JP C,S13K0
        LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        JP NC,S13K1
S13J1   ADD A,(HL)
        RRA
        LD (DE),A
        INC E
S13H2   LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        JP C,S13J3
S13K3   ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S13R2
S13L0   LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        JP C,S13K1
        LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        JP NC,S13K2
S13J2   ADD A,(HL)
        RRA
        LD (DE),A
        INC E
S13H3   LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        JR Z,S13R3
        JP C,S13J0
S13K0   ADD A,(HL)
        RRA
        LD (DE),A
        INC E
S13L1   LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        JP C,S13K2
        LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        JP NC,S13K3
S13J3   ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S13R4
S13H0   LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        JP C,S13J1
S13K1   ADD A,(HL)
        RRA
        LD (DE),A
        INC E
S13L2   LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        JP C,S13K3
        LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        JR Z,S13R5
        JP NC,S13K0
        JP S13J0
        
S13R3   LD C,#01
        JR NC,S13R3_2
        RRC B
        RET
        
S13R3_2 SRL B
        RET
        
S13R4   RRC B
        LD C,#00
        RET

S13R5   LD C,#01
        JR NC,S13R5_2
        RRC B
        RET
        
S13R5_2 SRL B
        RET

S14R5_3 JP S14R5

S14R1   JR NC,S14R1_2
        SRL B
        LD C,#01
        RET
        
S14R1_2 RRC B
        LD C,#00
        RET
        
S14R2   SRL B
        LD C,#00
        RET

S14J0   ADD A,(HL)
        RRA
        LD (DE),A
        INC E
S14H1   LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        DEC LX
        JR Z,S14R5_3
        JP C,S14J2
S14K2   ADD A,(HL)
        RRA
        LD (DE),A
        INC E
S14L3   LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        JR Z,S14R1
        DEC LX
        JR Z,S14R1
        JP C,S14K0
        LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        DEC LX
        JR Z,S14R5_3
        JP NC,S14K1
S14J1   ADD A,(HL)
        RRA
        LD (DE),A
        INC E
S14H2   LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        DEC LX
        JR Z,S14R5_3
        JP C,S14J3
S14K3   ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S14R2
S14L0   LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        DEC LX
        JR Z,S14R1
        JP C,S14K1
        LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        DEC LX
        JR Z,S14R5
        JP NC,S14K2
S14J2   ADD A,(HL)
        RRA
        LD (DE),A
        INC E
S14H3   LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        JR Z,S14R5
        DEC LX
        JR Z,S14R5
        JP C,S14J0
S14K0   ADD A,(HL)
        RRA
        LD (DE),A
        INC E
S14L1   LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        DEC LX
        JR Z,S14R1_3
        JP C,S14K2
        LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        DEC LX
        JR Z,S14R5
        JP NC,S14K3
S14J3   ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S14R4
S14H0   LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        DEC LX
        JR Z,S14R5
        JP C,S14J1
S14K1   ADD A,(HL)
        RRA
        LD (DE),A
        INC E
S14L2   LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        DEC LX
        JR Z,S14R1_3
        JP C,S14K3
        LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        JR Z,S14R5
        DEC LX
        JR Z,S14R5
        JP NC,S14K0
        JP S14J0

S14R5   LD C,#01
        JR NC,S14R5_2
        RRC B
        RET
        
S14R5_2 SRL B
        RET
        
S14R4   RRC B
        LD C,#00
        RET
        
S14R1_3 JP S14R1

;INCLUDE "SGEN2_L.a80"
S2      LD H,high DIVTAB3
        LD D,H
        INC D
        EXX
        SLA C
        JR C,S2_6
        LD A,LX
        ADD A,A
        JR C,S2_2
        ADD A,E
        JR Z,S2_4
        JR C,S2_2
        BIT 7,C
        JR Z,S2_4
        LD LY,A
        LD A,LX
        SRL A
        SRL A
        ADD A,LY
        JR Z,S2_4
        JR NC,S2_4
S2_2    SLI B
        JR NC,S2_3
        LD A,E
        AND #03
        JP Z,S21L0
        DEC A
        JP Z,S21L1
        DEC A
        JP Z,S21L2
        JP S21L3
S2_3    LD A,E
        AND #03
        JP Z,S21H0
        DEC A
        JP Z,S21H1
        DEC A
        JP Z,S21H2
        JP S21H3
S2_4    SLI B
        JR NC,S2_5
        LD A,E
        AND #03
        JP Z,S22L0
        DEC A
        JP Z,S22L1
        DEC A
        JP Z,S22L2
        JP S22L3
S2_5    LD A,E
        AND #03
        JP Z,S22H0
        DEC A
        JP Z,S22H1
        DEC A
        JP Z,S22H2
        JP S22H3

S2_6    LD A,LX
        ADD A,A
        JR C,S2_7
        LD LY,A
        LD A,LX
        SRL A
        ADD A,LY
        JR C,S2_7
        ADD A,E
        JR Z,S2_9
        JR C,S2_7
        BIT 7,C
        JR Z,S2_9
        LD LY,A
        LD A,LX
        SRL A
        SRL A
        ADD A,LY
        JR Z,S2_9
        JR NC,S2_9
S2_7    SLI B
        JR C,S2_8
        LD A,E
        AND #03
        JP Z,S23L0
        DEC A
        JP Z,S23L1
        DEC A
        JP Z,S23L2
        JP S23L3
S2_8    LD A,E
        AND #03
        JP Z,S23H0
        DEC A
        JP Z,S23H1
        DEC A
        JP Z,S23H2
        JP S23H3
S2_9    SLI B
        JR C,S2_A
        LD A,E
        AND #03
        JP Z,S24L0
        DEC A
        JP Z,S24L1
        DEC A
        JP Z,S24L2
        JP S24L3
S2_A    LD A,E
        AND #03
        JP Z,S24H0
        DEC A
        JP Z,S24H1
        DEC A
        JP Z,S24H2
        JP S24H3

S21G0   LD E,A
        LD A,(DE)
        EXX
        ADD A,(HL)
        LD (DE),A
        INC E
S21J1   ADD A,(HL)
        RRA
        LD (DE),A
        INC E
S21H2   LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        JP NC,S21J3
S21K3   ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S21R1
S21L0   LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        JP NC,S21K1
        SUB (HL)
        EXX
        JP C,S21G1
        LD L,A
        LD A,(HL)
        EXX
        ADD A,(HL)
        LD (DE),A
        INC E
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        JR Z,S21R2
        JP C,S21K0
        JP S21J0

S21R1   LD C,#00
        RRC B
        RET

S21R2   LD C,#01
        JR NC,S21R2_2
        RRC B
        RET
        
S21R2_2 SRL B
        RET

S21G1   LD E,A
        LD A,(DE)
        EXX
        ADD A,(HL)
        LD (DE),A
        INC E
S21J2   ADD A,(HL)
        RRA
        LD (DE),A
        INC E
S21H3   LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        JR Z,S21R2
        JP NC,S21J0
S21K0   ADD A,(HL)
        RRA
        LD (DE),A
        INC E
S21L1   LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        JP NC,S21K2
        SUB (HL)
        EXX
        JP C,S21G2
        LD L,A
        LD A,(HL)
        EXX
        ADD A,(HL)
        LD (DE),A
        INC E
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S21R3
        LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        JP C,S21K1
        JP S21J1

S21R3   LD C,#00
        SRL B
        RET

S21G2   LD E,A
        LD A,(DE)
        EXX
        ADD A,(HL)
        LD (DE),A
        INC E
S21J3   ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S21R3
S21H0   LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        JP NC,S21J1
S21K1   ADD A,(HL)
        RRA
        LD (DE),A
        INC E
S21L2   LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        JP NC,S21K3
        SUB (HL)
        EXX
        JP C,S21G3
        LD L,A
        LD A,(HL)
        EXX
        ADD A,(HL)
        LD (DE),A
        INC E
        JR Z,S21R4
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        JP C,S21K2
        JP S21J2

S21R4   LD C,#01
        SRL B
        RET

S21G3   LD E,A
        LD A,(DE)
        EXX
        ADD A,(HL)
        LD (DE),A
        INC E
        JR Z,S21R4
S21J0   ADD A,(HL)
        RRA
        LD (DE),A
        INC E
S21H1   LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        JP NC,S21J2
S21K2   ADD A,(HL)
        RRA
        LD (DE),A
        INC E
S21L3   LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        JR Z,S21R5
        JP NC,S21K0
        SUB (HL)
        EXX
        JP C,S21G0
        LD L,A
        LD A,(HL)
        EXX
        ADD A,(HL)
        LD (DE),A
        INC E
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        JP C,S21K3
        JP S21J3

S21R5   JR NC,S21R5_2
        LD C,#02
        SRL B
        RET
        
S21R5_2 LD C,#01
        RRC B
        RET

S22G0   LD E,A
        LD A,(DE)
        EXX
        ADD A,(HL)
        LD (DE),A
        INC E
S22J1   ADD A,(HL)
        RRA
        LD (DE),A
        INC E
S22H2   LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        DEC LX
        JR Z,S22R2
        JP NC,S22J3
S22K3   ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S22R1
S22L0   LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        DEC LX
        JR Z,S22R5_3
        JP NC,S22K1
        SUB (HL)
        EXX
        JP C,S22G1
        LD L,A
        LD A,(HL)
        EXX
        ADD A,(HL)
        LD (DE),A
        INC E
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        JR Z,S22R2
        DEC LX
        JR Z,S22R2
        JP C,S22K0
        JP S22J0

S22R1   LD C,#00
        RRC B
        RET

S22R2   LD C,#01
        JR NC,S22R2_2
        RRC B
        RET
        
S22R2_2 SRL B
        RET

S22R5_3 JP S22R5

S22G1   LD E,A
        LD A,(DE)
        EXX
        ADD A,(HL)
        LD (DE),A
        INC E

S22J2   ADD A,(HL)
        RRA
        LD (DE),A
        INC E
S22H3   LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        JR Z,S22R2
        DEC LX
        JR Z,S22R2
        JP NC,S22J0
S22K0   ADD A,(HL)
        RRA
        LD (DE),A
        INC E
S22L1   LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        DEC LX
        JR Z,S22R5_3
        JP NC,S22K2
        SUB (HL)
        EXX
        JP C,S22G2
        LD L,A
        LD A,(HL)
        EXX
        ADD A,(HL)
        LD (DE),A
        INC E
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S22R3
        LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        DEC LX
        JR Z,S22R2
        JP C,S22K1
        JP S22J1

S22R3   LD C,#00
        SRL B
        RET

S22G2   LD E,A
        LD A,(DE)
        EXX
        ADD A,(HL)
        LD (DE),A
        INC E
S22J3   ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S22R3
S22H0   LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        DEC LX
        JR Z,S22R2
        JP NC,S22J1
S22K1   ADD A,(HL)
        RRA
        LD (DE),A
        INC E
S22L2   LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        DEC LX
        JR Z,S22R5
        JP NC,S22K3
        SUB (HL)
        EXX
        JP C,S22G3
        LD L,A
        LD A,(HL)
        EXX
        ADD A,(HL)
        LD (DE),A
        INC E
        JR Z,S22R4
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        DEC LX
        JR Z,S22R2_3
        JP C,S22K2
        JP S22J2

S22G3   LD E,A
        LD A,(DE)
        EXX
        ADD A,(HL)
        LD (DE),A
        INC E
        JR Z,S22R4
S22J0   ADD A,(HL)
        RRA
        LD (DE),A
        INC E
S22H1   LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        DEC LX
        JR Z,S22R2_3
        JP NC,S22J2
S22K2   ADD A,(HL)
        RRA
        LD (DE),A
        INC E
S22L3   LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        JR Z,S22R5
        DEC LX
        JR Z,S22R5
        JP NC,S22K0
        SUB (HL)
        EXX
        JP C,S22G0
        LD L,A
        LD A,(HL)
        EXX
        ADD A,(HL)
        LD (DE),A
        INC E
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        DEC LX
        JR Z,S22R2_3
        JP C,S22K3
        JP S22J3

S22R2_3 JP S22R2

S22R5   JR NC,S22R5_2
        LD C,#02
        SRL B
        RET
        
S22R5_2 LD C,#01
        RRC B
        RET

S22R4   LD C,#01
        SRL B
        RET

S23J0   SUB (HL)
        EXX
        JP C,S23P0
        LD L,A
        LD A,(HL)
        EXX
        ADD A,(HL)
        LD (DE),A
        INC E
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        JP C,S23J3
        JP S23K3

S23P0   LD E,A
        LD A,(DE)
        EXX
        ADD A,(HL)
        LD (DE),A
        INC E
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
S23H2   LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        JP C,S23J3
S23K3   SUB (HL)
        EXX
        JP C,S23I3
        LD L,A
        LD A,(HL)
        EXX
        ADD A,(HL)
        LD (DE),A
        INC E
        JR Z,S23R1
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        JP C,S23K2
        JP S23G2

S23I3   LD E,A
        LD A,(DE)
        EXX
        ADD A,(HL)
        LD (DE),A
        INC E
        JR Z,S23R1
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
S23L1   LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        JP C,S23K2
S23G2   ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        JR Z,S23R2
        JP NC,S23K0
        JP S23J0

S23R1   LD C,#01
        SRL B
        RET
        
S23R2   LD C,#02
        JR NC,S23R2_2
        RRC B
        RET
        
S23R2_2 SRL B
        RET

S23J1   SUB (HL)
        EXX
        JP C,S23P1
        LD L,A
        LD A,(HL)
        EXX
        ADD A,(HL)
        LD (DE),A
        INC E
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        JR Z,S23R2
        JP C,S23J0
        JP S23K0

S23P1   LD E,A
        LD A,(DE)
        EXX
        ADD A,(HL)
        LD (DE),A
        INC E
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
S23H3   LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        JR Z,S23R2
        JP C,S23J0
S23K0   SUB (HL)
        EXX
        JP C,S23I0
        LD L,A
        LD A,(HL)
        EXX
        ADD A,(HL)
        LD (DE),A
        INC E
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        JP C,S23K3
        JP S23G3

S23I0   LD E,A
        LD A,(DE)
        EXX
        ADD A,(HL)
        LD (DE),A
        INC E
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
S23L2   LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        JP C,S23K3
S23G3   ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S23R3
        LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        JP NC,S23K1
        JP S23J1

S23R3   LD C,#00
        RRC B
        RET

S23J2   SUB (HL)
        EXX
        JP C,S23P2
        LD L,A
        LD A,(HL)
        EXX
        ADD A,(HL)
        LD (DE),A
        INC E
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S23R3
        LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        JP C,S23J1
        JP S23K1

S23P2   LD E,A
        LD A,(DE)
        EXX
        ADD A,(HL)
        LD (DE),A
        INC E
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S23R3
S23H0   LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        JP C,S23J1
S23K1   SUB (HL)
        EXX
        JP C,S23I1
        LD L,A
        LD A,(HL)
        EXX
        ADD A,(HL)
        LD (DE),A
        INC E
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        JR Z,S23R4
        JP C,S23K0
        JP S23G0

S23I1   LD E,A
        LD A,(DE)
        EXX
        ADD A,(HL)
        LD (DE),A
        INC E
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
S23L3   LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        JR Z,S23R4
        JP C,S23K0

S23G0   ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        JP NC,S23K2
        JP S23J2

S23R4   JR C,S23R4_2
        LD C,#01
        RRC B
        RET
        
S23R4_2 LD C,#02
        SRL B
        RET

S23R5   LD C,#01
        RRC B
        RET

S23J3   SUB (HL)
        EXX
        JP C,S23P3
        LD L,A
        LD A,(HL)
        EXX
        ADD A,(HL)
        LD (DE),A
        INC E
        JR Z,S23R5
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        JP C,S23J2
        JP S23K2

S23P3   LD E,A
        LD A,(DE)
        EXX
        ADD A,(HL)
        LD (DE),A
        INC E
        JR Z,S23R5
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
S23H1   LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        JP C,S23J2
S23K2   SUB (HL)
        EXX
        JP C,S23I2
        LD L,A
        LD A,(HL)
        EXX
        ADD A,(HL)
        LD (DE),A
        INC E
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S23R6
        LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        JP C,S23K1
        JP S23G1

S23I2   LD E,A
        LD A,(DE)
        EXX
        ADD A,(HL)
        LD (DE),A
        INC E
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S23R6
S23L0   LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        JP C,S23K1
S23G1   ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        JP NC,S23K3
        JP S23J3

S23R6   LD C,#00
        SRL B
        RET

S24J0   SUB (HL)
        EXX
        JP C,S24P0
        LD L,A
        LD A,(HL)
        EXX
        ADD A,(HL)
        LD (DE),A
        INC E
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        DEC LX
        JR Z,S24R2
        JP C,S24J3
        JP S24K3

S24P0   LD E,A
        LD A,(DE)
        EXX
        ADD A,(HL)
        LD (DE),A
        INC E
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
S24H2   LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        DEC LX
        JR Z,S24R2
        JP C,S24J3
S24K3   SUB (HL)
        EXX
        JP C,S24I3
        LD L,A
        LD A,(HL)
        EXX
        ADD A,(HL)
        LD (DE),A
        INC E
        JR Z,S24R1
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        DEC LX
        JR Z,S24R4_3
        JP C,S24K2
        JP S24G2

S24I3   LD E,A
        LD A,(DE)
        EXX
        ADD A,(HL)
        LD (DE),A
        INC E
        JR Z,S24R1
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
S24L1   LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        DEC LX
        JR Z,S24R4_3
        JP C,S24K2

S24G2   ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        JR Z,S24R2
        DEC LX
        JR Z,S24R2
        JP NC,S24K0
        JP S24J0

S24R1   LD C,#01
        SRL B
        RET
        
S24R2   LD C,#02
        JR NC,S24R2_2
        RRC B
        RET
        
S24R2_2 SRL B
        RET

S24R4_3 JP S24R4

S24J1   SUB (HL)
        EXX
        JP C,S24P1
        LD L,A
        LD A,(HL)
        EXX
        ADD A,(HL)
        LD (DE),A
        INC E
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        JR Z,S24R2
        DEC LX
        JR Z,S24R2
        JP C,S24J0
        JP S24K0

S24P1   LD E,A
        LD A,(DE)
        EXX
        ADD A,(HL)
        LD (DE),A
        INC E
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
S24H3   LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        JR Z,S24R2
        DEC LX
        JR Z,S24R2
        JP C,S24J0
S24K0   SUB (HL)
        EXX
        JP C,S24I0
        LD L,A
        LD A,(HL)
        EXX
        ADD A,(HL)
        LD (DE),A
        INC E
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        DEC LX
        JR Z,S24R4_3
        JP C,S24K3
        JP S24G3

S24I0   LD E,A
        LD A,(DE)
        EXX
        ADD A,(HL)
        LD (DE),A
        INC E
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
S24L2   LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        DEC LX
        JR Z,S24R4_3
        JP C,S24K3
S24G3   ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S24R3
        LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        DEC LX
        JR Z,S24R2_5
        JP NC,S24K1
        JP S24J1
        
S24R2_5 JP S24R2

S24R3   LD C,#00
        RRC B
        RET

S24J2   SUB (HL)
        EXX
        JP C,S24P2
        LD L,A
        LD A,(HL)
        EXX
        ADD A,(HL)
        LD (DE),A
        INC E
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S24R3
        LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        DEC LX
        JR Z,S24R2_3
        JP C,S24J1
        JP S24K1

S24P2   LD E,A
        LD A,(DE)
        EXX
        ADD A,(HL)
        LD (DE),A
        INC E
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S24R3
S24H0   LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        DEC LX
        JR Z,S24R2_3
        JP C,S24J1
S24K1   SUB (HL)
        EXX
        JP C,S24I1
        LD L,A
        LD A,(HL)
        EXX
        ADD A,(HL)
        LD (DE),A
        INC E
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        JR Z,S24R4
        DEC LX
        JR Z,S24R4
        JP C,S24K0
        JP S24G0

S24I1   LD E,A
        LD A,(DE)
        EXX
        ADD A,(HL)
        LD (DE),A
        INC E
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
S24L3   LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        JR Z,S24R4
        DEC LX
        JR Z,S24R4
        JP C,S24K0

S24G0   ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        DEC LX
        JR Z,S24R2_3
        JP NC,S24K2
        JP S24J2

S24R4   JR C,S24R4_2
        LD C,#01
        RRC B
        RET
        
S24R4_2 LD C,#02
        SRL B
        RET
        
S24R2_3 JP S24R2

S24R5   LD C,#01
        RRC B
        RET

S24J3   SUB (HL)
        EXX
        JP C,S24P3
        LD L,A
        LD A,(HL)
        EXX
        ADD A,(HL)
        LD (DE),A
        INC E
        JR Z,S24R5
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        DEC LX
        JR Z,S24R2_3
        JP C,S24J2
        JP S24K2

S24P3   LD E,A
        LD A,(DE)
        EXX
        ADD A,(HL)
        LD (DE),A
        INC E
        JR Z,S24R5
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
S24H1   LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        DEC LX
        JR Z,S24R2_3
        JP C,S24J2
S24K2   SUB (HL)
        EXX
        JP C,S24I2
        LD L,A
        LD A,(HL)
        EXX
        ADD A,(HL)
        LD (DE),A
        INC E
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S24R6
        LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        DEC LX
        JR Z,S24R4
        JP C,S24K1
        JP S24G1

S24I2   LD E,A
        LD A,(DE)
        EXX
        ADD A,(HL)
        LD (DE),A
        INC E
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S24R6
S24L0   LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        DEC LX
        JR Z,S24R4_4
        JP C,S24K1
S24G1   ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        LD A,B
        ADD A,C
        LD B,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        DEC LX
        JR Z,S24R2_4
        JP NC,S24K3
        JP S24J3
        
S24R2_4 JP S24R2

S24R4_4 JP S24R4

S24R6   LD C,#00
        SRL B
        RET

;INCLUDE "SGEN3.a80"
S3_     LD D,C
        PUSH DE
        LD D,B
        EXX
        POP BC
S31     SLA B
        JP C,S318

S310    LD A,LX
        ADD A,A
        JP C,S311
        ADD A,LX
        JP C,S311
        ADD A,E
        JR Z,S310_
        JP C,S311
        BIT 7,B
        JR Z,S310_
        LD LY,A
        LD A,LX
        SRL A
        SRL A
        ADD A,LY
        JR Z,S310_
        JP C,S311
S310_   SLI C
        JP C,S3101
        JP S3100

S3102   JR Z,S3104
S310A   INC E
        JR Z,S3105
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S31052
        LD (DE),A
        INC E
        JR Z,S31053
S3100   LD A,C
        ADD A,B
        LD C,A
        LD A,(HL)
        INC HL
        DEC LX
        LD (DE),A
        JP NC,S3102
        JR Z,S3106
        INC E
        JR Z,S3107
        LD LY,A
        ADD A,(HL)
        RRA
        LD HY,A
        ADD A,LY
        RRA
        LD (DE),A
        INC E
        JR Z,S3109
        LD A,HY
        LD (DE),A
        INC E
        JR Z,S31092
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JP NZ,S3101
        JP S31093

S3103   JR Z,S3108
        INC E
        JR Z,S3109
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S31092
        LD (DE),A
        INC E
        JR Z,S31093
S3101   LD A,C
        ADD A,B
        LD C,A
        LD A,(HL)
        INC HL
        DEC LX
        LD (DE),A
        JP NC,S3103
        JP NZ,S310A
S3104   INC E
S3105   SRL C
        LD LY,C
        EXX
        LD E,LY
        LD D,2
        RET
        
S31052  SRL C
        LD LY,C
        EXX
        LD E,LY
        LD D,1
        RET
        
S31053  SRL C
        LD LY,C
        EXX
        LD E,LY
        LD D,0
        RET
        
S3106   INC E
S3107   RRC C
        LD LY,C
        EXX
        LD E,LY
        RET
        
S3108   INC E
S3109   RRC C
        LD LY,C
        EXX
        LD E,LY
        DEC D
        RET
        
S31092  RRC C
        LD LY,C
        EXX
        LD E,LY
        LD D,1
        RET
        
S31093  RRC C
        LD LY,C
        EXX
        LD E,LY
        LD D,0
        RET

S311    SLI C
        JP C,S3111
        JR S3110

S3112   JR Z,S3114
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S31141
        LD (DE),A
        INC E
        JR Z,S31142
S3110   LD A,C
        ADD A,B
        LD C,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        JP NC,S3112
        JR Z,S3115
        LD LY,A
        ADD A,(HL)
        RRA
        LD HY,A
        ADD A,LY
        RRA
        LD (DE),A
        INC E
        JR Z,S31151
        LD A,HY
        LD (DE),A
        INC E
        JR Z,S3116
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JP NZ,S3111
        JP S31162

S3113   JR Z,S31151
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S3116
        LD (DE),A
        INC E
        JR Z,S31162
S3111   LD A,C
        ADD A,B
        LD C,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        JP NC,S3113
        JP NZ,S3112
        SRL C
        LD LY,C
        EXX
        LD E,LY
        LD D,2
        RET
        
S31141  SRL C
        LD LY,C
        EXX
        LD E,LY
        LD D,1
        RET
        
S31142  SRL C
        LD LY,C
        EXX
        LD E,LY
        LD D,0
        RET
        
S3114   SRL C
        LD LY,C
        EXX
        LD E,LY
        LD D,2
        RET
        
S3115   RRC C
        LD LY,C
        EXX
        LD E,LY
        RET
        
S31151  RRC C
        LD LY,C
        EXX
        LD E,LY
        DEC D
        RET
        
S3116   RRC C
        LD LY,C
        EXX
        LD E,LY
        LD D,1
        RET
        
S31162  RRC C
        LD LY,C
        EXX
        LD E,LY
        LD D,0
        RET

S318    LD A,LX
        ADD A,A
        JP C,S319
        ADD A,LX
        JP C,S319
        LD LY,A
        LD A,LX
        SRL A
        ADD A,LY
        JP C,S319
        ADD A,E
        JR Z,S318_
        JP C,S319
        BIT 7,B
        JR Z,S318_
        LD LY,A
        LD A,LX
        SRL A
        SRL A
        ADD A,LY
        JR Z,S318_
        JP C,S319
S318_   SLI C
        JP NC,S3180
        JP S3181

S3184   INC E
S3185   RRC C
        LD LY,C
        EXX
        LD E,LY
        RET

S3182   JR Z,S3184
        INC E
S31822  JR Z,S3185
S318222 LD LY,A
        ADD A,(HL)
        RRA
        LD HY,A
        ADD A,LY
        RRA
        LD (DE),A
        INC E
        JR Z,S3186
        LD A,HY
        LD (DE),A
        INC E
        JR Z,S31866
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S31867
S3181   LD A,C
        ADD A,B
        LD C,A
        LD A,(HL)
        INC HL
        DEC LX
        LD (DE),A
        JP C,S3182
        JR Z,S31871
        INC E
        JR Z,S31891
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S3189
        LD (DE),A
        INC E
        JP NZ,S3180
        JP S31892
        
S31871  INC E
S31891  SRL C
        LD LY,C
        EXX
        LD E,LY
        DEC D
        RET

S3183   JR Z,S3187
        INC E
        JR Z,S3188
        LD LY,A
        ADD A,(HL)
        RRA
        LD HY,A
        ADD A,LY
        RRA
        LD (DE),A
        INC E
        JR Z,S31891
        LD A,HY
        LD (DE),A
        INC E
        JR Z,S3189
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S31892
S3180   LD A,C
        ADD A,B
        LD C,A
        LD A,(HL)
        INC HL
        DEC LX
        LD (DE),A
        JP C,S3183
        JR Z,S31844
        INC E
        JP NZ,S318222
        RRC C
        LD LY,C
        EXX
        LD E,LY
        RET
        
S3186   RRC C
        LD LY,C
        EXX
        LD E,LY
        DEC D
        RET
        
S31866  RRC C
        LD LY,C
        EXX
        LD E,LY
        DEC D
        DEC D
        RET
        
S31867  RRC C
        LD LY,C
        EXX
        LD E,LY
        DEC D
        DEC D
        DEC D
        RET

S31844  INC E
        RRC C
        LD LY,C
        EXX
        LD E,LY
        RET

S3187   INC E
S3188   SRL C
        LD LY,C
        EXX
        LD E,LY
        RET
        
S3189   SRL C
        LD LY,C
        EXX
        LD E,LY
        DEC D
        DEC D
        RET
        
S31892  SRL C
        LD LY,C
        EXX
        LD E,LY
        DEC D
        DEC D
        DEC D
        RET

S319    SLI C
        JP NC,S3190
        JP S3191

S3195   RRC C
        LD LY,C
        EXX
        LD E,LY
        RET

S3192   JR Z,S3195
        LD LY,A
        ADD A,(HL)
        RRA
        LD HY,A
        ADD A,LY
        RRA
        LD (DE),A
        INC E
        JR Z,S3196
        LD A,HY
        LD (DE),A
        INC E
        JR Z,S31966
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S31967
S3191   LD A,C
        ADD A,B
        LD C,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        JP C,S3192
        JR Z,S3199
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S31993
        LD (DE),A
        INC E
        JP NZ,S3190
        JP S31994

S3193   JR Z,S3198
        LD LY,A
        ADD A,(HL)
        RRA
        LD HY,A
        ADD A,LY
        RRA
        LD (DE),A
        INC E
        JR Z,S3199
S31933  LD A,HY
        LD (DE),A
        INC E
        JR Z,S31993
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S31994
S3190   LD A,C
        ADD A,B
        LD C,A
        LD A,(HL)
        INC HL
        LD (DE),A
        INC E
        JP C,S3193
        JP NZ,S3192
        RRC C
        LD LY,C
        EXX
        LD E,LY
        RET
        
S3196   RRC C
        LD LY,C
        EXX
        LD E,LY
        DEC D
        RET
        
S31966  RRC C
        LD LY,C
        EXX
        LD E,LY
        DEC D
        DEC D
        RET
        
S31967  RRC C
        LD LY,C
        EXX
        LD E,LY
        DEC D
        DEC D
        DEC D
        RET

S3198   SRL C
        LD LY,C
        EXX
        LD E,LY
        RET
        
S3199   SRL C
        LD LY,C
        EXX
        LD E,LY
        DEC D
        RET
        
S31993  SRL C
        LD LY,C
        EXX
        LD E,LY
        DEC D
        DEC D
        RET
        
S31994  SRL C
        LD LY,C
        EXX
        LD E,LY
        DEC D
        DEC D
        DEC D
        RET

;INCLUDE "SGEN4.a80"
S4_     LD D,C
        PUSH DE
        LD D,B
        EXX
        POP BC
S41     SLA B
        JP C,S418
        SLI C
        LD HY,B
        JP C,S4101
        JP S4100

S4102   JR Z,S4104
S410A   INC E
        JR Z,S4105
        LD B,A
        ADD A,(HL)
        RRA
        LD LY,A
        ADD A,B
        RRA
        LD (DE),A
        INC E
        JR Z,S41052
        LD A,LY
        LD (DE),A
        INC E
        JR Z,S41053
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S41054
S4100   LD A,C
        ADD A,HY
        LD C,A
        LD A,(HL)
        INC HL
        DEC LX
        LD (DE),A
        JP NC,S4102
        JR Z,S4106
        INC E
        JR Z,S4107
        LD (DE),A
        INC E
        JP NZ,S41033
        JP S4109
S4103   JR Z,S4108
        INC E
        JR Z,S4109
S41033  LD B,A
        ADD A,(HL)
        RRA
        LD LY,A
        ADD A,B
        RRA
        LD (DE),A
        INC E
        JR Z,S41092
        LD A,LY
        LD (DE),A
        INC E
        JR Z,S41093
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S41094
S4101   LD A,C
        ADD A,HY
        LD C,A
        LD A,(HL)
        INC HL
        DEC LX
        LD (DE),A
        JP NC,S4103
        JP NZ,S410A
S4104   INC E
S4105   SRL C
        LD LY,C
        EXX
        LD E,LY
        LD D,3
        RET
        
S41052  SRL C
        LD LY,C
        EXX
        LD E,LY
        LD D,2
        RET
        
S41053  SRL C
        LD LY,C
        EXX
        LD E,LY
        LD D,1
        RET
        
S41054  SRL C
        LD LY,C
        EXX
        LD E,LY
        LD D,0
        RET
        
S4106   INC E
S4107   RRC C
        LD LY,C
        EXX
        LD E,LY
        RET
        
S4108   INC E
S4109   RRC C
        LD LY,C
        EXX
        LD E,LY
        LD D,3
        RET
        
S41092  RRC C
        LD LY,C
        EXX
        LD E,LY
        LD D,2
        RET
        
S41093  RRC C
        LD LY,C
        EXX
        LD E,LY
        LD D,1
        RET
        
S41094  RRC C
        LD LY,C
        EXX
        LD E,LY
        LD D,0
        RET

S418    SLI C
        JP NC,S4180
        JP S4181

S4184   INC E
S4185   RRC C
        LD LY,C
        EXX
        LD E,LY
        RET
        
S41844  INC E
        RRC C
        LD LY,C
        EXX
        LD E,LY
        RET

S4182   JR Z,S4184
        INC E
S41822  JR Z,S4185
S418222 LD (DE),A
        INC E
        JR Z,S4186
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S41866
        LD (DE),A
        INC E
        JR Z,S41867
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S41868
S4181   LD A,C
        ADD A,B
        LD C,A
        LD A,(HL)
        INC HL
        DEC LX
        LD (DE),A
        JP C,S4182
        JR Z,S41871
        JP S41831
S4183   JR Z,S4187
        INC E
        JR Z,S4188
        LD (DE),A
S41831  INC E
        JR Z,S4189
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S41891
        LD (DE),A
        INC E
        JR Z,S41892
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S41893
S4180   LD A,C
        ADD A,B
        LD C,A
        LD A,(HL)
        INC HL
        DEC LX
        LD (DE),A
        JP C,S4183
        JR Z,S41844
        INC E
        JP NZ,S418222
        RRC C
        LD LY,C
        EXX
        LD E,LY
        RET
        
S4186   RRC C
        LD LY,C
        EXX
        LD E,LY
        LD D,3
        RET
        
S41866  RRC C
        LD LY,C
        EXX
        LD E,LY
        LD D,2
        RET
        
S41867  RRC C
        LD LY,C
        EXX
        LD E,LY
        LD D,1
        RET
        
S41868  RRC C
        LD LY,C
        EXX
        LD E,LY
        LD D,0
        RET

S4187   INC E
S4188   SRL C
        LD LY,C
        EXX
        LD E,LY
        RET
        
S4189   SRL C
        LD LY,C
        EXX
        LD E,LY
        LD D,3
        RET
        
S41871  INC E
S41891  SRL C
        LD LY,C
        EXX
        LD E,LY
        LD D,2
        RET
        
S41892  SRL C
        LD LY,C
        EXX
        LD E,LY
        LD D,1
        RET
        
S41893  SRL C
        LD LY,C
        EXX
        LD E,LY
        LD D,0
        RET

;INCLUDE "SGEN5.a80"
S5_     LD D,C
        PUSH DE
        LD D,B
        EXX
        POP BC
S51     SLA B
        JP C,S518
        SLI C
        JP C,S5101
        JP S5100

S5102   JR Z,S5104
S510A   INC E
        JR Z,S5105
        LD LY,A
        ADD A,(HL)
        RRA
        LD HY,A
        ADD A,LY
        RRA
        LD (DE),A
        INC E
        JR Z,S51052
        LD A,HY
        LD (DE),A
        INC E
        JR Z,S51053
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S51054
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S51055
S5100   LD A,C
        ADD A,B
        LD C,A
        LD A,(HL)
        INC HL
        DEC LX
        LD (DE),A
        JP NC,S5102
        JR Z,S5106
        INC E
        JR Z,S5107
        LD (DE),A
        DEC E
        INC E
S5103   JR Z,S5108
        INC E
        JR Z,S5109
        LD LY,A
        ADD A,(HL)
        RRA
        LD HY,A
        ADD A,LY
        RRA
        LD (DE),A
        INC E
        JR Z,S51092
        LD A,HY
        LD (DE),A
        INC E
        JR Z,S51093
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S51094
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S51095
S5101   LD A,C
        ADD A,B
        LD C,A
        LD A,(HL)
        INC HL
        DEC LX
        LD (DE),A
        JP NC,S5103
        JP NZ,S510A
S5104   INC E
S5105   SRL C
        LD LY,C
        EXX
        LD E,LY
        LD D,4
        RET
        
S51052  SRL C
        LD LY,C
        EXX
        LD E,LY
        LD D,3
        RET
        
S51053  SRL C
        LD LY,C
        EXX
        LD E,LY
        LD D,2
        RET
        
S51054  SRL C
        LD LY,C
        EXX
        LD E,LY
        LD D,1
        RET
        
S51055  SRL C
        LD LY,C
        EXX
        LD E,LY
        LD D,0
        RET
        
S5106   INC E
S5107   RRC C
        LD LY,C
        EXX
        LD E,LY
        RET
        
S5108   INC E
S5109   RRC C
        LD LY,C
        EXX
        LD E,LY
        LD D,4
        RET
        
S51092  RRC C
        LD LY,C
        EXX
        LD E,LY
        LD D,3
        RET
        
S51093  RRC C
        LD LY,C
        EXX
        LD E,LY
        LD D,2
        RET
        
S51094  RRC C
        LD LY,C
        EXX
        LD E,LY
        LD D,1
        RET
        
S51095  RRC C
        LD LY,C
        EXX
        LD E,LY
        LD D,0
        RET

S518    SLI C
        JP NC,S5180
        JP S5181

S5184   INC E
S5185   RRC C
        LD LY,C
        EXX
        LD E,LY
        RET
        
S5186   RRC C
        LD LY,C
        EXX
        LD E,LY
        LD D,4
        RET
        
S51866  RRC C
        LD LY,C
        EXX
        LD E,LY
        LD D,3
        RET
        
S51867  RRC C
        LD LY,C
        EXX
        LD E,LY
        LD D,2
        RET
        
S51868  RRC C
        LD LY,C
        EXX
        LD E,LY
        LD D,1
        RET
        
S51869  RRC C
        LD LY,C
        EXX
        LD E,LY
        LD D,0
        RET

S5182   JR Z,S5184
        INC E
S51822  JR Z,S5185
S518222 LD LY,A
        ADD A,(HL)
        RRA
        LD HY,A
        ADD A,LY
        RRA
        LD (DE),A
        INC E
        JR Z,S5186
        ADD A,HY
        RRA
        LD (DE),A
        INC E
        JR Z,S51866
        LD A,HY
        LD (DE),A
        INC E
        JR Z,S51867
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S51868
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S51869
S5181   LD A,C
        ADD A,B
        LD C,A
        LD A,(HL)
        INC HL
        DEC LX
        LD (DE),A
        JP C,S5182
        JR Z,S51871
        JP S51831
S5183   JR Z,S5187
        INC E
        JR Z,S5188
        LD (DE),A
S51831  INC E
        JR Z,S5189
        LD LY,A
        ADD A,(HL)
        RRA
        LD HY,A
        ADD A,LY
        RRA
        LD (DE),A
        INC E
        JR Z,S51891
        LD A,HY
        LD (DE),A
        INC E
        JR Z,S51892
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S51893
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S51894
S5180   LD A,C
        ADD A,B
        LD C,A
        LD A,(HL)
        INC HL
        DEC LX
        LD (DE),A
        JP C,S5183
        JR Z,S51844
        INC E
        JP NZ,S518222
        RRC C
        LD LY,C
        EXX
        LD E,LY
        RET

S51844  INC E
        RRC C
        LD LY,C
        EXX
        LD E,LY
        RET

S5187   INC E
S5188   SRL C
        LD LY,C
        EXX
        LD E,LY
        RET
        
S5189   SRL C
        LD LY,C
        EXX
        LD E,LY
        LD D,4
        RET
        
S51871  INC E
S51891  SRL C
        LD LY,C
        EXX
        LD E,LY
        LD D,3
        RET
        
S51892  SRL C
        LD LY,C
        EXX
        LD E,LY
        LD D,2
        RET
        
S51893  SRL C
        LD LY,C
        EXX
        LD E,LY
        LD D,1
        RET
        
S51894  SRL C
        LD LY,C
        EXX
        LD E,LY
        LD D,0
        RET

;INCLUDE "SGEN6.a80"
S6_     LD D,C
        PUSH DE
        LD D,B
        EXX
        POP BC
S61     SLA B
        JP C,S618
        SLI C
        JP C,S6101
        JP S6100

S61052  SRL C
        LD LY,C
        EXX
        LD E,LY
        LD D,4
        RET
        
S61053  SRL C
        LD LY,C
        EXX
        LD E,LY
        LD D,3
        RET
        
S61054  SRL C
        LD LY,C
        EXX
        LD E,LY
        LD D,2
        RET
        
S61055  SRL C
        LD LY,C
        EXX
        LD E,LY
        LD D,1
        RET
        
S61056  SRL C
        LD LY,C
        EXX
        LD E,LY
        LD D,0
        RET

S6102   JR Z,S6104
S610A   INC E
        JR Z,S6105
        LD LY,A
        ADD A,(HL)
        RRA
        LD HY,A
        ADD A,LY
        RRA
        LD (DE),A
        INC E
        JR Z,S61052
        ADD A,HY
        RRA
        LD (DE),A
        INC E
        JR Z,S61053
        LD A,HY
        LD (DE),A
        INC E
        JR Z,S61054
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S61055
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S61056
S6100   LD A,C
        ADD A,B
        LD C,A
        LD A,(HL)
        INC HL
        DEC LX
        LD (DE),A
        JP NC,S6102
        JR Z,S6106
        INC E
        JR Z,S6107
        LD (DE),A
        DEC E
        INC E
S6103   JR Z,S6108
        INC E
        JR Z,S6109
        LD LY,A
        ADD A,(HL)
        RRA
        LD HY,A
        ADD A,LY
        RRA
        LD (DE),A
        INC E
        JR Z,S61092
        ADD A,HY
        RRA
        LD (DE),A
        INC E
        JR Z,S61093
        LD A,HY
        LD (DE),A
        INC E
        JR Z,S61094
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S61095
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S61096
S6101   LD A,C
        ADD A,B
        LD C,A
        LD A,(HL)
        INC HL
        DEC LX
        LD (DE),A
        JP NC,S6103
        JP NZ,S610A
S6104   INC E
S6105   SRL C
        LD LY,C
        EXX
        LD E,LY
        LD D,5
        RET
        
S6106   INC E
S6107   RRC C
        LD LY,C
        EXX
        LD E,LY
        RET
        
S6108   INC E
S6109   RRC C
        LD LY,C
        EXX
        LD E,LY
        LD D,5
        RET
        
S61092  RRC C
        LD LY,C
        EXX
        LD E,LY
        LD D,4
        RET
        
S61093  RRC C
        LD LY,C
        EXX
        LD E,LY
        LD D,3
        RET
        
S61094  RRC C
        LD LY,C
        EXX
        LD E,LY
        LD D,2
        RET
        
S61095  RRC C
        LD LY,C
        EXX
        LD E,LY
        LD D,1
        RET
        
S61096  RRC C
        LD LY,C
        EXX
        LD E,LY
        LD D,0
        RET

S618    SLI C
        JP NC,S6180
        JP S6181

S6184   INC E
S6185   RRC C
        LD LY,C
        EXX
        LD E,LY
        RET
        
S6186   RRC C
        LD LY,C
        EXX
        LD E,LY
        LD D,5
        RET
        
S61866  RRC C
        LD LY,C
        EXX
        LD E,LY
        LD D,4
        RET
        
S61867  RRC C
        LD LY,C
        EXX
        LD E,LY
        LD D,3
        RET
        
S61868  RRC C
        LD LY,C
        EXX
        LD E,LY
        LD D,2
        RET
        
S61869  RRC C
        LD LY,C
        EXX
        LD E,LY
        LD D,1
        RET
        
S6186A  RRC C
        LD LY,C
        EXX
        LD E,LY
        LD D,0
        RET

S6182   JR Z,S6184
        INC E
S61822  JR Z,S6185
S618222 LD (DE),A
        INC E
        JR Z,S6186
        LD LY,A
        ADD A,(HL)
        RRA
        LD HY,A
        ADD A,LY
        RRA
        LD (DE),A
        INC E
        JR Z,S61866
        ADD A,HY
        RRA
        LD (DE),A
        INC E
        JR Z,S61867
        LD A,HY
        LD (DE),A
        INC E
        JR Z,S61868
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S61869
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S6186A
S6181   LD A,C
        ADD A,B
        LD C,A
        LD A,(HL)
        INC HL
        DEC LX
        LD (DE),A
        JP C,S6182
        JR Z,S61871
        JP S61831
S6183   JR Z,S6187
        INC E
        JR Z,S6188
        LD (DE),A
S61831  INC E
        JR Z,S6189
        LD LY,A
        ADD A,(HL)
        RRA
        LD HY,A
        ADD A,LY
        RRA
        LD (DE),A
        INC E
        JR Z,S61891
        ADD A,HY
        RRA
        LD (DE),A
        INC E
        JR Z,S61892
        LD A,HY
        LD (DE),A
        INC E
        JR Z,S61893
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S61894
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S61895
S6180   LD A,C
        ADD A,B
        LD C,A
        LD A,(HL)
        INC HL
        DEC LX
        LD (DE),A
        JP C,S6183
        JR Z,S61844
        INC E
        JP NZ,S618222
        RRC C
        LD LY,C
        EXX
        LD E,LY
        RET

S61844  INC E
        RRC C
        LD LY,C
        EXX
        LD E,LY
        RET

S6187   INC E
S6188   SRL C
        LD LY,C
        EXX
        LD E,LY
        RET
        
S6189    SRL C
        LD LY,C
        EXX
        LD E,LY
        LD D,5
        RET

S61871  INC E
S61891  SRL C
        LD LY,C
        EXX
        LD E,LY
        LD D,4
        RET
        
S61892  SRL C
        LD LY,C
        EXX
        LD E,LY
        LD D,3
        RET
        
S61893  SRL C
        LD LY,C
        EXX
        LD E,LY
        LD D,2
        RET
        
S61894  SRL C
        LD LY,C
        EXX
        LD E,LY
        LD D,1
        RET
        
S61895  SRL C
        LD LY,C
        EXX
        LD E,LY
        LD D,0
        RET

;INCLUDE "SGEN7.a80"
S7_     LD D,C
        PUSH DE
        LD D,B
        EXX
        POP BC
S71     SLA B
        JP C,S718
        SLI C
        JP C,S7101
        JP S7100

S71052  SRL C
        LD LY,C
        EXX
        LD E,LY
        LD D,5
        RET
        
S71053  SRL C
        LD LY,C
        EXX
        LD E,LY
        LD D,4
        RET
        
S71054  SRL C
        LD LY,C
        EXX
        LD E,LY
        LD D,3
        RET
        
S71055  SRL C
        LD LY,C
        EXX
        LD E,LY
        LD D,2
        RET
        
S71056  SRL C
        LD LY,C
        EXX
        LD E,LY
        LD D,1
        RET
        
S71057  SRL C
        LD LY,C
        EXX
        LD E,LY
        LD D,0
        RET

S7102   JR Z,S7104
S710A   INC E
        JR Z,S7105
        LD (DE),A
        INC E
        JR Z,S71052
        LD LY,A
        ADD A,(HL)
        RRA
        LD HY,A
        ADD A,LY
        RRA
        LD (DE),A
        INC E
        JR Z,S71053
        ADD A,HY
        RRA
        LD (DE),A
        INC E
        JR Z,S71054
        LD A,HY
        LD (DE),A
        INC E
        JR Z,S71055
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S71056
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S71057
S7100   LD A,C
        ADD A,B
        LD C,A
        LD A,(HL)
        INC HL
        DEC LX
        LD (DE),A
        JP NC,S7102
        JR Z,S7106
        INC E
        JR Z,S7107
        LD (DE),A
        DEC E
        INC E
S7103   JR Z,S7108
        INC E
        JR Z,S7109
        LD (DE),A
        INC E
        JR Z,S71092
        LD LY,A
        ADD A,(HL)
        RRA
        LD HY,A
        ADD A,LY
        RRA
        LD (DE),A
        INC E
        JR Z,S71093
        ADD A,HY
        RRA
        LD (DE),A
        INC E
        JR Z,S71094
        LD A,HY
        LD (DE),A
        INC E
        JR Z,S71095
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S71096
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S71097
S7101   LD A,C
        ADD A,B
        LD C,A
        LD A,(HL)
        INC HL
        DEC LX
        LD (DE),A
        JP NC,S7103
        JP NZ,S710A
S7104   INC E
S7105   SRL C
        LD LY,C
        EXX
        LD E,LY
        LD D,6
        RET
        
S7106   INC E
S7107   RRC C
        LD LY,C
        EXX
        LD E,LY
        RET
        
S7108   INC E
S7109   RRC C
        LD LY,C
        EXX
        LD E,LY
        LD D,6
        RET
        
S71092  RRC C
        LD LY,C
        EXX
        LD E,LY
        LD D,5
        RET
        
S71093  RRC C
        LD LY,C
        EXX
        LD E,LY
        LD D,4
        RET
        
S71094  RRC C
        LD LY,C
        EXX
        LD E,LY
        LD D,3
        RET
        
S71095  RRC C
        LD LY,C
        EXX
        LD E,LY
        LD D,2
        RET
        
S71096  RRC C
        LD LY,C
        EXX
        LD E,LY
        LD D,1
        RET
        
S71097  RRC C
        LD LY,C
        EXX
        LD E,LY
        LD D,0
        RET

S718    SLI C
        JP NC,S7180
        JP S7181

S7184   INC E
S7185   RRC C
        LD LY,C
        EXX
        LD E,LY
        RET
        
S7186   RRC C
        LD LY,C
        EXX
        LD E,LY
        LD D,6
        RET
        
S71866  RRC C
        LD LY,C
        EXX
        LD E,LY
        LD D,5
        RET
        
S71867  RRC C
        LD LY,C
        EXX
        LD E,LY
        LD D,4
        RET
        
S71868  RRC C
        LD LY,C
        EXX
        LD E,LY
        LD D,3
        RET
        
S71869  RRC C
        LD LY,C
        EXX
        LD E,LY
        LD D,2
        RET
        
S7186A  RRC C
        LD LY,C
        EXX
        LD E,LY
        LD D,1
        RET
        
S7186B  RRC C
        LD LY,C
        EXX
        LD E,LY
        LD D,0
        RET

S7182   JR Z,S7184
        INC E
S71822  JR Z,S7185
S718222 LD (DE),A
        INC E
        JR Z,S7186
        LD LY,A
        ADD A,(HL)
        RRA
        LD HY,A
        ADD A,LY
        RRA
        LD (DE),A
        INC E
        JR Z,S71866
        ADD A,HY
        RRA
        LD (DE),A
        INC E
        JR Z,S71867
        LD A,HY
        LD (DE),A
        INC E
        JR Z,S71868
        LD (DE),A
        INC E
        JR Z,S71869
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S7186A
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S7186B
S7181   LD A,C
        ADD A,B
        LD C,A
        LD A,(HL)
        INC HL
        DEC LX
        LD (DE),A
        JP C,S7182
        JR Z,S71871
        JP S71831
S7183   JR Z,S7187
        INC E
        JR Z,S7188
        LD (DE),A
S71831  INC E
        JR Z,S7189
        LD LY,A
        ADD A,(HL)
        RRA
        LD HY,A
        ADD A,LY
        RRA
        LD (DE),A
        INC E
        JR Z,S71891
        ADD A,HY
        RRA
        LD (DE),A
        INC E
        JR Z,S71892
        LD A,HY
        LD (DE),A
        INC E
        JR Z,S71893
        LD (DE),A
        INC E
        JR Z,S71894
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S71895
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S71896
S7180   LD A,C
        ADD A,B
        LD C,A
        LD A,(HL)
        INC HL
        DEC LX
        LD (DE),A
        JP C,S7183
        JR Z,S71844
        INC E
        JP NZ,S718222
        RRC C
        LD LY,C
        EXX
        LD E,LY
        RET

S71844  INC E
        RRC C
        LD LY,C
        EXX
        LD E,LY
        RET

S7187   INC E
S7188   SRL C
        LD LY,C
        EXX
        LD E,LY
        RET
        
S7189   SRL C
        LD LY,C
        EXX
        LD E,LY
        LD D,6
        RET
        
S71871  INC E
S71891  SRL C
        LD LY,C
        EXX
        LD E,LY
        LD D,5
        RET
        
S71892  SRL C
        LD LY,C
        EXX
        LD E,LY
        LD D,4
        RET
        
S71893  SRL C
        LD LY,C
        EXX
        LD E,LY
        LD D,3
        RET
        
S71894  SRL C
        LD LY,C
        EXX
        LD E,LY
        LD D,2
        RET
        
S71895  SRL C
        LD LY,C
        EXX
        LD E,LY
        LD D,1
        RET
        
S71896  SRL C
        LD LY,C
        EXX
        LD E,LY
        LD D,0
        RET

;INCLUDE "SGEN8.a80"
S8_     LD D,C
        PUSH DE
        LD D,B
        EXX
        POP BC
S81     SLA B
        JP C,S818
        SLI C
        JP C,S8101
        JP S8100

S81052  SRL C
        LD LY,C
        EXX
        LD E,LY
        LD D,6
        RET
        
S81053  SRL C
        LD LY,C
        EXX
        LD E,LY
        LD D,5
        RET
        
S81054  SRL C
        LD LY,C
        EXX
        LD E,LY
        LD D,4
        RET
        
S81055  SRL C
        LD LY,C
        EXX
        LD E,LY
        LD D,3
        RET
        
S81056  SRL C
        LD LY,C
        EXX
        LD E,LY
        LD D,2
        RET
        
S81057  SRL C
        LD LY,C
        EXX
        LD E,LY
        LD D,1
        RET
        
S81058  SRL C
        LD LY,C
        EXX
        LD E,LY
        LD D,0
        RET

S8102   JP Z,S8104
S810A   INC E
        JP Z,S8105
        LD (DE),A
        INC E
        JR Z,S81052
        LD LY,A
        ADD A,(HL)
        RRA
        LD HY,A
        ADD A,LY
        RRA
        LD (DE),A
        INC E
        JR Z,S81053
        ADD A,HY
        RRA
        LD (DE),A
        INC E
        JR Z,S81054
        LD A,HY
        LD (DE),A
        INC E
        JR Z,S81055
        LD (DE),A
        INC E
        JR Z,S81056
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S81057
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S81058
S8100   LD A,C
        ADD A,B
        LD C,A
        LD A,(HL)
        INC HL
        DEC LX
        LD (DE),A
        JP NC,S8102
        JR Z,S8106
        INC E
        JR Z,S8107
        LD (DE),A
        DEC E
        INC E
S8103   JR Z,S8108
        INC E
        JR Z,S8109
        LD (DE),A
        INC E
        JR Z,S81092
        LD LY,A
        ADD A,(HL)
        RRA
        LD HY,A
        ADD A,LY
        RRA
        LD (DE),A
        INC E
        JR Z,S81093
        ADD A,HY
        RRA
        LD (DE),A
        INC E
        JR Z,S81094
        LD A,HY
        LD (DE),A
        INC E
        JR Z,S81095
        LD (DE),A
        INC E
        JR Z,S81096
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S81097
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S81098
S8101   LD A,C
        ADD A,B
        LD C,A
        LD A,(HL)
        INC HL
        DEC LX
        LD (DE),A
        JP NC,S8103
        JP NZ,S810A
S8104   INC E
S8105   SRL C
        LD LY,C
        EXX
        LD E,LY
        LD D,7
        RET
        
S8106   INC E
S8107   RRC C
        LD LY,C
        EXX
        LD E,LY
        RET
        
S8108   INC E
S8109   RRC C
        LD LY,C
        EXX
        LD E,LY
        LD D,7
        RET
        
S81092  RRC C
        LD LY,C
        EXX
        LD E,LY
        LD D,6
        RET
        
S81093  RRC C
        LD LY,C
        EXX
        LD E,LY
        LD D,5
        RET
        
S81094  RRC C
        LD LY,C
        EXX
        LD E,LY
        LD D,4
        RET
        
S81095  RRC C
        LD LY,C
        EXX
        LD E,LY
        LD D,3
        RET
        
S81096  RRC C
        LD LY,C
        EXX
        LD E,LY
        LD D,2
        RET
        
S81097  RRC C
        LD LY,C
        EXX
        LD E,LY
        LD D,1
        RET
        
S81098  RRC C
        LD LY,C
        EXX
        LD E,LY
        LD D,0
        RET

S818    SLI C
        JP NC,S8180
        JP S8181

S8184   INC E
S8185   RRC C
        LD LY,C
        EXX
        LD E,LY
        RET
        
S8186   RRC C
        LD LY,C
        EXX
        LD E,LY
        LD D,7
        RET
        
S81866  RRC C
        LD LY,C
        EXX
        LD E,LY
        LD D,6
        RET
        
S81867  RRC C
        LD LY,C
        EXX
        LD E,LY
        LD D,5
        RET
        
S81868  RRC C
        LD LY,C
        EXX
        LD E,LY
        LD D,4
        RET
        
S81869  RRC C
        LD LY,C
        EXX
        LD E,LY
        LD D,3
        RET
        
S8186A  RRC C
        LD LY,C
        EXX
        LD E,LY
        LD D,2
        RET
        
S8186B  RRC C
        LD LY,C
        EXX
        LD E,LY
        LD D,1
        RET
        
S8186C  RRC C
        LD LY,C
        EXX
        LD E,LY
        LD D,0
        RET

S8182   JR Z,S8184
        INC E
S81822  JR Z,S8185
S818222 LD (DE),A
        INC E
        JR Z,S8186
        LD LY,A
        ADD A,(HL)
        RRA
        LD HY,A
        ADD A,LY
        RRA
        LD (DE),A
        INC E
        JR Z,S81866
        ADD A,HY
        RRA
        LD (DE),A
        INC E
        JR Z,S81867
        LD (DE),A
        INC E
        JR Z,S81868
        LD A,HY
        LD (DE),A
        INC E
        JR Z,S81869
        LD (DE),A
        INC E
        JR Z,S8186A
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S8186B
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S8186C
S8181   LD A,C
        ADD A,B
        LD C,A
        LD A,(HL)
        INC HL
        DEC LX
        LD (DE),A
        JP C,S8182
        JR Z,S81871
        JP S81831
S8183   JR Z,S8187
        INC E
        JR Z,S8188
        LD (DE),A
S81831  INC E
        JR Z,S8189
        LD LY,A
        ADD A,(HL)
        RRA
        LD HY,A
        ADD A,LY
        RRA
        LD (DE),A
        INC E
        JR Z,S81891
        ADD A,HY
        RRA
        LD (DE),A
        INC E
        JR Z,S81892
        LD (DE),A
        INC E
        JR Z,S81893
        LD A,HY
        LD (DE),A
        INC E
        JR Z,S81894
        LD (DE),A
        INC E
        JR Z,S81895
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S81896
        ADD A,(HL)
        RRA
        LD (DE),A
        INC E
        JR Z,S81897
S8180   LD A,C
        ADD A,B
        LD C,A
        LD A,(HL)
        INC HL
        DEC LX
        LD (DE),A
        JP C,S8183
        JR Z,S81844
        INC E
        JP NZ,S818222
        RRC C
        LD LY,C
        EXX
        LD E,LY
        RET

S81844  INC E
        RRC C
        LD LY,C
        EXX
        LD E,LY
        RET

S8187   INC E
S8188   SRL C
        LD LY,C
        EXX
        LD E,LY
        RET
        
S8189   SRL C
        LD LY,C
        EXX
        LD E,LY
        LD D,7
        RET
        
S81871  INC E
S81891  SRL C
        LD LY,C
        EXX
        LD E,LY
        LD D,6
        RET
        
S81892  SRL C
        LD LY,C
        EXX
        LD E,LY
        LD D,5
        RET
        
S81893  SRL C
        LD LY,C
        EXX
        LD E,LY
        LD D,4
        RET
        
S81894  SRL C
        LD LY,C
        EXX
        LD E,LY
        LD D,3
        RET
        
S81895  SRL C
        LD LY,C
        EXX
        LD E,LY
        LD D,2
        RET
        
S81896  SRL C
        LD LY,C
        EXX
        LD E,LY
        LD D,1
        RET
        
S81897  SRL C
        LD LY,C
        EXX
        LD E,LY
        LD D,0
        RET

;___END
;	ENDMODULE

        ORG GSRomBaseL+#3E00
DIVTAB3 
;INCLUDE "_DIVTAB3.a80"					#10*#20=#200
	DB #00,#01,#01,#02,#03,#03,#04,#05,#05,#06,#07,#07,#08,#09,#09,#0A
	DB #0B,#0B,#0C,#0D,#0D,#0E,#0F,#0F,#10,#11,#11,#12,#13,#13,#14,#15
	DB #15,#16,#17,#17,#18,#19,#19,#1A,#1B,#1B,#1C,#1D,#1D,#1E,#1F,#1F
	DB #20,#21,#21,#22,#23,#23,#24,#25,#25,#26,#27,#27,#28,#29,#29,#2A
	DB #2B,#2B,#2C,#2D,#2D,#2E,#2F,#2F,#30,#31,#31,#32,#33,#33,#34,#35
	DB #35,#36,#37,#37,#38,#39,#39,#3A,#3B,#3B,#3C,#3D,#3D,#3E,#3F,#3F
	DB #40,#41,#41,#42,#43,#43,#44,#45,#45,#46,#47,#47,#48,#49,#49,#4A
	DB #4B,#4B,#4C,#4D,#4D,#4E,#4F,#4F,#50,#51,#51,#52,#53,#53,#54,#55
	DB #55,#56,#57,#57,#58,#59,#59,#5A,#5B,#5B,#5C,#5D,#5D,#5E,#5F,#5F
	DB #60,#61,#61,#62,#63,#63,#64,#65,#65,#66,#67,#67,#68,#69,#69,#6A
	DB #6B,#6B,#6C,#6D,#6D,#6E,#6F,#6F,#70,#71,#71,#72,#73,#73,#74,#75
	DB #75,#76,#77,#77,#78,#79,#79,#7A,#7B,#7B,#7C,#7D,#7D,#7E,#7F,#7F
	DB #80,#81,#81,#82,#83,#83,#84,#85,#85,#86,#87,#87,#88,#89,#89,#8A
	DB #8B,#8B,#8C,#8D,#8D,#8E,#8F,#8F,#90,#91,#91,#92,#93,#93,#94,#95
	DB #95,#96,#97,#97,#98,#99,#99,#9A,#9B,#9B,#9C,#9D,#9D,#9E,#9F,#9F
	DB #A0,#A1,#A1,#A2,#A3,#A3,#A4,#A5,#A5,#A6,#A7,#A7,#A8,#A9,#A9,#AA
	DB #55,#56,#57,#57,#58,#59,#59,#5A,#5B,#5B,#5C,#5D,#5D,#5E,#5F,#5F
	DB #60,#61,#61,#62,#63,#63,#64,#65,#65,#66,#67,#67,#68,#69,#69,#6A
	DB #6B,#6B,#6C,#6D,#6D,#6E,#6F,#6F,#70,#71,#71,#72,#73,#73,#74,#75
	DB #75,#76,#77,#77,#78,#79,#79,#7A,#7B,#7B,#7C,#7D,#7D,#7E,#7F,#7F
	DB #80,#81,#81,#82,#83,#83,#84,#85,#85,#86,#87,#87,#88,#89,#89,#8A
	DB #8B,#8B,#8C,#8D,#8D,#8E,#8F,#8F,#90,#91,#91,#92,#93,#93,#94,#95
	DB #95,#96,#97,#97,#98,#99,#99,#9A,#9B,#9B,#9C,#9D,#9D,#9E,#9F,#9F
	DB #A0,#A1,#A1,#A2,#A3,#A3,#A4,#A5,#A5,#A6,#A7,#A7,#A8,#A9,#A9,#AA
	DB #AB,#AB,#AC,#AD,#AD,#AE,#AF,#AF,#B0,#B1,#B1,#B2,#B3,#B3,#B4,#B5
	DB #B5,#B6,#B7,#B7,#B8,#B9,#B9,#BA,#BB,#BB,#BC,#BD,#BD,#BE,#BF,#BF
	DB #C0,#C1,#C1,#C2,#C3,#C3,#C4,#C5,#C5,#C6,#C7,#C7,#C8,#C9,#C9,#CA
	DB #CB,#CB,#CC,#CD,#CD,#CE,#CF,#CF,#D0,#D1,#D1,#D2,#D3,#D3,#D4,#D5
	DB #D5,#D6,#D7,#D7,#D8,#D9,#D9,#DA,#DB,#DB,#DC,#DD,#DD,#DE,#DF,#DF
	DB #E0,#E1,#E1,#E2,#E3,#E3,#E4,#E5,#E5,#E6,#E7,#E7,#E8,#E9,#E9,#EA
	DB #EB,#EB,#EC,#ED,#ED,#EE,#EF,#EF,#F0,#F1,#F1,#F2,#F3,#F3,#F4,#F5
	DB #F5,#F6,#F7,#F7,#F8,#F9,#F9,#FA,#FB,#FB,#FC,#FD,#FD,#FE,#FF,#FF

___LEND

        ; HIGH ROM INCLUDES
        ORG GSRomBaseH

;INCLUDE "INIT_H.a80"

INITVAR DI
;---patched
        CALL Patch5i1
;---
        EX AF,AF'
        LD A,(NUMPG)
        LD SP,#8000
        LD HL,#8080
        LD B,#00
INITV00 PUSH HL
        PUSH HL
        PUSH HL
        PUSH HL
        PUSH HL
        PUSH HL
        PUSH HL
        PUSH HL
        PUSH HL
        PUSH HL
        PUSH HL
        PUSH HL
        PUSH HL
        PUSH HL
        PUSH HL
        PUSH HL
        DJNZ INITV00
        LD HL,#0000
        LD B,#FE
INITV01 PUSH HL
        PUSH HL
        PUSH HL
        PUSH HL
        PUSH HL
        PUSH HL
        PUSH HL
        PUSH HL
        PUSH HL
        PUSH HL
        PUSH HL
        PUSH HL
        PUSH HL
        PUSH HL
        PUSH HL
        PUSH HL
        DJNZ INITV01
        LD SP,ISTACK
        LD (NUMPG),A
        EX AF,AF'
;---patched
        CALL Patch5i2
;---
        LD A,#00
        LD (INFO),A
        XOR A
        LD (ROMPG),A
        LD HL,DAC0
        LD A,(HL)
        INC H
        LD A,(HL)
        INC H
        LD A,(HL)
        INC H
        LD A,(HL)
        LD A,#3F
        OUT (VOL1),A
        OUT (VOL2),A
        OUT (VOL3),A
        OUT (VOL4),A
        LD HL,CHNVOL
        LD DE,CHNVOL+1
        LD BC,#0007
        LD (HL),#BF
        LDIR
        LD A,high INTTAB
        LD I,A
        LD HL,INT7
        LD DE,INTAREA
        LD BC,#0017
        LDIR
        EX DE,HL
        LD (HL),#C3
        INC L
        LD (HL),low INT7
        INC L
        LD (HL),high INT7
        LD HL,QTMAP
        LD (QTFREE),HL
        LD (QTBUSY),HL
        LD DE,QTMAP+1
        LD BC,#001F
        LD (HL),B
        LDIR
        LD HL,VOLTAB
        LD DE,VOLTAB+1
        LD BC,#001F
        LD (HL),#3F
        LDIR
        LD HL,VOLRQTB
        LD DE,VOLRQTB+1
        LD BC,#0007
        LD (HL),#3F
        LDIR
        LD A,#0F
        LD (GSCHNS),A
        LD (MTCHNS),A
        LD A,#40
        LD (MODVOL),A
        LD (FXMVOL),A
        LD (FXVOL),A
        LD A,%11000011
        LD (MTSTAT),A
        XOR A
        LD (MODULE),A
        LD A,(NUMPG)
        SRL A
        LD B,A
        LD HL,#8000
        RR H
        LD A,B
        LD (RAMTOP),HL
        LD (RAMTOP+2),A
        LD (PTRC),HL
        LD (PTRC+2),A
        LD (PTRB),HL
        LD (PTRB+2),A
        LD (PTRA),HL
        LD (PTRA+2),A
        LD (PTR9),HL
        LD (PTR9+2),A
        LD (PTR8),HL
        LD (PTR8+2),A
        LD (PTR7),HL
        LD (PTR7+2),A
        LD (PTR6),HL
        LD (PTR6+2),A
        LD (PTR5),HL
        LD (PTR5+2),A
        LD (MEMTOP),HL
        LD (MEMTOP+2),A
        LD (PTR4),HL
        LD (PTR4+2),A
        LD IY,CHANSFX
        LD (CURCHAN),IY
        LD BC,#0801
        LD DE,CHANLEN
INITV03 LD (IY+CHSTAT),#40
        LD (IY+CHRDR),C
        LD (IY+CHRDRI),C
        LD A,#08
        SUB B
        LD (IY+CHRDN),A
        AND #02
        JR Z,INITV05
        SET 5,(IY+CHSTAT)
INITV05 LD (IY+CHFLAGS),#00
        LD (IY+CHPORT),#01
        LD (IY+CHVIBCM),#11
        LD (IY+CHTRMCM),#11
        LD (IY+CHOFFST),#01
        LD (IY+CHWNT),#7F
        LD (IY+CHOLDV),#80
        LD (IY+CHEPAN),#20
        LD (IY+CHEVOL),#40
        RLC C
        ADD IY,DE
        DJNZ INITV03
        LD IY,CHANS
        LD B,#08
INITV04 LD (IY+CHSTAT),#00
        LD (IY+CHFLAGS),#00
        LD (IY+CHPORT),#01
        LD (IY+CHVIBCM),#11
        LD (IY+CHTRMCM),#11
        LD (IY+CHOFFST),#01
        LD (IY+CHWNT),#7F
        LD (IY+CHOLDV),#80
        LD (IY+CHEPAN),#20
        LD (IY+CHEVOL),#40
        ADD IY,DE
        DJNZ INITV04
        LD IY,CHANS
        LD (IY+CHSTAT),#00
        LD (IY+CHRDR),#01
        LD (IY+CHRDRI),#01
        LD (IY+CHRDN),#00
        ADD IY,DE
        LD (IY+CHSTAT),#20
        LD (IY+CHRDR),#04
        LD (IY+CHRDRI),#04
        LD (IY+CHRDN),#02
        ADD IY,DE
        LD (IY+CHSTAT),#20
        LD (IY+CHRDR),#08
        LD (IY+CHRDRI),#08
        LD (IY+CHRDN),#03
        ADD IY,DE
        LD (IY+CHSTAT),#00
        LD (IY+CHRDR),#02
        LD (IY+CHRDRI),#02
        LD (IY+CHRDN),#01
        LD HL,750
        LD (TICKLEN),HL
        LD (TCKLEFT),HL
        LD (FXTICK),HL
        LD (FXTCLEN),HL
        LD HX,#80
        LD DE,#0000
        IN A,(ZXDATRD)
        JP COMINT

; B - NUMBER OF CHANNELS

INITCHN LD HL,(#EC60)
        LD (IY+CHPERL),L  ; C-4
        LD (IY+CHPERH),H
        LD HL,(#E060)
        LD (IY+CHFRQL),L
        LD (IY+CHFRQH),H
        LD (IY+CHNOTE),48
        LD (IY+CHFLAGS),#00
        LD (IY+CHREAL),#7F
        LD (IY+CHCNTL),#00
        LD (IY+CHCNTH),#00
        LD (IY+CHINS),#00
        LD (IY+CHSMP),#00
        LD (IY+CHCOM),#00
        LD (IY+CHPARM),#00
        LD (IY+CHVIBPS),#00
        LD (IY+CHTRMPS),#00
        LD (IY+CHPATPS),#00
        LD (IY+CHLPCNT),#00
        LD A,B
        LD BC,CHANLEN
        ADD IY,BC
        LD B,A
        DJNZ INITCHN
        RET

;INCLUDE "COM_H.a80"

HGET    IN A,(ZXSTAT)
        AND #81
        JR Z,HGET
        IN A,(ZXDATRD)
        RET M
        JP COMINT

HSEND   IN A,(ZXSTAT)
        OR A
        RET P
        RRCA
        JP NC,HSEND
        JP COMINT

HTAIL   LD HL,HTAIL2
HTAIL2  IN A,(ZXSTAT)
        AND #81
        JR Z,HTAIL2
        RRCA
        JR C,HTAIL3
        IN A,(ZXDATRD)
        JP (HL)
HTAIL3  IN A,(ZXCMD)
        CP #E0
        JP NC,COMINT
        CP #D0
        JP C,COMINT
        JR Z,HTAIL5
        CP #D1
        JR Z,HTAIL6
        XOR A
HTAIL4  OUT (ZXDATWR),A
        IN A,(ZXDATRD)
HTAIL6  OUT (CLRCBIT),A
        JP (HL)
HTAIL5  LD A,(ERRCODE)
        JR HTAIL4

ERR30
ERR20
ERR10   LD A,#10        ;NOT ENOUGH FREE SPACE
        JR ERR
        
ERR11   LD A,#11        ;NOT ENOUGH FREE ENTRIES
        JR ERR

ERR     LD (ERRCODE),A
        JP COMINT

;Get total RAM
;Получить общий объем доступной памяти на GS. (В базовой версии это 112к)
COM20   LD DE,(RAMBOT)
        LD A,(RAMBOT+2)
        LD C,A
        LD HL,(RAMTOP)
        LD A,(RAMTOP+2)
        OR A
        SBC HL,DE
        SBC A,C
        LD C,A
        LD A,L
        OUT (ZXDATWR),A
        OUT (CLRCBIT),A
        CALL HSEND
        LD A,H
        OUT (ZXDATWR),A
        CALL HSEND
        LD A,C
        OUT (ZXDATWR),A
        RET

;Get free RAM
;Получить общий об'ем свободной памяти на GS.
COM21   LD DE,(MEMBOT)
        LD A,(MEMBOT+2)
        LD C,A
        LD HL,(MEMTOP)
        LD A,(MEMTOP+2)
        OR A
        SBC HL,DE
        SBC A,C
        LD C,A
        LD A,L
        OUT (ZXDATWR),A
        OUT (CLRCBIT),A
        XOR A
        LD (ERRCODE),A
        CALL HSEND
        LD A,H
        OUT (ZXDATWR),A
        CALL HSEND
        LD A,C
        OUT (ZXDATWR),A
        RET

;Get free RAM
;Получить общий об'ем свободной памяти на GS.
COM22   IN A,(ZXDATRD)
        LD E,A
        LD D,high RAMPG
        LD A,(DE)
        OUT (ZXDATWR),A
        OUT (CLRCBIT),A
        RET

;Get number of RAM Pages
;Получить число страниц на  GS.
COM23   LD A,(NUMPG)
        OUT (ZXDATWR),A
        OUT (CLRCBIT),A
        RET

;Set Module Master Volume
;Установить громкость проигрывания модулей.
COM2A   LD A,(MODVOL)
        OUT (ZXDATWR),A
        IN A,(ZXDATRD)
        OUT (CLRCBIT),A
        CP #40
        JR C,COM2A_
        LD A,#40
COM2A_  LD (MODVOL),A
        LD IY,CHANS
        LD B,#08
        LD DE,CHANLEN
COM2A__ SET 0,(IY+CHSTAT)
        ADD IY,DE
        DJNZ COM2A__
        RET

;Set FX Master Volume
;Установить громкость проигрывания эффектов.
COM2B   LD A,(FXVOL)
        OUT (ZXDATWR),A
        IN A,(ZXDATRD)
        OUT (CLRCBIT),A
        CP #40
        JR C,COM2B_
        LD A,#40
COM2B_  LD (FXVOL),A
        LD IY,CHANSFX
        LD B,#08
        LD DE,CHANLEN
COM2B__ SET 0,(IY+CHSTAT)
        ADD IY,DE
        DJNZ COM2B__
        RET

COM2C   LD A,(CURMOD)
        OUT (ZXDATWR),A
        IN A,(ZXDATRD)
        OUT (CLRCBIT),A
        OR A
        JR Z,COM2C_
        LD B,A
        LD A,(CNTMOD)
        CP B
        JR C,COM2C__
        LD A,B
        LD (CURMOD),A
        RET
        
COM2C_  LD A,(CNTMOD)
        LD (CURMOD),A
        RET
        
COM2C__ XOR A
        LD (CURMOD),A
        RET

COM2D   LD A,(CURSMP)
        OUT (ZXDATWR),A
        IN A,(ZXDATRD)
        OUT (CLRCBIT),A
        OR A
        JR Z,COM2D_
        LD B,A
        LD A,(CNTSMP)
        CP B
        JR C,COM2D__
        LD A,B
        LD (CURSMP),A
        RET
        
COM2D_  LD A,(CNTSMP)
        LD (CURSMP),A
        RET
        
COM2D__ XOR A
        LD (CURSMP),A
        RET

;Set Current FX
;Установить текущий эффект. Просто присваивает переменной CURFX это зна-
;чение. Если какая-либо команда требует номер сэмпла (sample handle), то
;можно вместо этого номера подать ей #00 и интерпретатор подставит вмес-
;то этого нуля значение переменной CURFX. (См. команды #38, #39, #40-#4F
;для понимания вышеизложенного.)
COM2E   LD A,(CURFX)
        OUT (ZXDATWR),A
        IN A,(ZXDATRD)
        OUT (CLRCBIT),A
        OR A
        JR Z,COM2E_
        LD B,A
        LD A,(CNTFX)
        CP B
        JR C,COM2E__
        LD A,B
        LD (CURFX),A
        RET
        
COM2E_  LD A,(CNTFX)
        LD (CURFX),A
        RET
        
COM2E__ XOR A
        LD (CURFX),A
        RET

COM2F   IN A,(ZXDATRD)
        OUT (CLRCBIT),A
        LD E,A
        CALL HGET
        LD D,A
        OR E
        JR Z,COM2F_
        LD HL,(CNTTRK)
        SBC HL,DE
        JR C,COM2F__
        LD (CURTRK),DE
        RET
        
COM2F_  LD HL,(CNTTRK)
        LD (CURTRK),HL
        RET
        
COM2F__ LD HL,#0000
        LD (CURTRK),HL
        RET

;Load Module
;Загрузка модуля в память.
COM30   LD A,(CNTMOD)
        OR A
        JP NZ,INITVAR
        INC A
	LD (CNTMOD),A
        LD (CURMOD),A
        OUT (ZXDATWR),A
        IN A,(ZXDATRD)
        OUT (CLRCBIT),A
        LD C,#00
        CALL LOAD
LDMOD   LD A,#00		;#C3F8
        LD (CONVERT),A
;---patched
        CALL Patch5x
;---
        RET

;Jump to position (*)
;Делает переход на заданную позицию.
COM65   IN A,(ZXDATRD)
        LD C,A
        LD A,(CURMOD)
        LD B,A
        JP COM65_

;Play module
;Проигрывание модуля.
COM31   IN A,(ZXDATRD)
        OR A
        JR NZ,COM31_
        LD A,(CURMOD)
        OR A
        JP Z,COM31_1
COM31_  LD B,A
        LD A,(CNTMOD)
        CP B
        JP C,COM31_2
        LD A,B
        LD C,#00
COM65_  OUT (ZXDATWR),A
        OUT (CLRCBIT),A
PLAYMOD	LD A,(BUSY)		;#C426
        PUSH AF
        LD A,#FF
        LD (BUSY),A
        LD A,B
        LD (MODULE),A
        LD (CURMOD),A
        LD A,%00000011
        LD (MTSTAT),A
        LD A,#06
        LD (MTSPEED),A
        LD A,C
        LD (MTSNGPS),A
        XOR A
        LD (MTFLAGS),A
        LD (MTCOUNT),A
        LD (MTPATPS),A
        LD (MTPDT),A
        LD (MTPDT2),A
        LD (MTBRKFL),A
        LD (MTBRKPS),A
        LD (MTJMPFL),A
        INC A
        LD (MTTYPE),A
        LD A,#40
        LD (MTVOL),A
        DEC A
        LD (MTROWS),A
        LD A,125
        CALL FXF
        LD IY,CHANS
        LD B,#08
        LD DE,CHANLEN
COM31__ RES 7,(IY+CHSTAT)
        SET 0,(IY+CHSTAT)
        LD (IY+CHVOL),#40
        LD (IY+CHMVOL),#40
        ADD IY,DE
        DJNZ COM31__
        CALL INITPAT
        CALL EFXGTNT
        LD A,#FF
        LD (PROCESS),A
        POP AF
        LD (BUSY),A
        RET

COM31_1
COM31_2 XOR A
        LD (CURMOD),A
        OUT (ZXDATWR),A
        OUT (CLRCBIT),A
        RET

;Stop module
;Остановить проигрывание модуля.
COM32   LD A,(MODULE)
        OUT (ZXDATWR),A
        IN A,(ZXDATRD)
        OUT (CLRCBIT),A
STOPMOD	LD HL,MTSTAT		;#C4AE
        SET 7,(HL)
        RET

;Continue module
;Продолжить проигрывание модуля после остановки.
COM33   LD A,(MODULE)
        OUT (ZXDATWR),A
        IN A,(ZXDATRD)
        OUT (CLRCBIT),A
CONTMOD	LD A,(MODULE)		;#C4BD
        OR A
        RET Z
        LD HL,MTSTAT
        BIT 6,(HL)
        RET NZ
        LD A,#FF
        LD (PROCESS),A
        RES 7,(HL)
        LD (PROCESS),A
        RET

COM34   LD A,(MODFADE)
        OUT (ZXDATWR),A
        IN A,(ZXDATRD)
        OUT (CLRCBIT),A
        LD (MODFADE),A
        RET

;Set Module Volume
;Установить громкость проигрывания модулей.
COM35   LD A,(MTVOL)
        OUT (ZXDATWR),A
        IN A,(ZXDATRD)
        OUT (CLRCBIT),A
        CP #40
        JR C,COM35_
        LD A,#40
COM35_  LD (MTVOL),A
        LD IY,CHANS
        LD B,#08
        LD DE,CHANLEN
COM35__ SET 0,(IY+CHSTAT)
        ADD IY,DE
        DJNZ COM35__
        RET

;Data on (*)
;Устанавливает регистр данных в #FF.
COM36   LD A,#FF
        OUT (ZXDATWR),A
        OUT (CLRCBIT),A
        RET

;Reinitialisation (*)
;Переустанавливает внутренние переменные в исходное состояние.
COM37   OUT (CLRCBIT),A
        LD HL,MTSTAT
        SET 7,(HL)
        LD HL,#0000
        XOR A
        LD (CURADR),HL
        LD (CURADR+2),A
        LD (MEMBOT),HL
        LD (MEMBOT+2),A
        LD (CURMOD),A
        LD (CNTMOD),A
        LD (MODULE),A
        RET

;Load FX (Extended version)
;Загрузка сэмпла эффекта в память. Позволяет загружать сэмплы со знаком.
COM3E   IN A,(ZXDATRD)
        CP #01
        JR Z,COM38
        LD LX,#80
        OR A
        JR Z,COM38_
        XOR A
        OUT (ZXDATWR),A
        IN A,(ZXDATRD)
        OUT (CLRCBIT),A
        RET

;Load FX
;Загрузка сэмпла эффекта в память. Загружает беззнаковые сэмплы (PC type)
COM38   LD LX,#00
COM38_  LD A,(CNTFX)
        CP 60
        JP NC,COM38_9
        INC A
        OUT (ZXDATWR),A
        PUSH AF
        IN A,(ZXDATRD)
        OUT (CLRCBIT),A
        POP AF
        LD (CNTFX),A
        LD (CURFX),A
        CALL GETFX
        PUSH HL
        POP IY
        LD E,L
        LD D,H
        INC DE
        LD BC,#003F
        LD (HL),B
        LDIR
        LD HL,(CURADR)
        LD A,(CURADR+2)
        LD (IY+8),L
        LD (IY+9),H
        LD (IY+10),A
        LD C,LX
        CALL LOAD
        LD A,(CURADR)
        SUB (IY+8)
        LD (IY+11),A
        LD (IY+17),A
        LD A,(CURADR+1)
        SBC A,(IY+9)
        LD (IY+12),A
        LD (IY+18),A
        LD A,(CURADR+2)
        SBC A,(IY+10)
        LD (IY+13),A
        LD (IY+19),A
        LD (IY+16),#FF
        LD (IY+20),#40
        LD (IY+23),#80
        LD (IY+24),#0F
        LD (IY+25),#0F
        LD (IY+26),#80
        LD (IY+27),#FF
        LD (IY+28),#FF
        LD (IY+31),60
        LD E,60
        CALL GETPER
        LD (IY+54),L
        LD (IY+55),H
        CALL GETFRQ
        LD (IY+56),L
        LD (IY+57),H
        RET

COM38_9 XOR A
        OUT (ZXDATWR),A
        LD (CURFX),A
        IN A,(ZXDATRD)
        OUT (CLRCBIT),A
        RET

GETFX   DEC A
        CP #20
        JR C,GETFX2
        SUB #20
        LD H,#00
        ADD A,A
        ADD A,A
        ADD A,A
        RL H
        ADD A,A
        RL H
        ADD A,A
        RL H
        ADD A,A
        RL H
        LD L,A
        LD A,H
        ADD A,(high BUFFER)+1
        LD H,A
        PUSH HL
        POP IY
        RET

GETFX2  LD H,#00
        ADD A,A
        ADD A,A
        ADD A,A
        RL H
        ADD A,A
        RL H
        ADD A,A
        RL H
        ADD A,A
        RL H
        LD L,A
        LD A,H
        ADD A,high SMPADR
        LD H,A
        PUSH HL
        POP IY
        RET

;Play FX
;Проигрывание эффекта.
COM39   IN A,(ZXDATRD)
        OR A
        JR NZ,COM39_1
        LD A,(CURFX)
COM39_1 LD (CURFX),A
        LD B,A
        LD A,(CNTFX)
        CP B
        JP C,COM39_9
        XOR A
        OUT (ZXDATWR),A
        OUT (CLRCBIT),A
        LD A,(CURFX)
        CALL GETFX
        LD A,(BUSY)
        PUSH AF
        LD A,#FF
        LD (BUSY),A
        PUSH HL
        POP IY
        CALL PLAYFX
        POP AF
        LD (BUSY),A
        RET

COM39_9 LD A,#FF
        OUT (ZXDATWR),A
        OUT (CLRCBIT),A
        RET

COM3B
COM3C   LD A,(FXFADE)
        OUT (ZXDATWR),A
        IN A,(ZXDATRD)
        OUT (CLRCBIT),A
        LD (FXFADE),A
        RET

;Set FX Volume
;Установить громкость проигрывания эффектов.
COM3D   LD A,(FXMVOL)
        OUT (ZXDATWR),A
        IN A,(ZXDATRD)
        OUT (CLRCBIT),A
        CP #40
        JR C,COM3D_
        LD A,#40
COM3D_  LD (FXMVOL),A
        LD IY,CHANSFX
        LD B,#08
        LD DE,CHANLEN
COM3D__ SET 0,(IY+CHSTAT)
        ADD IY,DE
        DJNZ COM3D__
        RET

COM3F

;Set FX Sample Playing Note
;Установка ноты по умолчанию для текущего эффекта.
COM40   IN A,(ZXDATRD)
        OUT (CLRCBIT),A
        LD E,A
        LD A,(CURFX)
        OR A
        RET Z
        CALL GETFX
        LD A,E
        CP 96
        JR C,COM40_
        LD E,95
COM40_  LD (IY+31),E
        CALL GETPER
        LD (IY+54),L
        LD (IY+55),H
        CALL GETFRQ
        LD (IY+56),L
        LD (IY+57),H
        RET

;Set FX Sample Volume
;Установка громкости по умолчанию для текущего эффекта.
COM41   IN A,(ZXDATRD)
        OUT (CLRCBIT),A
        LD E,A
        LD A,(CURFX)
        OR A
        RET Z
        CALL GETFX
        LD A,E
        CP #41
        JR C,COM41_
        LD E,#40
COM41_  LD (IY+20),E
        RET

;Set FX Sample Finetune
;Установка Finetune по умолчанию для текущего эффекта. 
COM42   LD A,(CURFX)
        CALL GETFX
        PUSH HL
        POP IY
        LD A,(IY+21)
        OUT (ZXDATWR),A
        IN A,(ZXDATRD)
        OUT (CLRCBIT),A
        LD (IY+21),A
        RET

;Set FX Sample Priority
;Установка приоритета для текущего эффекта. (См. команду #39)
COM45   LD A,(CURFX)
        CALL GETFX
        PUSH HL
        POP IY
        LD A,(IY+26)
        OUT (ZXDATWR),A
        IN A,(ZXDATRD)
        OUT (CLRCBIT),A
        LD (IY+26),A
        RET

;Set FX Sample Seek First parameter
;Установка параметра Seek First для текущего эффекта. (См. команду #39) 
COM46   LD A,(CURFX)
        CALL GETFX
        PUSH HL
        POP IY
        LD A,(IY+24)
        OUT (ZXDATWR),A
        IN A,(ZXDATRD)
        OUT (CLRCBIT),A
        LD (IY+24),A
        RET

;Set FX Sample Seek Last parameter
;Установка параметра Seek Last для текущего эффекта. (См. команду #39)
COM47   LD A,(CURFX)
        CALL GETFX
        PUSH HL
        POP IY
        LD A,(IY+25)
        OUT (ZXDATWR),A
        IN A,(ZXDATRD)
        OUT (CLRCBIT),A
        LD (IY+25),A
        RET

;Set FX Sample Loop Begin (*)
;Установка начала цикла для текущего эффекта.
COM48   LD A,(CURFX)
        CALL GETFX
        PUSH HL
        POP IY
        IN A,(ZXDATRD)
        OUT (CLRCBIT),A
        LD (IY+14),A
        CALL HGET
        LD (IY+15),A
        CALL HGET
        LD (IY+16),A
        RET

;Set FX Sample Loop End (*)
;Установка конца цикла для текущего эффекта.
COM49   LD A,(CURFX)
        CALL GETFX
        PUSH HL
        POP IY
        IN A,(ZXDATRD)
        OUT (CLRCBIT),A
        LD (IY+17),A
        CALL HGET
        LD (IY+18),A
        CALL HGET
        LD (IY+19),A
        RET

COM58   LD B,#00
        OUT (ZXDATWR),A
        JP COM50_

COM50   IN A,(ZXDATRD)
        LD B,A
COM50_  IN A,(ZXCMD)
        OUT (CLRCBIT),A
        AND #07
        LD E,A
        CALL HGET
        LD L,A
        LD A,E
        CP #04
        CALL NC,HGET
        LD H,A
        LD A,E
        CP #07
        CALL Z,HGET
        LD D,A
        LD A,B
        OR A
        JR NZ,C50_00
        LD A,(LSTCHN)
        OR A
        JP Z,ERR20
C50_00  LD B,A
        LD C,#01
        LD IY,CHANSFX
C50_01  LD A,B
        AND C
        JR NZ,C50_02
        RLC C
        LD A,LY
        ADD A,low CHANLEN
        LD LY,A
        LD A,HY
        ADC A,#00
        LD HY,A
        JP C50_01

C50_02  LD A,E
        OR A
        JP Z,C50_80
        CP #02
        JP Z,C50_A0
        CP #04
        JP Z,C50_C0
        CP #05
        JP Z,C50_D0
        CP #06
        JP Z,C50_E0
        CP #07
        JP Z,C50_F0
C50_LP
C50_80  SET 7,(IY+CHSTAT)
        LD A,L
        AND #7F
        CP 96
        JP NC,C50_LP
C50_81  LD A,(IY+CHSMP)
        OR A
        JP Z,C50_LP
        PUSH DE
        PUSH BC
        PUSH HL
        LD E,L
        RES 7,E
        CALL GETFRQ
        LD (IY+CHFRQL),L
        LD (IY+CHFRQH),H
        CALL GETPER
        LD (IY+CHPERL),L
        LD (IY+CHPERH),H
        BIT 7,(IY+CHSTAT)
        JR NZ,C50_82
        LD A,(IY+CHNOTE)
        CP E
        JR Z,C50_83
        LD (IY+CHNOTE),E
C50_82  LD (IY+CHCNTL),#00
        LD (IY+CHCNTH),#00
C50_83  POP HL
        PUSH HL
        BIT 7,(IY+CHSTAT)
        JR NZ,C50_84
        BIT 7,L
C50_84  POP HL
        POP BC
        POP DE
        JP C50_LP

C50_90  LD A,L
        CP #40
        JR C,C50_91
        LD L,#40
C50_91  LD (IY+CHVOL),A
        LD (IY+CHMVOL),A
        JP C50_LP

C50_A0  LD (IY+CHFINE),L
        JP C50_LP

C50_B0  LD (IY+CHPAN),L
        JP C50_LP

C50_C0  LD A,H
        OR A
        JR NZ,C50_C1
        OR L
        JR NZ,C50_C1
        LD L,#01
C50_C1  LD A,H
        CP #20
        JR C,C50_C2
        LD HL,#1FFF
C50_C2  LD A,(IY+CHSTAT)
        SET 7,(IY+CHSTAT)
        LD (IY+CHPERL),L
        LD (IY+CHPERH),H
        LD (IY+CHCNTL),#00
        LD (IY+CHCNTH),#00
        LD (IY+CHSTAT),A
        JP C50_LP

C50_D0  LD A,H
        OR A
        JR NZ,C50_D1
        OR L
        JR NZ,C50_D1
        LD L,#01
C50_D1  LD A,H
        CP #80
        JR C,C50_D2
        LD HL,#7FFF
C50_D2  LD A,(IY+CHSTAT)
        SET 7,(IY+CHSTAT)
        LD (IY+CHFRQL),L
        LD (IY+CHFRQH),H
        LD (IY+CHCNTL),#00
        LD (IY+CHCNTH),#00
        LD (IY+CHSTAT),A
        JP C50_LP

C50_E0
C50_F0

;Get Song Position
;Получение значения переменной Song_Position в текущем модуле.
COM60   LD A,(MTSNGPS)
        OUT (ZXDATWR),A
        OUT (CLRCBIT),A
        RET

;Get Pattern Position
;Получение значения переменной Pattern_Position в текущем модуле.
COM61   LD A,(MTPATPS)
        OUT (ZXDATWR),A
        OUT (CLRCBIT),A
        RET

;Get Mixed Position
;Получить значение Pattern_Position, немного смешанной с Song_Position.
COM62   LD A,(MTSNGPS)
        RRCA
        RRCA
        AND #C0
        LD B,A
        LD A,(MTPATPS)
        AND #3F
        OR B
        OUT (ZXDATWR),A
        OUT (CLRCBIT),A
        RET

;Get Channel Volumes
;Получить громкости всех каналов модуля.
COM64   LD HL,CHANS+CHMVOL
        JP COM64_
        
COM63   LD HL,CHANS+CHREAL
COM64_  LD DE,CHANLEN
        LD B,#04
        LD A,(HL)
        OUT (ZXDATWR),A
        OUT (CLRCBIT),A
        JP COM63__

;Get Channel Notes
;Получить ноты всех каналов модуля.
COM63_  LD A,(HL)
        OUT (ZXDATWR),A
COM63__ SET 7,(HL)
        CALL HSEND
        ADD HL,DE
        DJNZ COM63_
        RET

;Set speed/tempo (*)
;Установка скорости в пределах #01-#1F. При значениях #20-#FF устанавли-
;вается темп проигрывания. Значения темпа соответствуют оригинальным при
;скорости равной #06.
COM66   IN A,(ZXDATRD)
        OUT (CLRCBIT),A
        CALL FXF
        RET

;Get speed value (*)
;Чтение текущей скорости.
COM67   LD A,(MTSPEED)
        OUT (ZXDATWR),A
        OUT (CLRCBIT),A
        RET

;Get tempo value (*)
;Чтение текущего темпа.
COM68   LD A,(MTBPM)
        OUT (ZXDATWR),A
        OUT (CLRCBIT),A
        RET

;Process Sound (*)
;Переход на следующий кварк (или тик) в процессе проигрывания звука.
COM69   LD A,#FF
        LD (INGEN),A
        CALL ENGINE
        XOR A
        LD (INGEN),A
        OUT (CLRCBIT),A
        RET

;Stop FX in channels
;установка проигрывания эффектов в заданных каналах,  которые указывают-
;ся в маске каналов (Channel Mask).  В ней единица в n-ном  бите  указы-
;вает на то, что эффект в n-ном канале требуется остановить
COM3A   IN A,(ZXDATRD)
        OUT (CLRCBIT),A
        LD C,A
        CPL
        LD B,A
        LD A,(FXCHNS)
        AND B
        LD (FXCHNS),A
        LD IY,CHANSFX
        LD DE,CHANLEN
        SLA C
        JR NC,COM3A_2
COM3A_1 RES 7,(IY+CHSTAT)
COM3A_2 ADD IY,DE
        SLA C
        JR C,COM3A_1
        JP NZ,COM3A_2
        RET

;Direct Play FX Sample (#80..#83)
;Проигрывание сэмпла в заданном канале.
COM80   IN A,(ZXDATRD)
        OR A
        JR NZ,COM80_1
        LD A,(CURFX)
COM80_1 LD (CURFX),A
        LD C,A
        LD A,(CNTFX)
        CP C
        JP C,COM39_9
        IN A,(ZXCMD)
        OUT (CLRCBIT),A
        LD B,A
        BIT 3,B
        CALL NZ,HGET
        LD E,A
        BIT 4,B
        CALL NZ,HGET
        LD D,A
        LD A,C
        CALL GETFX
        PUSH DE
        PUSH BC
        CALL COM80_2
        POP  BC
        POP  DE
        PUSH HL
        POP  IY
        BIT 4,B
        JR Z,COM80_4
        LD (IY+CHVOL),D
        LD (IY+CHMVOL),D
COM80_4 BIT 3,B
        RET Z
        CALL GETFRQ
        LD (IY+CHFRQL),L
        LD (IY+CHFRQH),H
        CALL GETPER
        LD (IY+CHPERL),L
        LD (IY+CHPERH),H
        RET

COM80_2 PUSH IY
        LD IY,CHANSFX
        LD DE,CHANLEN
        LD A,B
        AND #07
COM80_3 JP Z,PLFX_12
        ADD IY,DE
        DEC A
        JP COM80_3

COMA0   IN A,(ZXDATRD)
        LD C,A
        IN A,(ZXCMD)
        OUT (CLRCBIT),A
        LD B,A
        LD IY,CHANSFX
        LD DE,CHANLEN
        AND #07
COMA0_1 JR Z,COMA0_2
        ADD IY,DE
        DEC A
        JP NZ,COMA0_1
COMA0_2 BIT 3,B
        JR NZ,COMA0_3
        LD E,C
        CALL GETPER
        LD (IY+CHPERL),L
        LD (IY+CHPERH),H
        CALL GETFRQ
        LD (IY+CHFRQL),L
        LD (IY+CHFRQH),H
        RET
        
COMA0_3 LD (IY+CHVOL),C
        LD (IY+CHMVOL),C
        SET 0,(IY+CHSTAT)
        RET

; INPUT : E=NOTE,IY=CHANNEL
; OUTPUT: HL=PERIOD OR FREQUENCY
; USED  : HL,D,BC,A

GETPER  LD HL,AMFRQTB   ; FOR AMIGA FREQUENCY
        JR GETFRQ_

GETFRQ  LD HL,GSFRQTB
GETFRQ_ LD A,(IY+CHFINE)
        RRA
        AND #0F
        JR Z,GETFRQ2
        LD C,A
        ADD A,A
        ADD A,C
        ADD A,A
        ADD A,A
        ADD A,A
        LD B,0
        RL B
        ADD A,A
        RL B
        ADD A,A
        RL B
        LD C,A
        ADD HL,BC
        ADD HL,BC
GETFRQ2 LD D,0
        LD A,E
        CP 96
        JR C,GETFRQ3
        LD E,95
GETFRQ3 SLA E
        ADD HL,DE
        LD E,(HL)
        INC HL
        LD D,(HL)
        EX DE,HL
        LD E,A
        BIT 0,(IY+CHFINE)
        RET Z
        RET

PLAYFX  LD C,#00
        LD A,(MTSTAT)
        OR A
        JP M,PLFX_03
        LD A,(MODULE)
        OR A
        JR Z,PLFX_03
        LD IY,CHANS
        LD DE,CHANLEN
        LD B,#04
PLFX_00 BIT 7,(IY+CHSTAT)
        JR Z,PLFX_01
        LD A,(IY+CHMVOL)
        OR A
        JR Z,PLFX_01
        LD A,C
        OR (IY+CHRDR)
        LD C,A
PLFX_01 ADD IY,DE
        DJNZ  PLFX_00
PLFX_03 PUSH HL
        POP IY
        LD HL,GSCHNS
        LD A,(HL)
        OR A
        SCF
        RET Z
        LD A,(FXCHNS)
        OR C
        CPL
        AND (HL)
        LD C,A
        AND (IY+24)
        JR NZ,PLFX_10
        LD A,(IY+26)
        CP #40
        JR NC,PLFX_04
        LD A,C
        AND (IY+25)
        JR NZ,PLFX_10
        JP PLFX_05
        
PLFX_04 LD A,(FXCHNS)
        CPL
        AND (HL)
        AND (IY+24)
        JR NZ,PLFX_10
        LD A,(FXCHNS)
        CPL
        AND (HL)
        AND (IY+25)
        JR NZ,PLFX_10
PLFX_05 LD A,(FXCHNS)
        LD B,A
        LD A,(GSCHNS)
        AND B
        LD B,A
        PUSH IY
        LD IY,CHANSFX
        LD L,A
        LD H,#FF
        LD DE,CHANLEN
        SRL B
        JP C,PLFX_06
        JP NZ,PLFX_07
        JP PLFX_08

PLFX_06 LD A,(IY+CHPRIOR)
        CP H
        JR NC,PLFX_07
        LD H,A
        LD L,(IY+CHRDR)
PLFX_07 ADD IY,DE
        SRL B
        JP C,PLFX_06
        JP NZ,PLFX_07
PLFX_08 POP IY
        LD A,L
        OR A
        SCF
        RET Z
        LD A,H
        CP (IY+26)
        LD A,L
        JR C,PLFX_10
        SCF
        RET

PLFX_10 LD B,A
        PUSH IY
        LD IY,CHANSFX
        LD DE,CHANLEN
        SRL B
        JP C,PLFX_12
PLFX_11 ADD IY,DE
        SRL B
        JP NC,PLFX_11
PLFX_12 LD A,(FXCHNS)
        OR (IY+CHRDR)
        LD (FXCHNS),A
        EX (SP),IY
        LD E,(IY+8)
        LD D,(IY+9)
        LD A,(IY+10)
        SLI D
        RLA
        RRC D
        EX (SP),IY
        LD (IY+CHCURP),A
        LD (IY+CHCURL),E
        LD (IY+CHCURH),D
        EX (SP),IY
        LD A,(IY+8)
        ADD A,(IY+11)
        LD E,A
        LD A,(IY+9)
        ADC A,(IY+12)
        LD D,A
        LD A,(IY+10)
        ADC A,(IY+13)
        SLI D
        RLA
        RRC D
        EX (SP),IY
        LD (IY+CHENDP),A
        LD (IY+CHENDL),E
        LD (IY+CHENDH),D
        LD (IY+CHLPBP),#FF
        EX (SP),IY
        LD A,(IY+16)
        INC A
        JR Z,PLFX_13
        LD A,(IY+8)
        ADD A,(IY+14)
        LD E,A
        LD A,(IY+9)
        ADC A,(IY+15)
        LD D,A
        LD A,(IY+10)
        ADC A,(IY+16)
        SLI D
        RLA
        RRC D
        EX (SP),IY
        LD (IY+CHLPBP),A
        LD (IY+CHLPBL),E
        LD (IY+CHLPBH),D
        EX (SP),IY
        LD A,(IY+8)
        ADD A,(IY+17)
        LD E,A
        LD A,(IY+9)
        ADC A,(IY+18)
        LD D,A
        LD A,(IY+10)
        ADC A,(IY+19)
        SLI D
        RLA
        RRC D
        EX (SP),IY
        LD (IY+CHLPEP),A
        LD (IY+CHLPEL),E
        LD (IY+CHLPEH),D
        EX (SP),IY
PLFX_13 LD E,(IY+20)
        LD D,(IY+21)
        LD B,(IY+31)
        LD C,(IY+23)
        LD L,(IY+22)
        LD H,(IY+6)
        EX (SP),IY
        LD (IY+CHVOL),E
        LD (IY+CHMVOL),E
        LD (IY+CHFINE),D
        LD (IY+CHNOTE),B
        LD (IY+CHPAN),C
        LD (IY+CHRLNT),L
        LD (IY+CHSQZ),H
        EX (SP),IY
        LD E,(IY+54)
        LD D,(IY+55)
        LD L,(IY+56)
        LD H,(IY+57)
        LD C,(IY+26)
        EX (SP),IY
        SRL D
        RR E
        SRL D
        RR E
        LD (IY+CHPERL),E
        LD (IY+CHPERH),D
        LD (IY+CHFRQL),L
        LD (IY+CHFRQH),H
        LD (IY+CHPRIOR),C
        LD (IY+CHFADVH),#FF
        LD (IY+CHFADVL),#FF
        LD (IY+CHDELVH),#FF
        LD (IY+CHDELVL),#FF
        LD (IY+CHEPAN),#20
        LD (IY+CHEVOL),#40
        LD (IY+CHCNTL),#00
        LD (IY+CHCNTH),#00
        LD (IY+CHVOL),#40
        LD (IY+CHPAN),#80
        SET 7,(IY+CHSTAT)
        SET 0,(IY+CHSTAT)
        PUSH IY
        POP HL
        POP IY
        LD A,#FF
        LD (PROCESS),A
        RET

;INCLUDE "MEM_H.a80"
;MEMORY MOVEMENT MODULE - HIGH PART

;PROCEDURE: MOVE MEMORY
;INPUT    : B ,HL  - SOURCE START LOGICAL ADRESS
;           C ,DE  - SOURCE END LOGICAL ADRESS
;           B',HL' - DESTINATION LOGICAL ADRESS
;OUTPUT   : C ,DE  = DEST-START
;USES     : TYPE 1 REGS,RAMPG,CPAGE,BUFFER,SYSTEM
;EFFECT   : MOVES MEMORY REGION {START,END-1} TO DEST
;           ALL ADRESSES IS LOGICAL

MOVMEM  XOR A
        LD (SYSTEM),A
        PUSH HL
        LD A,B
        EXX
        POP DE
        PUSH HL
        PUSH BC
        LD C,A
        OR A
        SBC HL,DE
        LD A,B
        SBC A,C
        EX DE,HL
        POP BC
        POP HL
        LD C,A
        OR E
        OR D
        RET Z
        EXX
        EX DE,HL
        SBC HL,DE
        LD A,C
        SBC A,B
        LD LX,A
        OR L
        OR H
        EXX
        RET Z
        PUSH DE
        PUSH BC
        BIT 7,C
        LD A,B
        EXX
        JR NZ,MOVL
        CP C
        JP C,MOVH
        JR NZ,MOVL
        EXX
        LD A,H
        EXX
        CP D
        JP C,MOVH
        JR NZ,MOVL
        EXX
        LD A,L
        EXX
        CP E
        JP C,MOVH
MOVL    SLI D
        RL B
        RRC D
        PUSH DE
        EXX
        EX DE,HL
        POP HL
        SLI D
        RL B
        RRC D
        LD A,B
        LD BC,#0000
        EXX
        LD C,A
ML1     EXX
        LD A,H
        CP D
        JR C,ML3
        JR NZ,ML2
        LD A,L
        CP E
        JR C,ML3
ML2     LD A,C
        SUB L
        LD C,A
        LD A,B
        SBC A,H
        JR ML4
ML3     LD A,C
        SUB E
        LD C,A
        LD A,B
        SBC A,D
ML4     LD B,A
        LD A,LX
        OR A
        JR NZ,ML6
        LD A,B
        EXX
        CP H
        JR C,ML7
        JR NZ,ML5
        EXX
        LD A,C
        EXX
        CP L
        JR C,ML7
ML5     PUSH HL
        EXX
        POP BC
ML6     EXX
ML7     LD D,high RAMPG
        LD A,B
        CP C
        JR NZ,ML9
        LD E,B
        LD A,(DE)
        LD (SDPAGE),A
        EXX
        PUSH BC
ML8     LD A,C
        CALL MLDI
        JP PE,ML8
        JR MLD

ML9     EXX
        PUSH BC
MLA     PUSH BC
        PUSH DE
        EXX
        LD E,B
        LD A,(DE)
        LD (SDPAGE),A
        EXX
        LD DE,BUFFER
        LD A,C
        CALL MLDI
        POP DE
        POP BC
        PUSH HL
        EXX
        LD E,C
        LD A,(DE)
        LD (SDPAGE),A
        EXX
        LD HL,BUFFER
        LD A,C
        CALL MLDI
        POP HL
        JP PE,MLA
MLD     BIT 7,H
        JR NZ,MLB
        SET 7,H
        EXX
        INC B
        JP MLC
        
MLB     SET 7,D
        EXX
        INC C
MLC     POP DE
        OR A
        SBC HL,DE
        LD A,LX
        SBC A,#00
        LD LX,A
        OR L
        OR H
        JP NZ,ML1
        POP BC
        POP DE
        RET

MOVH    LD A,L
        OR H
        JR NZ,MH0
        DEC LX
MH0     DEC HL
        EX DE,HL
        ADD HL,DE
        LD A,B
        ADC A,LX
        SLI H
        RLA
        RRC H
        LD B,A
        PUSH HL
        PUSH DE
        INC DE
        LD A,E
        OR D
        LD A,LX
        JR NZ,MHF
        INC LX
MHF     EX DE,HL
        EXX
        POP DE
        ADD HL,DE
        ADC A,B
        SLI H
        RLA
        RRC H
        EX DE,HL
        POP HL
        EXX
        LD C,A
MH1     EXX
        LD A,H
        CP D
        JR C,MH3
        JR NZ,MH2
        LD A,L
        CP E
        JR C,MH3
MH2     LD C,E
        LD B,D
        JR MH4
        
MH3     LD C,L
        LD B,H
MH4     RES 7,B
        INC BC
        LD A,LX
        OR A
        JR NZ,MH6
        LD A,B
        EXX
        CP H
        JR C,MH7
        JR NZ,MH5
        EXX
        LD A,C
        EXX
        CP L
        JR C,MH7
MH5     PUSH HL
        EXX
        POP BC
MH6     EXX
MH7     LD D,high RAMPG
        LD A,B
        CP C
        JR NZ,MH9
        LD E,B
        LD A,(DE)
        LD (SDPAGE),A
        EXX
        PUSH BC
MH8     LD A,C
        CALL MLDD
        JP PE,MH8
        JR MHD

MH9     EXX
        PUSH BC
MHA     PUSH BC
        PUSH DE
        EXX
        LD E,B
        LD A,(DE)
        LD (SDPAGE),A
        EXX
        LD DE,BUFFER+#00FF
        LD A,C
        CALL MLDD
        POP DE
        POP BC
        PUSH HL
        EXX
        LD E,C
        LD A,(DE)
        LD (SDPAGE),A
        EXX
        LD HL,BUFFER+#00FF
        LD A,C
        CALL MLDD
        POP HL
        JP PE,MHA
MHD     BIT 7,H
        JR NZ,MHB
        SET 7,H
        EXX
        DEC B
        JP MHC
MHB     SET 7,D
        EXX
        DEC C
MHC     POP DE
        OR A
        SBC HL,DE
        LD A,LX
        SBC A,#00
        LD LX,A
        OR L
        OR H
        JP NZ,MH1
        POP BC
        POP DE
        RET

;PROCEDURE: LOAD MEMORY BLOCK
;INPUT    : A,HL  - SOURCE LOGICAL ADRESS
;           DE    - DESTINATION PHISICAL ADRESS (LOW RAM)
;           BC    - BLOCK LENGTH
;USES     : TYPE 2 REGS,RAMPG,CPAGE,SYSTEM
;EFFECT   : MOVES MEMORY BLOCK FROM HIGH MEMORY TO LOW
;               SWITCH TO PAGE 0

LDMEM   SLI H
        RLA
        RRC H
LM1     LD LX,A
        PUSH HL
        LD L,A
        LD H,high RAMPG
        LD A,(HL)
        POP HL
        LD (SDPAGE),A
        ADD HL,BC
        JR NC,LM2
        JR NZ,LM4
LM2     SBC HL,BC
LM3     LD A,C
        CALL MLDI
        JP PE,LM3
        RET

LM4     XOR A
        SBC HL,BC
LM5     LD A,L
        NEG
        CALL MLDI
        BIT 7,H
        JP NZ,LM5
        SET 7,H
        LD A,LX
        INC A
        JP  LM1

;PROCEDURE: SAVE MEMORY BLOCK
;INPUT    : A,DE  - DESTINATION LOGICAL ADRESS
;           HL    - SOURCE PHISICAL ADRESS (LOW RAM)
;           BC    - BLOCK LENGTH
;USES     : TYPE 2 REGS,RAMPG,CPAGE,SYSTEM
;EFFECT   : MOVES MEMORY BLOCK FROM LOW MEMORY TO HIGH
;               SWITCH TO PAGE 0

SVMEM   SLI D
        RLA
        RRC D
SM1     LD LX,A
        PUSH HL
        LD L,A
        LD H,high RAMPG
        LD A,(HL)
        POP HL
        LD (SDPAGE),A
        EX DE,HL
        ADD HL,BC
        JR NC,SM2
        JR NZ,SM4
SM2     SBC HL,BC
        EX DE,HL
SM3     LD A,C
        CALL MLDI
        JP PE,SM3
        RET

SM4     XOR A
        SBC HL,BC
        EX DE,HL
SM5     LD A,E
        NEG
        CALL MLDI
        BIT 7,D
        JP NZ,SM5
        SET 7,D
        LD A,LX
        INC A
        JP  SM1

;INCLUDE "ENGINE_L.a80"
ENGINE  LD HL,(QTFREE)
        LD H,high QTMAP
        LD A,L
        AND #1C
        LD L,A
        LD (QTFREE),HL
        LD A,(HL)
        OR A
        JP NZ,ENG_FUL
        LD A,(CHANSFX+#000)
        RLCA
        RR C
        LD A,(CHANSFX+#040)
        RLCA
        RR C
        LD A,(CHANSFX+#080)
        RLCA
        RR C
        LD A,(CHANSFX+#0C0)
        RLCA
        RR C
        LD A,(CHANSFX+#100)
        RLCA
        RR C
        LD A,(CHANSFX+#140)
        RLCA
        RR C
        LD A,(CHANSFX+#180)
        RLCA
        RR C
        LD A,(CHANSFX+#1C0)
        RLCA
        RR C
        LD A,(GSCHNS)
        AND C
        LD C,A
        LD (FXCHNS),A
        JR NZ,ENG_01
        LD A,(MTSTAT)
        BIT 6,A
        RET NZ
        OR A
        JP M,ENG_00
        LD A,(MODULE)
        OR A
        JR NZ,ENG_01
ENG_00  XOR A
        LD (PROCESS),A
        RET

ENG_01  LD A,(MODSWCH)
        OR A
        JR NZ,ENG_03
        LD A,(MODULE)
        OR A
        JR Z,ENG_03
        LD A,#01
        LD (SGENOFF),A
        LD A,(TCKLEFT+1)
        CP #02
        JR NC,ENG_05
        OR A
        LD A,(TCKLEFT)
        JR Z,ENG_04
        SUB #80
        JR NC,ENG_05
        JP ENG_04

ENG_03  LD A,#01
        LD (SGENOFF),A
        LD A,(FXTICK+1)
        CP #02
        JR NC,ENG_05
        OR A
        LD A,(FXTICK)
        JR Z,ENG_04
        SUB #80
        JR NC,ENG_05
ENG_04  NEG
        LD (SGENOFF),A
ENG_05  XOR A
        LD (CHANNEL),A
        OR C
        JR Z,ENG_07
        LD IY,CHANSFX
        SRL C
ENG_06  PUSH BC
        CALL C,GEN
        LD BC,CHANLEN
        ADD IY,BC
        POP BC
        SRL C
        JR C,ENG_06
        JR NZ,ENG_06

ENG_07  CALL QUANTUM
        XOR A
        LD (CPAGE),A
        OUT (MPAG),A
        RET

ENG_80  LD A,(SGENOFF)
        LD E,A
        LD D,#00
        LD HL,(FXTICK)
        OR A
        SBC HL,DE
        JR Z,ENG_81
        JR C,ENG_81
        LD (FXTICK),HL
        JP ENG_82
        
ENG_81
ENG_82  LD A,(MODSWCH)
        OR A
        JR NZ,$
        LD A,(MODULE)
        OR A
        JR Z,$
        LD HL,(TCKLEFT)
        SBC HL,DE
        LD (TCKLEFT),HL
        JR NZ,ENG_83
ENG_83
ENG_FUL LD A,(PLAYING)
        OR A
        RET NZ
        DI
        XOR A
        LD (FILLALL),A
        CALL QTPLAY
        RET

;INCLUDE "FX_H.a80"

FXCHK_  LD HL,FXJP2
        JP FXCHK__
        
FXCHK   LD HL,FXJP1
FXCHK__ LD A,(IY+CHCOM)
        AND #1F
        ADD A,A
        ADD A,L
        LD L,A
        LD A,(HL)
        INC L
        LD H,(HL)
        LD L,A
        LD A,(IY+CHPARM)
        JP (HL)

FXE_    LD HL,FXEJP2
        JP FXE__
        
FXE     LD HL,FXEJP1
FXE__   RRCA
        RRCA
        RRCA
        RRCA
        AND #0F
        ADD A,A
        ADD A,L
        LD L,A
        LD A,(HL)
        INC L
        LD H,(HL)
        LD L,A
        LD A,(IY+CHPARM)
        AND #0F
        JP (HL)

FXRET   RET

FXNOP   LD L,(IY+CHPERL)
        LD H,(IY+CHPERH)
EFXNOP2 CALL EFXCNV
        LD (IY+CHFRQL),L
        LD (IY+CHFRQH),H
        RET

;---patched
EFXCNV  LD A,H
        CP #04
        JR NC,EFXCNV1
        XOR A
        LD (CPAGE),A
        OUT (MPAG),A
        ADD HL,HL
        LD A,H
        ADD A,#F8
        LD H,A
        LD A,(HL)
        INC HL
        LD H,(HL)
        LD L,A
        RET

EFXCNV1 PUSH HL
        LD E,L
        LD D,H
        ADD HL,HL
        ADD HL,HL
        ADD HL,DE
        XOR A	;HL A
        LD C,A	;DE C
        SRL D		;/2
        RR E
        RR C
        ADD A,C
        ADC HL,DE		;+/2
        SRL D		;/4
        RR E
        RR C
        SRL D		;/8
        RR E
        RR C
        ADD A,C
        ADC HL,DE		;+/8
        SRL D		;/16
        RR E
        RR C
        SRL D		;/32
        RR E
        RR C
        SRL D		;/64
        RR E
        RR C
        SRL D		;/128
        RR E
        RR C
        SRL D		;/256
        RR E
        RR C
        ADD A,C
        ADC HL,DE		;+/256
        SRL E		;/512
        RR C
        ADD A,C
        ADC HL,DE		;+/512
        SRL E		;/1024
        RR C
        ADD A,C
        ADC HL,DE		;+/1024
        SRL E		;/2048
        RR C
        SRL E		;/4096
        RR C
        ADD A,C
        ADC HL,DE		;+/4096
        SRL H
        RR L
        SRL H
        RR L
        SRL H
        RR L
        JR NC,EFXCNV2
        INC HL
EFXCNV2 POP DE
        ADD HL,DE
        ADD HL,DE
        RET
      
	INC A
	RR L
	JR NC,TUT00
	INC HL
TUT00	POP DE
	ADD HL,DE
	ADD HL,DE
	RET

ARPTAB  DEFB 0,1,2,0,1,2,0,1,2,0,1,2,0,1,2,0,1,2,0,1,2
        DEFB 0,1,2,0,1,2,0,1,2,0,1,2,0,1,2,0,1,2,0,1,2

FX0     OR A
        JP Z,FXNOP
        LD B,A
        LD A,(MTCOUNT)
        LD HL,ARPTAB
        ADD A,L
        LD L,A
        LD A,H
        ADC A,#00
        LD H,A
        LD A,(HL)
        OR A
        JP Z,FXNOP
        PUSH AF
        PUSH BC
        CALL NOTEFND
        POP BC
        POP AF
        DEC A
        LD A,B
        JR NZ,FX0_2
        RRCA
        RRCA
        RRCA
        RRCA
FX0_2   AND #0F
        ADD A,E
        LD E,A
        CP 96
        RET NC
        CALL GETFRQ
        LD (IY+CHFRQL),L
        LD (IY+CHFRQH),H
        RET

FX1     LD E,A
        LD D,#00
        LD L,(IY+CHPERL)
        LD H,(IY+CHPERH)
        OR A
        SBC HL,DE
        JR NC,FX1_2
        LD HL,#0000
FX1_2   PUSH HL
        LD HL,113
FX1_8   POP DE
        OR A
        SBC HL,DE
        JR C,FX1_9
        ADD HL,DE
        EX DE,HL
FX1_9   SET 7,(IY+CHFLAGS)
        LD (IY+CHPERL),E
        LD (IY+CHPERH),D
        PUSH DE
        EX DE,HL
        CALL EFXCNV
        LD (IY+CHFRQL),L
        LD (IY+CHFRQH),H
        POP DE
        CALL NOTEFND
        LD (IY+CHREAL),A
        RET NC
        LD (IY+CHNOTE),A
        RES 7,(IY+CHFLAGS)
        RET

FX2     LD E,A
        LD D,#00
        LD L,(IY+CHPERL)
        LD H,(IY+CHPERH)
        ADD HL,DE
        JR NC,FX2_2
        LD HL,#FFFF
FX2_2   PUSH HL
        LD HL,856
FX2_8   POP DE
        OR A
        SBC HL,DE
        JR NC,FX2_9
        ADD HL,DE
        EX DE,HL
FX2_9   SET 7,(IY+CHFLAGS)
        LD (IY+CHPERL),E
        LD (IY+CHPERH),D
        PUSH DE
        EX DE,HL
        CALL EFXCNV
        LD (IY+CHFRQL),L
        LD (IY+CHFRQH),H
        POP DE
        CALL NOTEFND
        LD (IY+CHREAL),A
        RET NC
        LD (IY+CHNOTE),A
        RES 7,(IY+CHFLAGS)
        RET

FX3     OR A
        JR Z,FX3_1
        LD (IY+CHPORT),A
FX3_1   LD A,(IY+CHWNT)
        CP 96
        RET NC
        LD E,A
        CALL GETPER
        EX DE,HL
        LD L,(IY+CHPERL)
        LD H,(IY+CHPERH)
        OR A
        SBC HL,DE
        JR Z,FX3_9
        ADD HL,DE
        LD C,(IY+CHPORT)
        LD B,#00
        JR C,FX3_5
        SBC HL,BC
        JR C,FX3_9
        SBC HL,DE
        JR C,FX3_9
FX3_2   ADD HL,DE
        LD (IY+CHPERL),L
        LD (IY+CHPERH),H
        BIT 2,(IY+CHFLAGS)
        CALL Z,EFXCNV
        BIT 2,(IY+CHFLAGS)
        JR Z,FX3_3
        EX DE,HL
        CALL NOTEFND
        LD E,A
        CALL GETFRQ
FX3_3   LD (IY+CHFRQL),L
        LD (IY+CHFRQH),H
        RET

FX3_5   ADD HL,BC
        JR C,FX3_9
        SBC HL,DE
        JR C,FX3_2
FX3_9   LD E,(IY+CHWNT)
        LD (IY+CHNOTE),E
        LD (IY+CHREAL),E
        CALL GETPER
        LD (IY+CHPERL),L
        LD (IY+CHPERH),H
        CALL GETFRQ
        LD (IY+CHFRQL),L
        LD (IY+CHFRQH),H
        RES 7,(IY+CHFLAGS)
        LD (IY+CHCOM),#00
        LD (IY+CHPARM),#00
        LD (IY+CHWNT),#7F
        RET

FX3_    RET

FX4     PUSH DE
        PUSH BC
        OR A
        JR Z,FX4_3
        LD L,A
        LD H,(IY+CHVIBCM)
        AND #0F
        JR Z,FX4_1
        XOR H
        AND #0F
        XOR H
        LD H,A
FX4_1   LD A,L
        AND #F0
        JR Z,FX4_2
        XOR H
        AND #F0
        XOR H
        LD H,A
FX4_2   LD (IY+CHVIBCM),H
FX4_3   LD D,(IY+CHVIBPS)
        LD A,D
        AND #03
        JR Z,FX4_5
        CP #03
        JR NZ,FX4_A
        LD A,R
        AND #03
        JR Z,FX4_5
        CP #03
        JR Z,FX4_5
FX4_A   DEC A
        JR Z,FX4_4
        LD E,#FF
        JP FX4_6

FX4_4   LD A,D
        AND #7C
        RLCA
        LD E,A
        BIT 7,D
        JR NZ,FX4_6
        LD A,#F8
        SUB E
        LD E,A
        JP FX4_6

FX4_5   LD A,D
        RRCA
        RRCA
        AND #1F
        LD HL,VIBTB
        ADD A,L
        LD L,A
        LD E,(HL)
FX4_6   LD A,(IY+CHVIBCM)
        AND #0F
        JR Z,FX4_9
        LD B,A
        LD HL,#0000
        LD D,H
FX4_7   ADD HL,DE
        DJNZ FX4_7
        LD B,#07
        LD A,L
FX4_8   SRL H
        RRA
        DJNZ FX4_8
        ADC A,D
        LD L,A
        LD H,#00
        BIT 7,(IY+CHVIBPS)
        JR Z,FX4_9
        DEC H
        CPL
        LD L,A
        INC HL
FX4_9   LD E,(IY+CHPERL)
        LD D,(IY+CHPERH)
        ADD HL,DE
        CALL EFXNOP2
        LD A,(IY+CHVIBCM)
        AND #F0
        RRCA
        RRCA
        ADD A,(IY+CHVIBPS)
        LD (IY+CHVIBPS),A
        POP BC
        POP DE
        RET

FX5     CALL FXA
        JP FX3_1

FX6     CALL FXA
        PUSH DE
        PUSH BC
        JP FX4_3

FX7     PUSH DE
        PUSH BC
        OR A
        JR Z,FX7_3
        LD L,A
        LD H,(IY+CHTRMCM)
        AND #0F
        JR Z,FX7_1
        XOR H
        AND #0F
        XOR H
        LD H,A
FX7_1   LD A,L
        AND #F0
        JR Z,FX7_2
        XOR H
        AND #F0
        XOR H
        LD H,A
FX7_2   LD (IY+CHTRMCM),H
FX7_3   LD D,(IY+CHTRMPS)
        LD A,D
        AND #03
        JR Z,FX7_5
        CP #03
        JR NZ,FX7_A
        LD A,R
        AND #03
        JR Z,FX7_5
        CP #03
        JR Z,FX7_5
FX7_A   DEC A
        JR Z,FX7_4
        LD E,#FF
        JP FX7_6

FX7_4   LD A,D
        AND #7C
        RLCA
        LD E,A
        BIT 7,D
        JR NZ,FX7_6
        LD A,#F8
        SUB E
        LD E,A
        JP FX7_6

FX7_5   LD A,D
        RRCA
        RRCA
        AND #1F
        LD HL,VIBTB
        ADD A,L
        LD L,A
        LD E,(HL)
FX7_6   LD A,(IY+CHTRMCM)
        AND #0F
        JR Z,FX7_9
        LD B,A
        LD HL,#0000
        LD D,H
FX7_7   ADD HL,DE
        DJNZ FX7_7
        LD B,#06
        LD A,L
FX7_8   SRL H
        RRA
        DJNZ FX7_8
        ADC A,D
        BIT 7,(IY+CHTRMPS)
        JR Z,FX7_9
        LD L,A
        LD A,(IY+CHVOL)
        SUB L
        JR NC,FX7_B
        XOR A
        JP FX7_B

FX7_9   ADD A,(IY+CHVOL)
        CP #40
        JR C,FX7_B
        LD A,#40
FX7_B   CP (IY+CHMVOL)
        LD (IY+CHMVOL),A
        JR Z,FX7_C
        SET 0,(IY+CHSTAT)
FX7_C   LD A,(IY+CHTRMCM)
        AND #F0
        RRCA
        RRCA
        ADD A,(IY+CHTRMPS)
        LD (IY+CHTRMPS),A
        POP BC
        POP DE
        RET

FX9     OR A
        RET

        JR Z,FX9_1
        LD (IY+CHOFFST),A
FX9_1   LD H,(IY+CHOFFST)
        LD L,#00
FXA     OR A
        RET Z
        LD L,A
        LD A,(IY+CHVOL)
        LD H,A
        LD A,L
        AND #F0
        JR Z,FXA_1
        RRCA
        RRCA
        RRCA
        RRCA
        ADD A,H
        CP #40
        JR C,FXA_2
        LD A,#40
        JP FXA_2
        
FXA_1   LD A,H
        SUB L
        JR NC,FXA_2
        LD A,#00
        LD (IY+CHCOM),A
        LD (IY+CHPARM),A
FXA_2   LD (IY+CHVOL),A
        CP (IY+CHMVOL)
        LD (IY+CHMVOL),A
        RET Z
        SET 0,(IY+CHSTAT)
        RET

FXB     DEC A
        LD (MTSNGPS),A
        ;CALL CP_END_MOD
        XOR A
        LD (MTBRKPS),A
        INC A
        LD (MTJMPFL),A
        RET
        
FXC     CP #40
        JR C,FXC_1
        LD A,#40
FXC_1   LD (IY+CHVOL),A
        CP (IY+CHMVOL)
        LD (IY+CHMVOL),A
        RET Z
        SET 0,(IY+CHSTAT)
        RET

FXD     LD L,A
        AND #F0
        RRCA
        LD H,A
        RRCA
        RRCA
        ADD A,H
        LD H,A
        LD A,L
        AND #0F
        ADD A,H
        CP #40
        JR C,FXD_1
        XOR A
FXD_1   LD (MTBRKPS),A
        LD A,#01
        LD (MTJMPFL),A
        RET

FXF     OR A
        JR Z,FXF_5
        CP #20
        JR NC,FXF_1
FXF_0   LD (MTSPEED),A
        RET
        
FXF_1   LD (MTBPM),A
        SUB #20
        LD HL,BPMTAB
        ADD A,A
        JR NC,FXF_3
        INC H
FXF_3   ADD A,L
        LD L,A
        JR NC,FXF_4
        INC H
FXF_4   LD A,(HL)
        INC HL
        LD H,(HL)
        LD L,A
        LD (TICKLEN),HL
        LD (TCKLEFT),HL
        RET

FXF_5   
;LD HL,MTSTAT
;---patched
        JP Patch2x
;---
        SET 7,(HL)
        RET

FXE0    AND #01
        LD (MTFILTR),A
        RET

FXE3    RES 2,(IY+CHFLAGS)
        OR A
        RET Z
        SET 2,(IY+CHFLAGS)
        RET

FXE4    RES 1,(IY+CHFLAGS)
        BIT 2,A
        JR Z,FXE4_2
        SET 1,(IY+CHFLAGS)
FXE4_2  AND #03
        LD L,A
        LD A,(IY+CHVIBPS)
        AND #FC
        OR L
        LD (IY+CHVIBPS),A
        RET

FXE5    ADD A,A
        LD (IY+CHFINE),A
        RET

FXE6    OR A
        JR Z,FXE6_3
        INC (IY+CHLPCNT)
        DEC (IY+CHLPCNT)
        JR Z,FXE6_2
        DEC (IY+CHLPCNT)
        RET Z
FXE6_1  LD A,(IY+CHPATPS)
        LD (MTBRKPS),A
        LD A,#01
        LD (MTBRKFL),A
        RET
        
FXE6_2  LD (IY+CHLPCNT),A
        JP FXE6_1
        
FXE6_3  LD A,(MTPATPS)
        LD (IY+CHPATPS),A
        RET

FXE7    RES 0,(IY+CHFLAGS)
        BIT 2,A
        JR Z,FXE7_2
        SET 0,(IY+CHFLAGS)
FXE7_2  AND #03
        LD L,A
        LD A,(IY+CHTRMPS)
        AND #FC
        OR L
        LD (IY+CHTRMPS),A
        RET

FXE9    OR A
        RET Z
        LD L,A
        LD A,(MTCOUNT)
FXE9_1  SUB L
        JR NC,FXE9_1
        ADD A,L
        RET NZ
        CALL GETSMP
        RET

FXEA    RLCA
        RLCA
        RLCA
        RLCA
        JP FXA

FXEC    LD HL,MTCOUNT
        CP (HL)
        RET NZ
        XOR A
        LD (IY+CHVOL),A
        CP (IY+CHMVOL)
        LD (IY+CHMVOL),A
        RET Z
        SET 0,(IY+CHSTAT)
        RET

FXED    LD HL,MTCOUNT
        CP (HL)
        RET NZ
        CALL GETSMP
        RET

FXEE    LD HL,MTPDT2
        INC (HL)
        DEC (HL)
        RET NZ
        INC A
        LD (MTPDT),A
        RET

;INCLUDE "VOL_H.a80"

;VOLUME CALCULATION FOR MODULES AND FX

CALCVOL RES 0,(IY+CHSTAT)
        LD DE,#FC00
        LD A,(IY+CHMVOL)
        AND #7F
        JP Z,CALCV_Z
        CP #40
        CALL C,MUL64
        LD A,(IY+CHEVOL)
        OR A
        JP Z,CALCV_Z
        CP #40
        CALL C,MUL64
        LD A,(IY+CHFADVH)
        SRL A
        SRL A
        ADC A,#00
        JP Z,CALCV_Z
        CP #40
        CALL C,MUL64
        BIT 6,(IY+CHSTAT)
        JP Z,CALCV_N
        LD A,(FXVOL)
        OR A
        JP Z,CALCV_Z
        CP #40
        CALL C,MUL64
        LD A,(FXMVOL)
        OR A
        JP Z,CALCV_Z
        CP #40
        CALL C,MUL64
        JP CALCV_X

CALCV_N LD A,(MTVOL)
        OR A
        JP Z,CALCV_Z
        CP #40
        CALL C,MUL64
        LD A,(MODVOL)
        OR A
        JP Z,CALCV_Z
        CP #40
        CALL C,MUL64
CALCV_X LD C,(IY+CHPAN)
        LD A,(IY+CHEPAN)
        SUB #20
        JR Z,CALCV_V
        JR NC,CALCV_I
        NEG
CALCV_I CP #20
        JR C,CALCV_U
        LD H,(IY+CHPAN)
        LD A,H
        OR A
        JP P,CALCV_Q
        NEG
        LD H,A
        JP CALCV_Q

CALCV_U RLCA
        RLCA
        RLCA
        LD L,A
        LD A,(IY+CHPAN)
        OR A
        JP P,CALCV_T
        NEG
CALCV_T LD B,A
        XOR A
        JP CALCV_M

CALCV_R ADD A,B
CALCV_E SRL B
CALCV_M SLA L
        JR C,CALCV_R
        JR NZ,CALCV_E
        SRL A
        LD H,A
CALCV_Q LD A,(IY+CHEPAN)
        CP #20
        JR C,CALCV_P
        LD A,C
        ADD A,H
        LD C,A
        JR NC,CALCV_V
        LD C,#FF
        JP CALCV_W
CALCV_P LD A,C
        SUB H
        LD C,#00
        JR C,CALCV_O
        LD C,A
CALCV_V LD A,C
        CP #80
        JR Z,CALCV_Y
        OR A
        JP M,CALCV_W
CALCV_O BIT 5,(IY+CHSTAT)
        JR Z,CALCV_Y
        SRL A
        CALL MUL64
        JP CALCV_Y

CALCV_W BIT 5,(IY+CHSTAT)
        JR NZ,CALCV_Y
        NEG
        SRL A
        CALL MUL64
CALCV_Y LD A,D
        SRL A
        SRL A
        ADC A,#00
CALCV_Z LD C,A
        LD HL,VOLRQTB
        LD A,L
        ADD A,(IY+CHRDN)
        LD L,A
        LD (HL),C
        RET

MUL64   LD B,A
        LD HL,#0000
        AND #0F
        JR Z,MUL64_F
        SLA B
        SLA B
        JP MUL64_E

MUL64_A ADD HL,DE
MUL64_E SRL D
        RR E
        SLA B
        JP C,MUL64_A
        JP NZ,MUL64_E
        EX DE,HL
        RET

MUL64_F LD A,B
        OR A
        JR Z,MUL64_S
        SRL D
        RR E
        CP #20
        RET Z
        LD L,E
        LD H,D
        SRL D
        RR E
        CP #10
        RET Z
        ADD HL,DE
MUL64_S EX DE,HL
        RET

;INCLUDE "TEST_H.a80"

TCOM    IN A,(ZXSTAT)
        RRCA
        JR NC,TCOM
TCOM_   IN A,(ZXCMD)
        CP #20
        JP NC,COMINT2
        CP #01
        JR Z,TCOM
        OUT (CLRCBIT),A
        LD HL,TCOMTB
        ADD A,A
        ADD A,L
        LD L,A
        LD A,(HL)
        INC L
        LD H,(HL)
        LD L,A
        JP (HL)

TCOM2   LD HL,DAC0
        LD A,#3F
        OUT (VOL1),A
TCOMDAC LD (HL),0
        LD A,(HL)
        LD IY,TCONT1
        JP TWAIT
        
TCONT1  LD (HL),#FF
        LD A,(HL)
        LD IY,TCOMDAC
        JP TWAIT

TCOM3   LD HL,DAC1
        LD A,#3F
        OUT (VOL2),A
        JR TCOMDAC
        
TCOM4   LD HL,DAC2
        LD A,#3F
        OUT (VOL3),A
        JR TCOMDAC
        
TCOM5   LD HL,DAC3
        LD A,#3F
        OUT (VOL4),A
        JR TCOMDAC

TCOM6   XOR A
        OUT (ZXDATWR),A
        LD IY,TCONT2
        JP TWAIT
        
TCONT2  LD A,#FF
        OUT (ZXDATWR),A
        LD IY,TCOM6
        JP TWAIT

TCOM7   LD C,VOL1
        LD HL,DAC0
        LD (HL),#FF
        LD A,(HL)
TCOMVOL LD A,#00
        OUT (C),A
        LD IY,TCONT3
        JP TWAIT
        
TCONT3  LD A,#FF
        OUT (C),A
        LD IY,TCOMVOL
        JP TWAIT

TCOM8   LD C,VOL2
        LD HL,DAC1
        LD (HL),#FF
        LD A,(HL)
        JR TCOMVOL
        
TCOM9   LD C,VOL3
        LD HL,DAC2
        LD (HL),#FF
        LD A,(HL)
        JR TCOMVOL
        
TCOMA   LD C,VOL4
        LD HL,DAC3
        LD (HL),#FF
        LD A,(HL)
        JR TCOMVOL

TCOMB   LD HL,DAC0
        LD C,VOL1
TCOMTST LD B,#3F
TCOMT4  OUT (C),B
        LD D,114
TCOMT5  LD (HL),#00
        LD A,(HL)
        XOR A
TCOMT6  DEC A
        JR NZ,TCOMT6
        LD (HL),#FF
        LD A,(HL)
        XOR A
TCOMT7  DEC A
        JR NZ,TCOMT7
        DEC D
        JR NZ,TCOMT5
        DEC B
        JP P,TCOMT4
        IN A,(ZXSTAT)
        RRCA
        JR NC,TCOMTST
        JP TCOM_

TCOMC   LD HL,DAC1
        LD C,VOL2
        JP TCOMTST
        
TCOMD   LD HL,DAC2
        LD C,VOL3
        JP TCOMTST
        
TCOME   LD HL,DAC3
        LD C,VOL4
        JP TCOMTST

TCOMF   LD A,#3F
        OUT (VOL1),A
        OUT (VOL2),A
        OUT (VOL3),A
        OUT (VOL4),A
        LD B,#00
        LD L,B
TCONT8  LD H,high DAC0
        LD (HL),B
        LD A,(HL)
        INC H
        LD (HL),B
        LD A,(HL)
        INC H
        LD (HL),B
        LD A,(HL)
        INC H
        LD (HL),B
        LD A,(HL)
        DJNZ TCONT8
        IN A,(ZXSTAT)
        RRCA
        JP NC,TCONT8
        JP TCOM_

TCOM10  IN A,(ZXDATRD)
        OUT (ZXDATWR),A
        JP TCOM_
        
TCOM11  IN A,(ZXDATRD)
        JP TCOM_

TCOM12  LD HL,DAC0
TCONT9  LD A,#3F
        OUT (VOL1),A
        OUT (VOL2),A
        OUT (VOL3),A
        OUT (VOL4),A
TCONTA  IN A,(ZXDATRD)
        LD (HL),A
        LD A,(HL)
TCONTB  DJNZ TCONTB
        LD (HL),#00
        LD A,(HL)
TCONTC  DJNZ TCONTC
        IN A,(ZXSTAT)
        RRCA
        JP C,TCOM_
        JP TCONTA

TCOM13  LD HL,DAC1
        JR TCONT9
        
TCOM14  LD HL,DAC2
        JR TCONT9
        
TCOM15  LD HL,DAC3
        JR TCONT9

TWAIT   LD B,#04
TWAIT1  LD DE,38686
TWAIT2  IN A,(ZXSTAT)
        RRCA
        JP C,TCOM_
        DEC DE
        LD A,D
        OR E
        JR NZ,TWAIT2
        DJNZ TWAIT2
        JP (IY)

;INCLUDE "TABLES_H.a80"

	align 256
	
VIBTB	db #00,#18,#31,#4A,#61,#78,#8D,#A1
	db #B4,#C5,#D4,#E0,#EB,#F4,#FA,#FD
	db #FF,#FD,#FA,#F4,#EB,#E0,#D4,#C5
	db #B4,#A1,#8D,#78,#61,#4A,#31,#18

COMTABH DB low COM20,low COM21,low COM22,low COM23,low COMHZ,low COMHZ,low COMHZ,low COMHZ  ;#20
        DB low COMHZ,low COMHZ,low COM2A,low COM2B,low COM2C,low COM2D,low COM2E,low COM2F  ;#28
        DB low COM30,low COM31,low COM32,low COM33,low COM34,low COM35,low COM36,low COM37  ;#30
        DB low COM38,low COM39,low COM3A,low COM3B,low COM3C,low COM3D,low COM3E,low COM3F  ;#38
        DB low COM40,low COM41,low COM42,low COMHZ,low COMHZ,low COM45,low COM46,low COM47  ;#40
        DB low COM48,low COM49,low COMHZ,low COMHZ,low COMHZ,low COMHZ,low COMHZ,low COMHZ  ;#48
        DB low COM50,low COMHZ,low COMHZ,low COMHZ,low COMHZ,low COMHZ,low COMHZ,low COMHZ  ;#50
        DB low COMHZ,low COMHZ,low COMHZ,low COMHZ,low COMHZ,low COMHZ,low COMHZ,low COMHZ  ;#58
        DB low COM60,low COM61,low COM62,low COM63,low COM64,low COM65,low COM66,low COM67  ;#60
        DB low COM68,low COM69,low COM6A,low COM6B,low COMHZ,low COMHZ,low COMHZ,low COMHZ  ;#68 patched
        DB low COMHZ,low COMHZ,low COMHZ,low COMHZ,low COMHZ,low COMHZ,low COMHZ,low COMHZ  ;#70
        DB low COMHZ,low COMHZ,low COMHZ,low COMHZ,low COMHZ,low COMHZ,low COMHZ,low COMHZ  ;#78
        DB low COM80,low COM80,low COM80,low COM80,low COM80,low COM80,low COM80,low COM80  ;#80
        DB low COM80,low COM80,low COM80,low COM80,low COM80,low COM80,low COM80,low COM80  ;#88
        DB low COM80,low COM80,low COM80,low COM80,low COM80,low COM80,low COM80,low COM80  ;#90
        DB low COM80,low COM80,low COM80,low COM80,low COM80,low COM80,low COM80,low COM80  ;#98
        DB low COMA0,low COMA0,low COMA0,low COMA0,low COMA0,low COMA0,low COMA0,low COMA0  ;#A0
        DB low COMA0,low COMA0,low COMA0,low COMA0,low COMA0,low COMA0,low COMA0,low COMA0  ;#A8
        DB low COMHZ,low COMHZ,low COMHZ,low COMHZ,low COMHZ,low COMHZ,low COMHZ,low COMHZ  ;#B0
        DB low COMHZ,low COMHZ,low COMHZ,low COMHZ,low COMHZ,low COMHZ,low COMHZ,low COMHZ  ;#B8
        DB low COMHZ,low COMHZ,low COMHZ,low COMHZ,low COMHZ,low COMHZ,low COMHZ,low COMHZ  ;#C0
        DB low COMHZ,low COMHZ,low COMHZ,low COMHZ,low COMHZ,low COMHZ,low COMHZ,low COMHZ  ;#C8
        DB low COMHZ,low COMHZ,low COMHZ,low COMHZ,low COMHZ,low COMHZ,low COMHZ,low COMHZ  ;#D0
        DB low COMHZ,low COMHZ,low COMHZ,low COMHZ,low COMHZ,low COMHZ,low COMHZ,low COMHZ  ;#D8
        DB low COMHZ,low COMHZ,low COMHZ,low COMHZ,low COMHZ,low COMHZ,low COMHZ,low COMHZ  ;#E0
        DB low COMHZ,low COMHZ,low COMHZ,low COMHZ,low COMHZ,low COMHZ,low COMHZ,low COMHZ  ;#E8

        DEFS #10
        DEFS #20

	DB high COM20,high COM21,high COM22,high COM23,high COMHZ,high COMHZ,high COMHZ,high COMHZ  ;#20
        DB high COMHZ,high COMHZ,high COM2A,high COM2B,high COM2C,high COM2D,high COM2E,high COM2F  ;#28
        DB high COM30,high COM31,high COM32,high COM33,high COM34,high COM35,high COM36,high COM37  ;#30
        DB high COM38,high COM39,high COM3A,high COM3B,high COM3C,high COM3D,high COM3E,high COM3F  ;#38
        DB high COM40,high COM41,high COM42,high COMHZ,high COMHZ,high COM45,high COM46,high COM47  ;#40
        DB high COM48,high COM49,high COMHZ,high COMHZ,high COMHZ,high COMHZ,high COMHZ,high COMHZ  ;#48
        DB high COM50,high COMHZ,high COMHZ,high COMHZ,high COMHZ,high COMHZ,high COMHZ,high COMHZ  ;#50
        DB high COMHZ,high COMHZ,high COMHZ,high COMHZ,high COMHZ,high COMHZ,high COMHZ,high COMHZ  ;#58
        DB high COM60,high COM61,high COM62,high COM63,high COM64,high COM65,high COM66,high COM67  ;#60
        DB high COM68,high COM69,high COM6A,high COM6B,high COMHZ,high COMHZ,high COMHZ,high COMHZ  ;#68 patched
        DB high COMHZ,high COMHZ,high COMHZ,high COMHZ,high COMHZ,high COMHZ,high COMHZ,high COMHZ  ;#70
        DB high COMHZ,high COMHZ,high COMHZ,high COMHZ,high COMHZ,high COMHZ,high COMHZ,high COMHZ  ;#78
        DB high COM80,high COM80,high COM80,high COM80,high COM80,high COM80,high COM80,high COM80  ;#80
        DB high COM80,high COM80,high COM80,high COM80,high COM80,high COM80,high COM80,high COM80  ;#88
        DB high COM80,high COM80,high COM80,high COM80,high COM80,high COM80,high COM80,high COM80  ;#90
        DB high COM80,high COM80,high COM80,high COM80,high COM80,high COM80,high COM80,high COM80  ;#98
        DB high COMA0,high COMA0,high COMA0,high COMA0,high COMA0,high COMA0,high COMA0,high COMA0  ;#A0
        DB high COMA0,high COMA0,high COMA0,high COMA0,high COMA0,high COMA0,high COMA0,high COMA0  ;#A8
        DB high COMHZ,high COMHZ,high COMHZ,high COMHZ,high COMHZ,high COMHZ,high COMHZ,high COMHZ  ;#B0
        DB high COMHZ,high COMHZ,high COMHZ,high COMHZ,high COMHZ,high COMHZ,high COMHZ,high COMHZ  ;#B8
        DB high COMHZ,high COMHZ,high COMHZ,high COMHZ,high COMHZ,high COMHZ,high COMHZ,high COMHZ  ;#C0
        DB high COMHZ,high COMHZ,high COMHZ,high COMHZ,high COMHZ,high COMHZ,high COMHZ,high COMHZ  ;#C8
        DB high COMHZ,high COMHZ,high COMHZ,high COMHZ,high COMHZ,high COMHZ,high COMHZ,high COMHZ  ;#D0
        DB high COMHZ,high COMHZ,high COMHZ,high COMHZ,high COMHZ,high COMHZ,high COMHZ,high COMHZ  ;#D8
        DB high COMHZ,high COMHZ,high COMHZ,high COMHZ,high COMHZ,high COMHZ,high COMHZ,high COMHZ  ;#E0
        DB high COMHZ,high COMHZ,high COMHZ,high COMHZ,high COMHZ,high COMHZ,high COMHZ,high COMHZ  ;#E8

        DEFS #10

FXJP1   DW FXNOP,FXNOP,FXNOP,FXNOP,FXNOP,FXNOP,FXNOP,FXNOP
        DW FXNOP,FXNOP,FXNOP,FXB  ,FXC  ,FXD  ,FXE  ,FXF

        DW FXRET,FXRET,FXRET,FXRET,FXRET,FXRET,FXRET,FXRET
        DW FXRET,FXRET,FXRET,FXRET,FXRET,FXRET,FXRET,FXRET

FXJP2   DW FX0  ,FX1  ,FX2  ,FX3  ,FX4  ,FX5  ,FX6  ,FX7
        DW FXRET,FXRET,FXA  ,FXRET,FXRET,FXRET,FXE_ ,FXRET

        DW FXRET,FXRET,FXRET,FXRET,FXRET,FXRET,FXRET,FXRET
        DW FXRET,FXRET,FXRET,FXRET,FXRET,FXRET,FXRET,FXRET

FXEJP1  DW FXE0,FX1,FX2,FXE3,FXE4,FXE5,FXE6,FXE7
        DW FXRET,FXE9,FXEA,FXA,FXEC,FXED,FXEE,FXRET

FXEJP2  DW FXRET,FXRET,FXRET,FXRET,FXRET,FXRET,FXRET,FXRET
        DW FXRET,FXE9,FXRET,FXRET,FXEC,FXED,FXRET,FXRET

TCOMTB  DEFW TCOM,TCOM,TCOM2,TCOM3,TCOM4,TCOM5,TCOM6,TCOM7
        DEFW TCOM8,TCOM9,TCOMA,TCOMB,TCOMC,TCOMD,TCOME,TCOMF
        DEFW TCOM10,TCOM11,TCOM12,TCOM13,TCOM14,TCOM15,TCOM,TCOM
        DEFW TCOM,TCOM,TCOM,TCOM,TCOM,TCOM,TCOM,TCOM

;INCLUDE "DIHO.a80"
;RETURN: E - NOTE

NOTEID  LD HL,AMINOTE
        CALL DIH
        LD E,A
        RET

;RETURN: E - NOTE

NOTEGET LD E,(IY+CHNOTE)
        LD A,E
        INC A
        RET NZ
NOTEFND LD HL,AMFRQTB
        LD A,(IY+CHFINE)
        RRA
        AND #0F
        JR Z,NOTEFN1
        LD C,A
        ADD A,A
        ADD A,C
        ADD A,A
        ADD A,A
        ADD A,A
        LD B,0
        RL B
        ADD A,A
        RL B
        ADD A,A
        RL B
        LD C,A
        ADD HL,BC
NOTEFN1 LD E,(IY+CHPERL)
        LD D,(IY+CHPERH)
        CALL DIH
        LD E,A
        RET

DIH     LD BC,#005F
        PUSH HL
        INC HL
        LD A,(HL)
        DEC HL
        CP D
        JR C,DIHRGR
        JR NZ,DIH2
        LD A,(HL)
        CP E
        JR C,DIHRGR
        JR NZ,DIH2
        POP HL
        XOR A
        SCF
        RET
        
DIHRGR  LD E,(HL)
        INC HL
        LD D,(HL)
        POP HL
        XOR A
        RET
        
DIH2    LD A,#BF
        ADD A,L
        LD L,A
        LD A,H
        ADC A,B
        LD H,A
        LD A,(HL)
        DEC HL
        CP D
        JR C,DIH3
        JR NZ,DIHRLO
        LD A,(HL)
        CP E
        JR C,DIH3
        JR NZ,DIHRLO
        POP HL
        LD A,C
        SCF
        RET
        
DIHRLO  LD E,(HL)
        INC HL
        LD D,(HL)
        POP HL
        LD A,C
        OR A
        RET

DIH3    POP HL
DIHLP   PUSH HL
        LD A,B
        ADD A,C
        AND #FE
        ADD A,L
        LD L,A
        LD A,H
        ADC A,#00
        LD H,A
        INC HL
        LD A,(HL)
        DEC HL
        CP D
        JR C,DIHGR
        JR NZ,DIHLO
        LD A,(HL)
        CP E
        JR C,DIHGR
        JR NZ,DIHLO
        POP HL
        LD A,B
        ADD A,C
        SRL A
        SCF
        RET

DIHGR   LD A,B
        ADD A,C
        SRL A
        LD C,A
        POP HL
        JP DIHLP

DIHLO   LD A,B
        ADD A,C
        SRL A
        CP B
        LD B,A
        JR Z,DIHMID
        POP HL
        JP DIHLP

DIHMID  PUSH HL
        PUSH BC
        LD A,(HL)
        INC HL
        SUB E
        LD C,A
        LD A,(HL)
        INC HL
        SBC A,D
        LD B,A
        LD A,(HL)
        INC HL
        LD H,(HL)
        LD L,A
        EX DE,HL
        OR A
        SBC HL,DE
        LD A,H
        CP B
        JR C,DIHFLO
        JR NZ,DIHFGR
        LD A,L
        CP C
        JR C,DIHFLO
        JR NZ,DIHFGR
DIHFLO  POP BC
        POP HL
        POP HL
        LD A,C
        OR A
        RET
        
DIHFGR  POP BC
        POP HL
        LD E,(HL)
        INC HL
        LD D,(HL)
        POP HL
        LD A,B
        RET

AMINOTE dw #1AC0,#1940,#17D0,#1680,#1530,#1400,#12E0,#11D0,#10D0,#0FE0,#0F00,#0E28;C-0
	dw #0D60,#0CA0,#0BE8,#0B40,#0A98,#0A00,#0970,#08E8,#0868,#07F0,#0780,#0714;C-1
	dw #06B0,#0650,#05F4,#05A0,#054C,#0500,#04B8,#0474,#0434,#03F8,#03C0,#038A;C-2
	dw #0358,#0328,#02FA,#02D0,#02A6,#0280,#025C,#023A,#021A,#01FC,#01E0,#01C5;C-3
	dw #01AC,#0194,#017D,#0168,#0153,#0140,#012E,#011D,#010D,#00FE,#00F0,#00E2;C-4
	dw #00D6,#00CA,#00BE,#00B4,#00AA,#00A0,#0097,#008F,#0087,#007F,#0078,#0071;C-5
	dw #006B,#0065,#005F,#005A,#0055,#0050,#004B,#0047,#0043,#003F,#003C,#0038;C-6
	dw #0035,#0032,#002F,#002D,#002A,#0028,#0025,#0023,#0021,#001F,#001E,#001C;C-7
___END

        ORG GSRomBaseH+#2000
	
;INCLUDE "_GSFRQTB.a80" ;patched
GSFRQTB	
;00
	dw #4854,#4446,#4071,#3CD1,#3968,#362F,#3324,#3045,#2D91,#2B02,#2897,#2652
	dw #242A,#2223,#2037,#1E68,#1CB5,#1B17,#1992,#1822,#16C8,#1581,#144D,#1329
	dw #1215,#1111,#101B,#0F35,#0E5A,#0D8D,#0CCA,#0C12,#0B62,#0AC0,#0A26,#0994
	dw #090A,#0888,#080F,#079A,#072C,#06C5,#0663,#0607,#05B1,#0560,#0511,#04C8
	dw #0485,#0444,#0406,#03CD,#0397,#0363,#0333,#0305,#02DA,#02AE,#0288,#0265
	dw #0242,#0222,#0204,#01E6,#01CB,#01B0,#0198,#0182,#016D,#0157,#0144,#0131
	dw #0121,#0111,#0100,#00F3,#00E5,#00D8,#00CD,#00BF,#00B5,#00AD,#00A2,#009A
	dw #0092,#0087,#0081,#0079,#0071,#006C,#0066,#0061,#005B,#0056,#0051,#004B
;01
	dw #47D0,#43C7,#3FFA,#3C62,#38FE,#35CB,#32C6,#2FEE,#2D3D,#2AB4,#284E,#260B
	dw #23E6,#21E5,#1FFB,#1E32,#1C7F,#1AE7,#1964,#17F7,#169D,#1558,#1427,#1305
	dw #11F4,#10F1,#0FFD,#0F18,#0E3F,#0D72,#0CB2,#0BFA,#0B4F,#0AAD,#0A13,#0981
	dw #08FA,#0878,#07FE,#078D,#0721,#06BA,#0659,#05FD,#05A6,#0555,#0509,#04C0
	dw #047D,#043C,#0400,#03C5,#038F,#035B,#032B,#02FF,#02D4,#02AC,#0283,#0260
	dw #023D,#021F,#01FF,#01E4,#01C8,#01AD,#0195,#017F,#016A,#0154,#0141,#0131
	dw #011E,#010E,#0100,#00F0,#00E3,#00D8,#00CA,#00BF,#00B5,#00AA,#00A2,#0097
	dw #008F,#0087,#007F,#0079,#0071,#006C,#0066,#005E,#0059,#0056,#0051,#004B
;02
	dw #474C,#434B,#3F83,#3BF3,#3895,#356A,#326A,#2F95,#2CE9,#2A63,#2802,#25C5
	dw #23A6,#21A4,#1FC2,#1DF9,#1C4C,#1AB3,#1933,#17C9,#1674,#1532,#1401,#12E2
	dw #11D1,#10D3,#0FE0,#0EFC,#0E24,#0D59,#0C99,#0BE4,#0B3A,#0A98,#0A00,#0971
	dw #08EA,#0868,#07F1,#077D,#0713,#06AC,#064E,#05F2,#059E,#054D,#0501,#04B8
	dw #0475,#0434,#03F8,#03BF,#0389,#0356,#0325,#02FA,#02CF,#02A6,#0280,#025A
	dw #023A,#021A,#01FC,#01DE,#01C3,#01AB,#0192,#017D,#0167,#0152,#013F,#012E
	dw #011B,#010E,#00FE,#00F0,#00E3,#00D5,#00CA,#00BD,#00B2,#00AA,#009F,#0097
	dw #008F,#0087,#007F,#0076,#0071,#006C,#0064,#005E,#0059,#0053,#0051,#004B
;03
	dw #46C7,#42CE,#3F0E,#3B85,#382E,#3506,#320E,#2F3E,#2C98,#2A17,#27B9,#257F
	dw #2365,#2168,#1F87,#1DC3,#1C15,#1A83,#1905,#179E,#164C,#150A,#13DB,#12BF
	dw #11B1,#10B3,#0FC5,#0EE1,#0E0C,#0D41,#0C84,#0BCF,#0B24,#0A85,#09ED,#095E
	dw #08D9,#085A,#07E1,#076F,#0706,#06A2,#0640,#05E7,#0593,#0542,#04F6,#04B0
	dw #046C,#042C,#03F0,#03B7,#0381,#0351,#0320,#02F5,#02C9,#02A1,#027B,#0258
	dw #0235,#0217,#01F9,#01DB,#01C0,#01A8,#0190,#017A,#0164,#0152,#013F,#012C
	dw #011B,#010B,#00FB,#00ED,#00E0,#00D2,#00C8,#00BD,#00B2,#00A7,#009F,#0094
	dw #008C,#0084,#007F,#0076,#0071,#0069,#0064,#005E,#0059,#0053,#004E,#004B
;04
	dw #4645,#4255,#3E9A,#3B18,#37C7,#34A4,#31AF,#2EE5,#2C44,#29C9,#2770,#2538
	dw #2324,#212A,#1F4E,#1D8B,#1BE2,#1A52,#18D7,#1772,#1623,#14E4,#13B8,#129C
	dw #1190,#1095,#0FA7,#0EC6,#0DF1,#0D29,#0C6B,#0BB9,#0B11,#0A72,#09DA,#094E
	dw #08C9,#084A,#07D3,#0762,#06F8,#0694,#0635,#05DC,#0588,#0537,#04EE,#04A8
	dw #0464,#0423,#03E8,#03B2,#037C,#034B,#031A,#02EF,#02C4,#029B,#0276,#0252
	dw #0232,#0211,#01F4,#01D9,#01BE,#01A5,#018D,#0177,#0162,#014F,#013C,#0129
	dw #0119,#0108,#00FB,#00EB,#00E0,#00D2,#00C8,#00BA,#00AF,#00A7,#009C,#0094
	dw #008C,#0084,#007C,#0076,#006E,#0069,#0064,#005E,#0059,#0053,#004E,#004B
;05
	dw #45C3,#41D8,#3E29,#3AAA,#3761,#3443,#3156,#2E8F,#2BF3,#297A,#2727,#24F5
	dw #22E3,#20EC,#1F13,#1D55,#1BAF,#1A21,#18A9,#1747,#15FB,#14BE,#1395,#1279
	dw #1170,#1077,#0F89,#0EAB,#0DD8,#0D10,#0C56,#0BA3,#0AFC,#0A5F,#09CA,#093E
	dw #08B9,#083A,#07C6,#0754,#06EB,#0689,#062B,#05D1,#057E,#052F,#04E3,#049D
	dw #045C,#041E,#03E3,#03AA,#0376,#0343,#0315,#02EA,#02BF,#0296,#0273,#0250
	dw #022D,#020F,#01F1,#01D6,#01BB,#01A3,#018A,#0175,#015F,#014C,#0139,#0126
	dw #0116,#0106,#00F8,#00EB,#00DD,#00D0,#00C5,#00BA,#00AF,#00A4,#009C,#0094
	dw #008C,#0084,#007C,#0074,#006E,#0069,#0061,#005B,#0059,#0053,#004E,#0049
;06
	dw #4544,#4161,#3DB4,#3A3D,#36FA,#33E4,#30FA,#2E3B,#2BA2,#292E,#26DE,#24B1
	dw #22A2,#20B0,#1EDA,#1D1E,#1B7B,#19F1,#187B,#171C,#15D2,#1498,#136F,#1258
	dw #114F,#1057,#0F6E,#0E90,#0DBD,#0CF8,#0C3D,#0B8E,#0AE9,#0A4C,#09B7,#092B
	dw #08A9,#082C,#07B5,#0747,#06E0,#067C,#0620,#05C7,#0573,#0524,#04DB,#0495
	dw #0454,#0416,#03DA,#03A4,#036E,#033E,#0310,#02E4,#02B9,#0293,#026D,#024A
	dw #022A,#0209,#01EE,#01D1,#01B8,#01A0,#0188,#0172,#015C,#0149,#0136,#0126
	dw #0113,#0106,#00F6,#00E8,#00DB,#00D0,#00C2,#00B7,#00AF,#00A4,#009C,#0092
	dw #0089,#0081,#007C,#0074,#006E,#0066,#0061,#005B,#0056,#0051,#004E,#0049
;07
	dw #44C3,#40E8,#3D43,#39D4,#3693,#3383,#30A1,#2DE4,#2B51,#28E3,#2698,#246E
	dw #2261,#2075,#1EA1,#1CE8,#1B4B,#19C3,#1850,#16F3,#15A9,#1472,#134C,#1235
	dw #1132,#1039,#0F50,#0E75,#0DA5,#0CE0,#0C28,#0B78,#0AD3,#0A39,#09A4,#091A
	dw #0899,#081C,#07A8,#0739,#06D2,#0671,#0612,#05BC,#056B,#051C,#04D3,#048D
	dw #044C,#040E,#03D5,#039C,#0369,#0338,#030A,#02DF,#02B4,#028E,#0268,#0248
	dw #0224,#0207,#01E9,#01CE,#01B3,#019B,#0185,#016F,#015A,#0147,#0134,#0124
	dw #0113,#0103,#00F6,#00E8,#00DB,#00CD,#00C2,#00B7,#00AD,#00A2,#009A,#0092
	dw #0089,#0081,#0079,#0074,#006C,#0066,#0061,#005B,#0056,#0051,#004E,#0049
;08
	dw #4CA1,#4854,#4446,#4071,#3CD1,#3968,#362F,#3324,#3045,#2D91,#2B02,#2897
	dw #2652,#242A,#2223,#2037,#1E68,#1CB5,#1B17,#1992,#1822,#16C8,#1581,#144D
	dw #1329,#1215,#1111,#101B,#0F35,#0E5A,#0D8D,#0CCA,#0C12,#0B62,#0AC0,#0A26
	dw #0994,#090A,#0888,#080F,#079A,#072C,#06C5,#0663,#0607,#05B1,#0560,#0511
	dw #04C8,#0485,#0444,#0406,#03CD,#0397,#0363,#0333,#0305,#02DA,#02AE,#0288
	dw #0265,#0242,#0222,#0204,#01E6,#01CB,#01B0,#0198,#0182,#016D,#0157,#0144
	dw #0131,#0121,#0111,#0100,#00F3,#00E5,#00D8,#00CD,#00BF,#00B5,#00AD,#00A2
	dw #009A,#0092,#0087,#0081,#0079,#0071,#006C,#0066,#0061,#005B,#0056,#0051
;09
	dw #4C14,#47D0,#43C7,#3FFA,#3C62,#38FE,#35CB,#32C6,#2FEE,#2D3D,#2AB4,#284E
	dw #260B,#23E6,#21E5,#1FFB,#1E32,#1C7F,#1AE7,#1964,#17F7,#169D,#1558,#1427
	dw #1305,#11F4,#10F1,#0FFD,#0F18,#0E3F,#0D72,#0CB2,#0BFA,#0B4F,#0AAD,#0A13
	dw #0981,#08FA,#0878,#07FE,#078D,#0721,#06BA,#0659,#05FD,#05A6,#0555,#0509
	dw #04C0,#047D,#043C,#0400,#03C5,#038F,#035B,#032B,#02FF,#02D4,#02AC,#0283
	dw #0260,#023D,#021F,#01FF,#01E4,#01C8,#01AD,#0195,#017F,#016A,#0154,#0141
	dw #0131,#011E,#010E,#0100,#00F0,#00E3,#00D8,#00CA,#00BF,#00B5,#00AA,#00A2
	dw #0097,#008F,#0087,#007F,#0079,#0071,#006C,#0066,#005E,#0059,#0056,#0051
;0A
	dw #4B88,#474C,#434B,#3F83,#3BF3,#3895,#356A,#326A,#2F95,#2CE9,#2A63,#2802
	dw #25C5,#23A6,#21A4,#1FC2,#1DF9,#1C4C,#1AB3,#1933,#17C9,#1674,#1532,#1401
	dw #12E2,#11D1,#10D3,#0FE0,#0EFC,#0E24,#0D59,#0C99,#0BE4,#0B3A,#0A98,#0A00
	dw #0971,#08EA,#0868,#07F1,#077D,#0713,#06AC,#064E,#05F2,#059E,#054D,#0501
	dw #04B8,#0475,#0434,#03F8,#03BF,#0389,#0356,#0325,#02FA,#02CF,#02A6,#0280
	dw #025A,#023A,#021A,#01FC,#01DE,#01C3,#01AB,#0192,#017D,#0167,#0152,#013F
	dw #012E,#011B,#010E,#00FE,#00F0,#00E3,#00D5,#00CA,#00BD,#00B2,#00AA,#009F
	dw #0097,#008F,#0087,#007F,#0076,#0071,#006C,#0064,#005E,#0059,#0053,#0051
;0B
	dw #4AFE,#46C7,#42CE,#3F0E,#3B85,#382E,#3506,#320E,#2F3E,#2C98,#2A17,#27B9
	dw #257F,#2365,#2168,#1F87,#1DC3,#1C15,#1A83,#1905,#179E,#164C,#150A,#13DB
	dw #12BF,#11B1,#10B3,#0FC5,#0EE1,#0E0C,#0D41,#0C84,#0BCF,#0B24,#0A85,#09ED
	dw #095E,#08D9,#085A,#07E1,#076F,#0706,#06A2,#0640,#05E7,#0593,#0542,#04F6
	dw #04B0,#046C,#042C,#03F0,#03B7,#0381,#0351,#0320,#02F5,#02C9,#02A1,#027B
	dw #0258,#0235,#0217,#01F9,#01DB,#01C0,#01A8,#0190,#017A,#0164,#0152,#013F
	dw #012C,#011B,#010B,#00FB,#00ED,#00E0,#00D2,#00C8,#00BD,#00B2,#00A7,#009F
	dw #0094,#008C,#0084,#007F,#0076,#0071,#0069,#0064,#005E,#0059,#0053,#004E
;0C
	dw #4A74,#4645,#4255,#3E9A,#3B18,#37C7,#34A4,#31AF,#2EE5,#2C44,#29C9,#2770
	dw #2538,#2324,#212A,#1F4E,#1D8B,#1BE2,#1A52,#18D7,#1772,#1623,#14E4,#13B8
	dw #129C,#1190,#1095,#0FA7,#0EC6,#0DF1,#0D29,#0C6B,#0BB9,#0B11,#0A72,#09DA
	dw #094E,#08C9,#084A,#07D3,#0762,#06F8,#0694,#0635,#05DC,#0588,#0537,#04EE
	dw #04A8,#0464,#0423,#03E8,#03B2,#037C,#034B,#031A,#02EF,#02C4,#029B,#0276
	dw #0252,#0232,#0211,#01F4,#01D9,#01BE,#01A5,#018D,#0177,#0162,#014F,#013C
	dw #0129,#0119,#0108,#00FB,#00EB,#00E0,#00D2,#00C8,#00BA,#00AF,#00A7,#009C
	dw #0094,#008C,#0084,#007C,#0076,#006E,#0069,#0064,#005E,#0059,#0053,#004E
;0D
	dw #49EA,#45C3,#41D8,#3E29,#3AAA,#3761,#3443,#3156,#2E8F,#2BF3,#297A,#2727
	dw #24F5,#22E3,#20EC,#1F13,#1D55,#1BAF,#1A21,#18A9,#1747,#15FB,#14BE,#1395
	dw #1279,#1170,#1077,#0F89,#0EAB,#0DD8,#0D10,#0C56,#0BA3,#0AFC,#0A5F,#09CA
	dw #093E,#08B9,#083A,#07C6,#0754,#06EB,#0689,#062B,#05D1,#057E,#052F,#04E3
	dw #049D,#045C,#041E,#03E3,#03AA,#0376,#0343,#0315,#02EA,#02BF,#0296,#0273
	dw #0250,#022D,#020F,#01F1,#01D6,#01BB,#01A3,#018A,#0175,#015F,#014C,#0139
	dw #0126,#0116,#0106,#00F8,#00EB,#00DD,#00D0,#00C5,#00BA,#00AF,#00A4,#009C
	dw #0094,#008C,#0084,#007C,#0074,#006E,#0069,#0061,#005B,#0059,#0053,#004E
;0E
	dw #4963,#4544,#4161,#3DB4,#3A3D,#36FA,#33E4,#30FA,#2E3B,#2BA2,#292E,#26DE
	dw #24B1,#22A2,#20B0,#1EDA,#1D1E,#1B7B,#19F1,#187B,#171C,#15D2,#1498,#136F
	dw #1258,#114F,#1057,#0F6E,#0E90,#0DBD,#0CF8,#0C3D,#0B8E,#0AE9,#0A4C,#09B7
	dw #092B,#08A9,#082C,#07B5,#0747,#06E0,#067C,#0620,#05C7,#0573,#0524,#04DB
	dw #0495,#0454,#0416,#03DA,#03A4,#036E,#033E,#0310,#02E4,#02B9,#0293,#026D
	dw #024A,#022A,#0209,#01EE,#01D1,#01B8,#01A0,#0188,#0172,#015C,#0149,#0136
	dw #0126,#0113,#0106,#00F6,#00E8,#00DB,#00D0,#00C2,#00B7,#00AF,#00A4,#009C
	dw #0092,#0089,#0081,#007C,#0074,#006E,#0066,#0061,#005B,#0056,#0051,#004E
;0F
	dw #48DC,#44C3,#40E8,#3D43,#39D4,#3693,#3383,#30A1,#2DE4,#2B51,#28E3,#2698
	dw #246E,#2261,#2075,#1EA1,#1CE8,#1B4B,#19C3,#1850,#16F3,#15A9,#1472,#134C
	dw #1235,#1132,#1039,#0F50,#0E75,#0DA5,#0CE0,#0C28,#0B78,#0AD3,#0A39,#09A4
	dw #091A,#0899,#081C,#07A8,#0739,#06D2,#0671,#0612,#05BC,#056B,#051C,#04D3
	dw #048D,#044C,#040E,#03D5,#039C,#0369,#0338,#030A,#02DF,#02B4,#028E,#0268
	dw #0248,#0224,#0207,#01E9,#01CE,#01B3,#019B,#0185,#016F,#015A,#0147,#0134
	dw #0124,#0113,#0103,#00F6,#00E8,#00DB,#00CD,#00C2,#00B7,#00AD,#00A2,#009A
	dw #0092,#0089,#0081,#0079,#0074,#006C,#0066,#0061,#005B,#0056,#0051,#004E
	
;INCLUDE "_AMFRQTB.a80"
AMFRQTB ;EQU #EC00
;00
	dw #1AC0,#1940,#17D5,#167E,#153B,#140A,#12EA,#11DA,#10DA,#0FE8,#0F03,#0E2C
	dw #0D60,#0CA0,#0BEA,#0B3F,#0A9E,#0A05,#0975,#08ED,#086D,#07F4,#0782,#0716
	dw #06B0,#0650,#05F5,#05A0,#054F,#0503,#04BB,#0477,#0436,#03FA,#03C1,#038B
	dw #0358,#0328,#02FB,#02D0,#02A7,#0281,#025D,#023B,#021B,#01FD,#01E0,#01C5
	dw #01AC,#0194,#017D,#0168,#0154,#0141,#012F,#011E,#010E,#00FE,#00F0,#00E3
	dw #00D6,#00CA,#00BF,#00B4,#00AA,#00A0,#0097,#008F,#0087,#007F,#0078,#0071
	dw #006B,#0065,#005F,#005A,#0055,#0050,#004C,#0047,#0043,#0040,#003C,#0039
	dw #0036,#0032,#0030,#002D,#002A,#0028,#0026,#0024,#0022,#0020,#001E,#001C
;01
	dw #1A8F,#1911,#17A9,#1655,#1514,#13E5,#12C7,#11BA,#10BB,#0FCB,#0EE8,#0E12
	dw #0D47,#0C89,#0BD4,#0B2B,#0A8A,#09F3,#0964,#08DD,#085D,#07E5,#0774,#0709
	dw #06A4,#0644,#05EA,#0595,#0545,#04F9,#04B2,#046E,#042F,#03F3,#03BA,#0384
	dw #0352,#0322,#02F5,#02CB,#02A3,#027D,#0259,#0237,#0217,#01F9,#01DD,#01C2
	dw #01A9,#0191,#017B,#0165,#0151,#013E,#012C,#011C,#010C,#00FD,#00EE,#00E1
	dw #00D4,#00C9,#00BD,#00B3,#00A9,#009F,#0096,#008E,#0086,#007E,#0077,#0071
	dw #006A,#0064,#005F,#0059,#0054,#0050,#004B,#0047,#0043,#003F,#003C,#0038
	dw #0035,#0032,#002F,#002D,#002A,#0028,#0026,#0023,#0021,#0020,#001E,#001C
;02
	dw #1A5E,#18E3,#177D,#162C,#14ED,#13C1,#12A5,#1199,#109C,#0FAD,#0ECC,#0DF8
	dw #0D2F,#0C71,#0BBF,#0B16,#0A77,#09E0,#0952,#08CC,#084E,#07D7,#0766,#06FC
	dw #0697,#0639,#05DF,#058B,#053B,#04F0,#04A9,#0466,#0427,#03EB,#03B3,#037E
	dw #034C,#031C,#02F0,#02C5,#029E,#0278,#0255,#0233,#0214,#01F6,#01DA,#01BF
	dw #01A6,#018E,#0178,#0163,#014F,#013C,#012A,#011A,#010A,#00FB,#00ED,#00DF
	dw #00D3,#00C7,#00BC,#00B1,#00A7,#009E,#0095,#008D,#0085,#007D,#0076,#0070
	dw #0069,#0064,#005E,#0059,#0054,#004F,#004B,#0046,#0042,#003F,#003B,#0038
	dw #0035,#0032,#002F,#002C,#002A,#0028,#0025,#0023,#0021,#001F,#001E,#001C
;03
	dw #1A2D,#18B5,#1752,#1603,#14C7,#139C,#1283,#1179,#107E,#0F91,#0EB1,#0DDE
	dw #0D17,#0C5B,#0BA9,#0B02,#0A63,#09CE,#0941,#08BC,#083F,#07C8,#0758,#06EF
	dw #068B,#062D,#05D5,#0581,#0532,#04E7,#04A1,#045E,#041F,#03E4,#03AC,#0377
	dw #0346,#0317,#02EA,#02C0,#0299,#0274,#0250,#022F,#0210,#01F2,#01D6,#01BC
	dw #01A3,#018B,#0175,#0160,#014C,#013A,#0128,#0118,#0108,#00F9,#00EB,#00DE
	dw #00D1,#00C6,#00BB,#00B0,#00A6,#009D,#0094,#008C,#0084,#007D,#0076,#006F
	dw #0069,#0063,#005D,#0058,#0053,#004E,#004A,#0046,#0042,#003E,#003B,#0037
	dw #0034,#0031,#002F,#002C,#002A,#0027,#0025,#0023,#0021,#001F,#001D,#001C
;04
	dw #19FD,#1888,#1727,#15DB,#14A1,#1378,#1260,#1158,#105F,#0F74,#0E96,#0DC4
	dw #0CFF,#0C44,#0B94,#0AED,#0A50,#09BC,#0930,#08AC,#0830,#07BA,#074B,#06E2
	dw #067F,#0622,#05CA,#0577,#0528,#04DE,#0498,#0456,#0418,#03DD,#03A5,#0371
	dw #0340,#0311,#02E5,#02BB,#0294,#026F,#024C,#022B,#020C,#01EE,#01D3,#01B9
	dw #01A0,#0188,#0172,#015E,#014A,#0138,#0126,#0116,#0106,#00F7,#00E9,#00DC
	dw #00D0,#00C4,#00B9,#00AF,#00A5,#009C,#0093,#008B,#0083,#007C,#0075,#006E
	dw #0068,#0062,#005D,#0057,#0053,#004E,#004A,#0045,#0041,#003E,#003A,#0037
	dw #0034,#0031,#002E,#002C,#0029,#0027,#0025,#0023,#0021,#001F,#001D,#001C
;05
	dw #19CD,#185A,#16FD,#15B2,#147B,#1354,#123F,#1138,#1041,#0F57,#0E7B,#0DAB
	dw #0CE7,#0C2D,#0B7E,#0AD9,#0A3D,#09AA,#091F,#089C,#0821,#07AC,#073E,#06D5
	dw #0673,#0617,#05BF,#056D,#051F,#04D5,#0490,#044E,#0410,#03D6,#039F,#036B
	dw #033A,#030B,#02E0,#02B6,#028F,#026B,#0248,#0227,#0208,#01EB,#01CF,#01B5
	dw #019D,#0186,#0170,#015B,#0148,#0135,#0124,#0114,#0104,#00F5,#00E8,#00DB
	dw #00CE,#00C3,#00B8,#00AE,#00A4,#009B,#0092,#008A,#0082,#007B,#0074,#006D
	dw #0067,#0061,#005C,#0057,#0052,#004D,#0049,#0045,#0041,#003D,#003A,#0037
	dw #0034,#0031,#002E,#002B,#0029,#0027,#0024,#0022,#0021,#001F,#001D,#001B
;06
	dw #199E,#182E,#16D2,#158A,#1455,#1331,#121D,#1119,#1023,#0F3B,#0E60,#0D92
	dw #0CCF,#0C17,#0B69,#0AC5,#0A2A,#0998,#090E,#088C,#0812,#079E,#0730,#06C9
	dw #0667,#060B,#05B5,#0563,#0515,#04CC,#0487,#0446,#0409,#03CF,#0398,#0364
	dw #0334,#0306,#02DA,#02B1,#028B,#0266,#0244,#0223,#0204,#01E7,#01CC,#01B2
	dw #019A,#0183,#016D,#0159,#0145,#0133,#0122,#0112,#0102,#00F4,#00E6,#00D9
	dw #00CD,#00C1,#00B7,#00AC,#00A3,#009A,#0091,#0089,#0081,#007A,#0073,#006D
	dw #0066,#0061,#005B,#0056,#0051,#004D,#0048,#0044,#0041,#003D,#003A,#0036
	dw #0033,#0030,#002E,#002B,#0029,#0026,#0024,#0022,#0020,#001E,#001D,#001B
;07
	dw #196E,#1801,#16A8,#1563,#142F,#130D,#11FC,#10F9,#1005,#0F1F,#0E46,#0D79
	dw #0CB7,#0C01,#0B54,#0AB1,#0A18,#0987,#08FE,#087D,#0803,#0790,#0723,#06BC
	dw #065C,#0600,#05AA,#0559,#050C,#04C3,#047F,#043E,#0401,#03C8,#0391,#035E
	dw #032E,#0300,#02D5,#02AC,#0286,#0262,#023F,#021F,#0201,#01E4,#01C9,#01AF
	dw #0197,#0180,#016B,#0156,#0143,#0131,#0120,#0110,#0100,#00F2,#00E4,#00D8
	dw #00CB,#00C0,#00B5,#00AB,#00A1,#0098,#0090,#0088,#0080,#0079,#0072,#006C
	dw #0066,#0060,#005B,#0056,#0051,#004C,#0048,#0044,#0040,#003C,#0039,#0036
	dw #0033,#0030,#002D,#002B,#0028,#0026,#0024,#0022,#0020,#001E,#001D,#001B
;08
	dw #1C57,#1AC0,#1940,#17D5,#167E,#153B,#140A,#12EA,#11DA,#10DA,#0FE8,#0F03
	dw #0E2C,#0D60,#0CA0,#0BEA,#0B3F,#0A9E,#0A05,#0975,#08ED,#086D,#07F4,#0782
	dw #0716,#06B0,#0650,#05F5,#05A0,#054F,#0503,#04BB,#0477,#0436,#03FA,#03C1
	dw #038B,#0358,#0328,#02FB,#02D0,#02A7,#0281,#025D,#023B,#021B,#01FD,#01E0
	dw #01C5,#01AC,#0194,#017D,#0168,#0154,#0141,#012F,#011E,#010E,#00FE,#00F0
	dw #00E3,#00D6,#00CA,#00BF,#00B4,#00AA,#00A0,#0097,#008F,#0087,#007F,#0078
	dw #0071,#006B,#0065,#005F,#005A,#0055,#0050,#004C,#0047,#0043,#0040,#003C
	dw #0039,#0036,#0032,#0030,#002D,#002A,#0028,#0026,#0024,#0022,#0020,#001E
;09
	dw #1C23,#1A8F,#1911,#17A9,#1655,#1514,#13E5,#12C7,#11BA,#10BB,#0FCB,#0EE8
	dw #0E12,#0D47,#0C89,#0BD4,#0B2B,#0A8A,#09F3,#0964,#08DD,#085D,#07E5,#0774
	dw #0709,#06A4,#0644,#05EA,#0595,#0545,#04F9,#04B2,#046E,#042F,#03F3,#03BA
	dw #0384,#0352,#0322,#02F5,#02CB,#02A3,#027D,#0259,#0237,#0217,#01F9,#01DD
	dw #01C2,#01A9,#0191,#017B,#0165,#0151,#013E,#012C,#011C,#010C,#00FD,#00EE
	dw #00E1,#00D4,#00C9,#00BD,#00B3,#00A9,#009F,#0096,#008E,#0086,#007E,#0077
	dw #0071,#006A,#0064,#005F,#0059,#0054,#0050,#004B,#0047,#0043,#003F,#003C
	dw #0038,#0035,#0032,#002F,#002D,#002A,#0028,#0026,#0023,#0021,#0020,#001E
;0A
	dw #1BEF,#1A5E,#18E3,#177D,#162C,#14ED,#13C1,#12A5,#1199,#109C,#0FAD,#0ECC
	dw #0DF8,#0D2F,#0C71,#0BBF,#0B16,#0A77,#09E0,#0952,#08CC,#084E,#07D7,#0766
	dw #06FC,#0697,#0639,#05DF,#058B,#053B,#04F0,#04A9,#0466,#0427,#03EB,#03B3
	dw #037E,#034C,#031C,#02F0,#02C5,#029E,#0278,#0255,#0233,#0214,#01F6,#01DA
	dw #01BF,#01A6,#018E,#0178,#0163,#014F,#013C,#012A,#011A,#010A,#00FB,#00ED
	dw #00DF,#00D3,#00C7,#00BC,#00B1,#00A7,#009E,#0095,#008D,#0085,#007D,#0076
	dw #0070,#0069,#0064,#005E,#0059,#0054,#004F,#004B,#0046,#0042,#003F,#003B
	dw #0038,#0035,#0032,#002F,#002C,#002A,#0028,#0025,#0023,#0021,#001F,#001E
;0B
	dw #1BBC,#1A2D,#18B5,#1752,#1603,#14C7,#139C,#1283,#1179,#107E,#0F91,#0EB1
	dw #0DDE,#0D17,#0C5B,#0BA9,#0B02,#0A63,#09CE,#0941,#08BC,#083F,#07C8,#0758
	dw #06EF,#068B,#062D,#05D5,#0581,#0532,#04E7,#04A1,#045E,#041F,#03E4,#03AC
	dw #0377,#0346,#0317,#02EA,#02C0,#0299,#0274,#0250,#022F,#0210,#01F2,#01D6
	dw #01BC,#01A3,#018B,#0175,#0160,#014C,#013A,#0128,#0118,#0108,#00F9,#00EB
	dw #00DE,#00D1,#00C6,#00BB,#00B0,#00A6,#009D,#0094,#008C,#0084,#007D,#0076
	dw #006F,#0069,#0063,#005D,#0058,#0053,#004E,#004A,#0046,#0042,#003E,#003B
	dw #0037,#0034,#0031,#002F,#002C,#002A,#0027,#0025,#0023,#0021,#001F,#001D
;0C
	dw #1B89,#19FD,#1888,#1727,#15DB,#14A1,#1378,#1260,#1158,#105F,#0F74,#0E96
	dw #0DC4,#0CFF,#0C44,#0B94,#0AED,#0A50,#09BC,#0930,#08AC,#0830,#07BA,#074B
	dw #06E2,#067F,#0622,#05CA,#0577,#0528,#04DE,#0498,#0456,#0418,#03DD,#03A5
	dw #0371,#0340,#0311,#02E5,#02BB,#0294,#026F,#024C,#022B,#020C,#01EE,#01D3
	dw #01B9,#01A0,#0188,#0172,#015E,#014A,#0138,#0126,#0116,#0106,#00F7,#00E9
	dw #00DC,#00D0,#00C4,#00B9,#00AF,#00A5,#009C,#0093,#008B,#0083,#007C,#0075
	dw #006E,#0068,#0062,#005D,#0057,#0053,#004E,#004A,#0045,#0041,#003E,#003A
	dw #0037,#0034,#0031,#002E,#002C,#0029,#0027,#0025,#0023,#0021,#001F,#001D
;0D
	dw #1B56,#19CD,#185A,#16FD,#15B2,#147B,#1354,#123F,#1138,#1041,#0F57,#0E7B
	dw #0DAB,#0CE7,#0C2D,#0B7E,#0AD9,#0A3D,#09AA,#091F,#089C,#0821,#07AC,#073E
	dw #06D5,#0673,#0617,#05BF,#056D,#051F,#04D5,#0490,#044E,#0410,#03D6,#039F
	dw #036B,#033A,#030B,#02E0,#02B6,#028F,#026B,#0248,#0227,#0208,#01EB,#01CF
	dw #01B5,#019D,#0186,#0170,#015B,#0148,#0135,#0124,#0114,#0104,#00F5,#00E8
	dw #00DB,#00CE,#00C3,#00B8,#00AE,#00A4,#009B,#0092,#008A,#0082,#007B,#0074
	dw #006D,#0067,#0061,#005C,#0057,#0052,#004D,#0049,#0045,#0041,#003D,#003A
	dw #0037,#0034,#0031,#002E,#002B,#0029,#0027,#0024,#0022,#0021,#001F,#001D
;0E
	dw #1B24,#199E,#182E,#16D2,#158A,#1455,#1331,#121D,#1119,#1023,#0F3B,#0E60
	dw #0D92,#0CCF,#0C17,#0B69,#0AC5,#0A2A,#0998,#090E,#088C,#0812,#079E,#0730
	dw #06C9,#0667,#060B,#05B5,#0563,#0515,#04CC,#0487,#0446,#0409,#03CF,#0398
	dw #0364,#0334,#0306,#02DA,#02B1,#028B,#0266,#0244,#0223,#0204,#01E7,#01CC
	dw #01B2,#019A,#0183,#016D,#0159,#0145,#0133,#0122,#0112,#0102,#00F4,#00E6
	dw #00D9,#00CD,#00C1,#00B7,#00AC,#00A3,#009A,#0091,#0089,#0081,#007A,#0073
	dw #006D,#0066,#0061,#005B,#0056,#0051,#004D,#0048,#0044,#0041,#003D,#003A
	dw #0036,#0033,#0030,#002E,#002B,#0029,#0026,#0024,#0022,#0020,#001E,#001D
;0F
	dw #1AF2,#196E,#1801,#16A8,#1563,#142F,#130D,#11FC,#10F9,#1005,#0F1F,#0E46
	dw #0D79,#0CB7,#0C01,#0B54,#0AB1,#0A18,#0987,#08FE,#087D,#0803,#0790,#0723
	dw #06BC,#065C,#0600,#05AA,#0559,#050C,#04C3,#047F,#043E,#0401,#03C8,#0391
	dw #035E,#032E,#0300,#02D5,#02AC,#0286,#0262,#023F,#021F,#0201,#01E4,#01C9
	dw #01AF,#0197,#0180,#016B,#0156,#0143,#0131,#0120,#0110,#0100,#00F2,#00E4
	dw #00D8,#00CB,#00C0,#00B5,#00AB,#00A1,#0098,#0090,#0088,#0080,#0079,#0072
	dw #006C,#0066,#0060,#005B,#0056,#0051,#004C,#0048,#0044,#0040,#003C,#0039
	dw #0036,#0033,#0030,#002D,#002B,#0028,#0026,#0024,#0022,#0020,#001E,#001D

;INCLUDE "_AMTOGS.a80" ;patched
;AMTOGS  ;EQU #F800
	dw #0000,#0003,#0005,#0008,#000B,#000E,#0010,#0013
	dw #0016,#0018,#001B,#001E,#0020,#0023,#0026,#0029
	dw #002B,#002E,#0031,#0033,#0036,#0039,#003B,#003E
	dw #0041,#0044,#0046,#0049,#004C,#004E,#0051,#0054
	dw #0057,#0059,#005C,#005F,#0061,#0064,#0067,#0069
	dw #006C,#006F,#0072,#0074,#0077,#007A,#007C,#007F
	dw #0082,#0084,#0087,#008A,#008D,#008F,#0092,#0095
	dw #0097,#009A,#009D,#00A0,#00A2,#00A5,#00A8,#00AA
	dw #00AD,#00B0,#00B2,#00B5,#00B8,#00BB,#00BD,#00C0
	dw #00C3,#00C5,#00C8,#00CB,#00CD,#00D0,#00D3,#00D6
	dw #00D8,#00DB,#00DE,#00E0,#00E3,#00E6,#00E9,#00EB
	dw #00EE,#00F1,#00F3,#00F6,#00F9,#00FB,#00FE,#0101
	dw #0104,#0106,#0109,#010C,#010E,#0111,#0114,#0117
	dw #0119,#011C,#011F,#0121,#0124,#0127,#0129,#012C
	dw #012F,#0132,#0134,#0137,#013A,#013C,#013F,#0142
	dw #0144,#0147,#014A,#014D,#014F,#0152,#0155,#0157
	dw #015A,#015D,#0160,#0162,#0165,#0168,#016A,#016D
	dw #0170,#0172,#0175,#0178,#017B,#017D,#0180,#0183
	dw #0185,#0188,#018B,#018D,#0190,#0193,#0196,#0198
	dw #019B,#019E,#01A0,#01A3,#01A6,#01A9,#01AB,#01AE
	dw #01B1,#01B3,#01B6,#01B9,#01BB,#01BE,#01C1,#01C4
	dw #01C6,#01C9,#01CC,#01CE,#01D1,#01D4,#01D6,#01D9
	dw #01DC,#01DF,#01E1,#01E4,#01E7,#01E9,#01EC,#01EF
	dw #01F2,#01F4,#01F7,#01FA,#01FC,#01FF,#0202,#0204
	dw #0207,#020A,#020D,#020F,#0212,#0215,#0217,#021A
	dw #021D,#021F,#0222,#0225,#0228,#022A,#022D,#0230
	dw #0232,#0235,#0238,#023B,#023D,#0240,#0243,#0245
	dw #0248,#024B,#024D,#0250,#0253,#0256,#0258,#025B
	dw #025E,#0260,#0263,#0266,#0269,#026B,#026E,#0271
	dw #0273,#0276,#0279,#027B,#027E,#0281,#0284,#0286
	dw #0289,#028C,#028E,#0291,#0294,#0296,#0299,#029C
	dw #029F,#02A1,#02A4,#02A7,#02A9,#02AC,#02AF,#02B2
	dw #02B4,#02B7,#02BA,#02BC,#02BF,#02C2,#02C4,#02C7
	dw #02CA,#02CD,#02CF,#02D2,#02D5,#02D7,#02DA,#02DD
	dw #02DF,#02E2,#02E5,#02E8,#02EA,#02ED,#02F0,#02F2
	dw #02F5,#02F8,#02FB,#02FD,#0300,#0303,#0305,#0308
	dw #030B,#030D,#0310,#0313,#0316,#0318,#031B,#031E
	dw #0320,#0323,#0326,#0328,#032B,#032E,#0331,#0333
	dw #0336,#0339,#033B,#033E,#0341,#0344,#0346,#0349
	dw #034C,#034E,#0351,#0354,#0356,#0359,#035C,#035F
	dw #0361,#0364,#0367,#0369,#036C,#036F,#0371,#0374
	dw #0377,#037A,#037C,#037F,#0382,#0384,#0387,#038A
	dw #038D,#038F,#0392,#0395,#0397,#039A,#039D,#039F
	dw #03A2,#03A5,#03A8,#03AA,#03AD,#03B0,#03B2,#03B5
	dw #03B8,#03BB,#03BD,#03C0,#03C3,#03C5,#03C8,#03CB
	dw #03CD,#03D0,#03D3,#03D6,#03D8,#03DB,#03DE,#03E0
	dw #03E3,#03E6,#03E8,#03EB,#03EE,#03F1,#03F3,#03F6
	dw #03F9,#03FB,#03FE,#0401,#0404,#0406,#0409,#040C
	dw #040E,#0411,#0414,#0416,#0419,#041C,#041F,#0421
	dw #0424,#0427,#0429,#042C,#042F,#0431,#0434,#0437
	dw #043A,#043C,#043F,#0442,#0444,#0447,#044A,#044D
	dw #044F,#0452,#0455,#0457,#045A,#045D,#045F,#0462
	dw #0465,#0468,#046A,#046D,#0470,#0472,#0475,#0478
	dw #047A,#047D,#0480,#0483,#0485,#0488,#048B,#048D
	dw #0490,#0493,#0496,#0498,#049B,#049E,#04A0,#04A3
	dw #04A6,#04A8,#04AB,#04AE,#04B1,#04B3,#04B6,#04B9
	dw #04BB,#04BE,#04C1,#04C3,#04C6,#04C9,#04CC,#04CE
	dw #04D1,#04D4,#04D6,#04D9,#04DC,#04DF,#04E1,#04E4
	dw #04E7,#04E9,#04EC,#04EF,#04F1,#04F4,#04F7,#04FA
	dw #04FC,#04FF,#0502,#0504,#0507,#050A,#050D,#050F
	dw #0512,#0515,#0517,#051A,#051D,#051F,#0522,#0525
	dw #0528,#052A,#052D,#0530,#0532,#0535,#0538,#053A
	dw #053D,#0540,#0543,#0545,#0548,#054B,#054D,#0550
	dw #0553,#0556,#0558,#055B,#055E,#0560,#0563,#0566
	dw #0568,#056B,#056E,#0571,#0573,#0576,#0579,#057B
	dw #057E,#0581,#0583,#0586,#0589,#058C,#058E,#0591
	dw #0594,#0596,#0599,#059C,#059F,#05A1,#05A4,#05A7
	dw #05A9,#05AC,#05AF,#05B1,#05B4,#05B7,#05BA,#05BC
	dw #05BF,#05C2,#05C4,#05C7,#05CA,#05CC,#05CF,#05D2
	dw #05D5,#05D7,#05DA,#05DD,#05DF,#05E2,#05E5,#05E8
	dw #05EA,#05ED,#05F0,#05F2,#05F5,#05F8,#05FA,#05FD
	dw #0600,#0603,#0605,#0608,#060B,#060D,#0610,#0613
	dw #0615,#0618,#061B,#061E,#0620,#0623,#0626,#0628
	dw #062B,#062E,#0631,#0633,#0636,#0639,#063B,#063E
	dw #0641,#0643,#0646,#0649,#064C,#064E,#0651,#0654
	dw #0656,#0659,#065C,#065F,#0661,#0664,#0667,#0669
	dw #066C,#066F,#0671,#0674,#0677,#067A,#067C,#067F
	dw #0682,#0684,#0687,#068A,#068C,#068F,#0692,#0695
	dw #0697,#069A,#069D,#069F,#06A2,#06A5,#06A8,#06AA
	dw #06AD,#06B0,#06B2,#06B5,#06B8,#06BA,#06BD,#06C0
	dw #06C3,#06C5,#06C8,#06CB,#06CD,#06D0,#06D3,#06D5
	dw #06D8,#06DB,#06DE,#06E0,#06E3,#06E6,#06E8,#06EB
	dw #06EE,#06F1,#06F3,#06F6,#06F9,#06FB,#06FE,#0701
	dw #0703,#0706,#0709,#070C,#070E,#0711,#0714,#0716
	dw #0719,#071C,#071E,#0721,#0724,#0727,#0729,#072C
	dw #072F,#0731,#0734,#0737,#073A,#073C,#073F,#0742
	dw #0744,#0747,#074A,#074C,#074F,#0752,#0755,#0757
	dw #075A,#075D,#075F,#0762,#0765,#0767,#076A,#076D
	dw #0770,#0772,#0775,#0778,#077A,#077D,#0780,#0783
	dw #0785,#0788,#078B,#078D,#0790,#0793,#0795,#0798
	dw #079B,#079E,#07A0,#07A3,#07A6,#07A8,#07AB,#07AE
	dw #07B1,#07B3,#07B6,#07B9,#07BB,#07BE,#07C1,#07C3
	dw #07C6,#07C9,#07CC,#07CE,#07D1,#07D4,#07D6,#07D9
	dw #07DC,#07DE,#07E1,#07E4,#07E7,#07E9,#07EC,#07EF
	dw #07F1,#07F4,#07F7,#07FA,#07FC,#07FF,#0802,#0804
	dw #0807,#080A,#080C,#080F,#0812,#0815,#0817,#081A
	dw #081D,#081F,#0822,#0825,#0827,#082A,#082D,#0830
	dw #0832,#0835,#0838,#083A,#083D,#0840,#0843,#0845
	dw #0848,#084B,#084D,#0850,#0853,#0855,#0858,#085B
	dw #085E,#0860,#0863,#0866,#0868,#086B,#086E,#0870
	dw #0873,#0876,#0879,#087B,#087E,#0881,#0883,#0886
	dw #0889,#088C,#088E,#0891,#0894,#0896,#0899,#089C
	dw #089E,#08A1,#08A4,#08A7,#08A9,#08AC,#08AF,#08B1
	dw #08B4,#08B7,#08B9,#08BC,#08BF,#08C2,#08C4,#08C7
	dw #08CA,#08CC,#08CF,#08D2,#08D5,#08D7,#08DA,#08DD
	dw #08DF,#08E2,#08E5,#08E7,#08EA,#08ED,#08F0,#08F2
	dw #08F5,#08F8,#08FA,#08FD,#0900,#0903,#0905,#0908
	dw #090B,#090D,#0910,#0913,#0915,#0918,#091B,#091E
	dw #0920,#0923,#0926,#0928,#092B,#092E,#0930,#0933
	dw #0936,#0939,#093B,#093E,#0941,#0943,#0946,#0949
	dw #094C,#094E,#0951,#0954,#0956,#0959,#095C,#095E
	dw #0961,#0964,#0967,#0969,#096C,#096F,#0971,#0974
	dw #0977,#0979,#097C,#097F,#0982,#0984,#0987,#098A
	dw #098C,#098F,#0992,#0995,#0997,#099A,#099D,#099F
	dw #09A2,#09A5,#09A7,#09AA,#09AD,#09B0,#09B2,#09B5
	dw #09B8,#09BA,#09BD,#09C0,#09C2,#09C5,#09C8,#09CB
	dw #09CD,#09D0,#09D3,#09D5,#09D8,#09DB,#09DE,#09E0
	dw #09E3,#09E6,#09E8,#09EB,#09EE,#09F0,#09F3,#09F6
	dw #09F9,#09FB,#09FE,#0A01,#0A03,#0A06,#0A09,#0A0B
	dw #0A0E,#0A11,#0A14,#0A16,#0A19,#0A1C,#0A1E,#0A21
	dw #0A24,#0A27,#0A29,#0A2C,#0A2F,#0A31,#0A34,#0A37
	dw #0A39,#0A3C,#0A3F,#0A42,#0A44,#0A47,#0A4A,#0A4C
	dw #0A4F,#0A52,#0A55,#0A57,#0A5A,#0A5D,#0A5F,#0A62
	dw #0A65,#0A67,#0A6A,#0A6D,#0A70,#0A72,#0A75,#0A78
	dw #0A7A,#0A7D,#0A80,#0A82,#0A85,#0A88,#0A8B,#0A8D
	dw #0A90,#0A93,#0A95,#0A98,#0A9B,#0A9E,#0AA0,#0AA3
	dw #0AA6,#0AA8,#0AAB,#0AAE,#0AB0,#0AB3,#0AB6,#0AB9
	dw #0ABB,#0ABE,#0AC1,#0AC3,#0AC6,#0AC9,#0ACB,#0ACE   
